<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Golang &middot; Fabrice Aneche</title>

    <meta name="description" content="">

    <meta name="generator" content="Hugo 0.33" />
    <meta name="twitter:card" content="summary">
    
    <meta name="twitter:title" content="Golang &middot; Fabrice Aneche">
    <meta name="twitter:description" content="">

    <meta property="og:type" content="article">
    <meta property="og:title" content="Golang &middot; Fabrice Aneche">
    <meta property="og:description" content="">

    <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700|Oxygen:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/pure-min.css">
    <!--[if lte IE 8]>
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-old-ie-min.css">
    <![endif]-->
    <!--[if gt IE 8]><!-->
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-min.css">
    <!--<![endif]-->

    <link rel="stylesheet" href="https://blog.nobugware.com/css/all.min.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">

    <link rel="alternate" type="application/rss+xml" title="Fabrice Aneche" href="https://blog.nobugware.com/index.xml" />
    <link href="https://blog.nobugware.com/css/prism.css" rel="stylesheet" />
</head>
<body>


<div id="layout" class="pure-g">
    <div class="sidebar pure-u-1 pure-u-md-1-4">
    <div class="header">
        <hgroup>
            <h1 class="brand-title"><a href="https://blog.nobugware.com">Fabrice Aneche</a></h1>
            <h2 class="brand-tagline"></h2>
        </hgroup>

        <nav class="nav">
            <ul class="nav-list">
                
                <li class="nav-item">
                    <a class="pure-button" href="http://www.nobugware.com"><i class="fa fa-building-o"></i> Hiring</a>
                </li>
                
                
                <li class="nav-item">
                    <a class="pure-button" href="https://twitter.com/akhenakh"><i class="fa fa-twitter"></i> Twitter</a>
                </li>
                
                
                <li class="nav-item">
                    <a class="pure-button" href="https://github.com/akhenakh "><i class="fa fa-github-alt"></i> github</a>
                </li>
                
                <li class="nav-item">
                    <a class="pure-button" href="https://blog.nobugware.com/index.xml"><i class="fa fa-rss"></i> rss</a>
                </li>
            </ul>
        </nav>
    </div>
</div>


    <div class="content pure-u-1 pure-u-md-3-4">
        <div>
            
            <div class="posts">
                
                <h1 class="content-subhead">28 Sep 2016, 13:15</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.nobugware.com/post/2016/grpc_context_go_1.7/" class="post-title">gRPC wrong types context and Go 1.7</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                <a class="post-category post-category-Golang" href="https://blog.nobugware.com/categories/golang">Golang</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p>If you are following Go development you probably know that:<br />
Go 1.7 moves the <code>golang.org/x/net/context</code> package into the standard library as <a href="https://tip.golang.org/pkg/context/">context</a>, Yeah !<br />
Unfortunately it won&rsquo;t work for everything, I&rsquo;ve spent some time understanding this one.</p>

<p>For example if you are using gRPC you can hit this problem, here is an interface generated by gRPC:</p>

<pre><code class="language-Go">type APRSServer interface {
    GetPastMessages(context.Context, *Point) (*ARPSMessages, error)
}
</code></pre>

<p>But when compiling:</p>

<pre><code class="language-Go">/main.go:153: cannot use &amp;s (type *Server) as type protorpc.APRSServer in argument to protorpc.RegisterAPRSServer:                                                                           
        *Server does not implement protorpc.APRSServer (wrong type for GetPastMessages method)                                                                                                
                have GetPastMessages(&quot;context&quot;.Context, *protorpc.Point) (*protorpc.ARPSMessages, error)                                                                                      
                want GetPastMessages(&quot;golang.org/x/net/context&quot;.Context, *protorpc.Point) (*protorpc.ARPSMessages, error)   
</code></pre>

<p>The compiler is complaining about wrong types for the context argument.<br />
Problem is gRPC generated code is importing <code>context</code> as <code>golang.org/x/net/context</code>, that&rsquo;s the only way it remains compatible between Go 1.6 &amp; Go 1.7.</p>

<p>So a quick solution is to import context in your own code to use the old path:</p>

<pre><code class="language-Go">// we have to use the old context path here for gRPC compat see https://github.com/grpc/grpc-go/issues/711
context &quot;golang.org/x/net/context&quot;
</code></pre>

<p>Also note that go tool fix is now capable of <a href="https://github.com/golang/go/issues/17040">fixing the import path</a> with <code>-force context</code>.</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">22 Sep 2016, 15:39</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.nobugware.com/post/2016/go_mobile_ios_real_usage/" class="post-title">Using Go mobile on iOS for real</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                <a class="post-category post-category-Golang" href="https://blog.nobugware.com/categories/golang">Golang</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p><a href="https://github.com/golang/go/wiki/Mobile">Go Mobile</a> can generate native framework for iOS and Android using Go code, I was curious what could be achieved with it.<br />
Most tutorials are Hello world and I wanted to test it with real code.<br />
You can use it to generate a full app only using Go code, but I&rsquo;m only interested by the bindings part (SDK applications), using a native ObjC/Swift app calling Go code.</p>

<p>I&rsquo;m using some existing Go code <a href="https://github.com/akhenakh/regionagogo">regionagogo</a>, (a geofence database), moderately complex since it uses <a href="https://github.com/boltdb/bolt">BoltDB</a> and <a href="https://github.com/golang/geo">Google S2 library</a>.</p>

<p><a href="https://github.com/golang/go/wiki/Mobile">Go Mobile</a> is limited <a href="https://godoc.org/golang.org/x/mobile/cmd/gobind#hdr-Type_restrictions">to a subset of types</a> you can use, main reason is to be correctly transcribed to Java and ObjC.</p>

<p>So the first thing to do is to write some Go wrapper like you would do in ObjC to call some C++ code but first:</p>

<p>Functions must return either no results, one result, or two results where the type of the second is the built-in <code>error</code> type.<br />
So far no major complication, but also note that you <strong>can&rsquo;t return slices</strong>, that could be a major pain, there are some workaround solutions like <a href="https://github.com/scisci/go-mobile-collection">go-mobile-collection</a> that can generate an API to operate on slice.<br />
You also have to respect some naming for your constructor like <code>New...()</code>.</p>

<p>At the end your wrapper won&rsquo;t look very Goish but it&rsquo;s what it takes for it to be translated.</p>

<p>Knowing those constraints you can write a simple wrapper like this:</p>

<pre><code class="language-go">package mobile

type GeoDB struct {
	db regionagogo.GeoFenceDB
}

func NewGeoDB() *GeoDB {
	g := &amp;GeoDB{}
	return g
}

func (g *GeoDB) OpenDB(path string) error {
	db, err := rbolt.NewGeoFenceBoltDB(path)
	if err != nil {
		return err
	}
	g.db = db
	return nil
}

...
</code></pre>

<p>Then use the gomobile command:</p>

<pre><code>gomobile bind -target=ios github.com/akhenakh/regionagogo/mobile
</code></pre>

<p>It generates a native iOS Mobile.Framework, drop it into your XCode project and start using it.</p>

<ul>
<li><code>GeoDB</code> translates to <code>GoMobileNewGeoDB()</code> and returns a <code>GoMobileGeoDB*</code> in ObjC domain.</li>
<li><code>OpenDB(path string) error</code> to <code>- (BOOL)openDB:(NSString*)path error:(NSError**)error</code>.</li>
</ul>

<p>A simple example would be:</p>

<pre><code class="language-C">GoMobileGeoDB *db = GoMobileNewGeoDB();
NSString *resourcePath = [[NSBundle mainBundle] pathForResource:@&quot;region&quot; ofType:@&quot;db&quot;];
        
NSError *error;
[db openDB:resourcePath error:&amp;error];
if (error != nil) {
    NSLog(@&quot;error opening db %@&quot;, [error localizedDescription]);
    return;
}
</code></pre>

<p>It&rsquo;s performing very well, on my iPhone 6, around 4,000 queries per second to test a position in a small fence, to 60,000 queries in a hit miss (calling Go overhead is not that big),  while using a ridiculously small amount of memory.</p>

<p>I&rsquo;ve made a demo iOS app where you can hit the map and it tells you in which fence you are.</p>

<p><img src="https://blog.nobugware.com/img/shotmap.jpg" alt="app" title="geofence app" /><br />
Remember this is running locally on your phone without any network access (but the map), the geo computation and the Polygons are returned by Go code.</p>

<p>Until now I had to maintain libraries in both languages, Go mobile is a nice alternative!</p>

<p>Sources for the wrapper are available in <a href="https://github.com/akhenakh/regionagogo/tree/gomobile/mobile">regionagogo gomobile branch</a>, and here is the <a href="https://github.com/akhenakh/testgomobileios">iOS demo app</a>.</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">20 Sep 2016, 17:40</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.nobugware.com/post/2016/grpc_envoy_nghttp2_load_balancing/" class="post-title">gRPC Envoy Nghttp2 and Load Balancing</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                <a class="post-category post-category-Golang" href="https://blog.nobugware.com/categories/golang">Golang</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p>I&rsquo;ve been using <a href="http://www.grpc.io/">gRPC</a> at work and in several personal projects for months and happy with it, but when it comes to load balancing gRPC does not come with batteries included.</p>

<p>For a long time the only document was the <a href="https://github.com/grpc/grpc/commit/b31ec1e81c93d4c9bf30a4600096a6a6f5b90935">Load Balancing draft in the gRPC repo</a>, the clients should implement a Picker interface to know about the servers, so the pooling and controling the load were handled by the clients.<br />
HTTP/2 was new and most of the reverse proxies implementations were not capable of load balancing gRPC HTTP2 frames, the only solution was to use a TCP load balancer, generating errors, improper  and weird behaviours for the clients.</p>

<p>At least two projects are now supporting gRPC load balancing easily.</p>

<ul>
<li>The recently announced <a href="https://lyft.github.io/envoy/">Envoy</a> from Lyft</li>
<li>And nghttpx from <a href="https://www.nghttp2.org/">nghttp2</a></li>
</ul>

<p>Here are some notes to simply load balance two <a href="https://github.com/grpc/grpc-go/tree/master/examples/helloworld">gRPC Helloworld server!</a> running on ports 50050 &amp; 50051.</p>

<ul>
<li><p>For nghttp2, a simple configuration file will do</p>

<pre><code>frontend=*,8000;no-tls
backend=localhost,50050;;no-tls;proto=h2;fall=2;rise=2
backend=localhost,50051;;no-tls;proto=h2;fall=2;rise=2
workers=8
</code></pre></li>

<li><p>For envoy, here is the cluster part</p>

<pre><code class="language-js">&quot;clusters&quot;: [
  {
    &quot;name&quot;: &quot;local_service&quot;,
    &quot;connect_timeout_ms&quot;: 250,
    &quot;type&quot;: &quot;static&quot;,
    &quot;lb_type&quot;: &quot;least_request&quot;,
    &quot;features&quot;: &quot;http2&quot;,
    &quot;hosts&quot;: [
      {
        &quot;url&quot;: &quot;tcp://127.0.0.1:50050&quot;
      },
      {
        &quot;url&quot;: &quot;tcp://127.0.0.1:50051&quot;
      }
    ]
  }
]
</code></pre></li>
</ul>

<p>You can then tweak the greeter_client to loop for requests, so you can simulate a client doing multiple requests while killing/restarting your servers.</p>

<pre><code class="language-go">for {  
    r, err := c.SayHello(context.Background(), &amp;pb.HelloRequest{Name: name}) 
    if err != nil { 
        log.Printf(&quot;could not greet: %v&quot;, err)
    }
    log.Printf(&quot;Greeting: %s&quot;, r.Message)
}
</code></pre>

<p>And modify the greeter_server to show on which port/server you get your response:</p>

<pre><code class="language-go">// SayHello implements helloworld.GreeterServer
func (s *server) SayHello(ctx context.Context, in *pb.HelloRequest) (*pb.HelloReply, error) {
    return &amp;pb.HelloReply{Message: &quot;Hello &quot; + in.Name + port}, nil 
}
</code></pre>

<p>Those tests aren&rsquo;t enabling any TLS so use <code>grpc.WithInsecure()</code>.</p>

<p>Note that Envoy is also capable of <a href="https://lyft.github.io/envoy/docs/configuration/http_filters/grpc_http1_bridge_filter.html">bridging your HTTP/1.1 queries to gRPC</a>, which is a killer feature (I haven&rsquo;t tested it yet) , you would normally do it by code with <a href="https://github.com/grpc-ecosystem/grpc-gateway">gRPC-gateway</a>.</p>

<p>Envoy is really new and I&rsquo;m still digging into but already proves itself to be a <strong>complete load balancing proxy solution</strong>  with or without gRPC in your stack.</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">03 Jul 2016, 08:15</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.nobugware.com/post/2016/gometalinter_jetbrains_idea/" class="post-title">Enabling Gometalinter with Jetbrains Editors</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                <a class="post-category post-category-Golang" href="https://blog.nobugware.com/categories/golang">Golang</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p>I&rsquo;ve been using Jetbrains editor (the free <a href="https://www.jetbrains.com/idea/download/">Idea community edition</a>) or Pycharm with the <a href="https://github.com/go-lang-plugin-org/go-lang-idea-plugin">Go plugins</a> and very happy with this setup, the editor is providing some realtime linting but I was missing <code>gometalinter</code>.</p>

<p>First install <code>gometalinter</code></p>

<pre><code>go get -u github.com/alecthomas/gometalinter
gometalinter --install --update
</code></pre>

<p>To add support inside Jetbrains editors use the External tools feature.<br />
In Preferences &gt; Tools &gt; External Tools, add a configuration.</p>

<p><img src="https://blog.nobugware.com/img/gometalinter.jpg" alt="gometalinter setup for jetbrains" title="gometalinter setup for jetbrains" /></p>

<p>Set the Program path to your <code>$GOPATH/bin/gometalinter</code><br />
Parameters to <code>--deadline=15s --vendor $FileDir$</code><br />
Working directory to <code>$ProjectFileDir$</code></p>

<p>For the linters messages to be clickable and jump to code add an Output filter with Regular expression to match output <code>$FILE_PATH$:$LINE$</code></p>

<p><img src="https://blog.nobugware.com/img/gometalinter2.jpg" alt="gometalinter setup filter for jetbrains" title="gometalinter setup filter for jetbrains" /></p>

                    </div>
                </section>
                
                <h1 class="content-subhead">08 Mar 2016, 11:23</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.nobugware.com/post/2016/geo_db_s2_region_polygon_optmization/" class="post-title">A geo database for polygons, optimization</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                <a class="post-category post-category-Geo" href="https://blog.nobugware.com/categories/geo">Geo</a><a class="post-category post-category-Golang" href="https://blog.nobugware.com/categories/golang">Golang</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p>If you read this blog, you know I&rsquo;ve recently released a project called <a href="https://github.com/akhenakh/regionagogo">regionagogo</a>, a geo shape lookup database, described in <a href="https://blog.nobugware.com/post/2016/geo_db_s2_region_polygon/">this blogpost</a>.</p>

<p>It uses the current <a href="https://godoc.org/github.com/golang/geo/s2">Go S2 implementation</a>, which is not yet as complete as the C++ implementation, for example the region coverer of a shape does not really compute cell around the shape but around the bounding box instead.</p>

<p>Using the shape of the polygon makes the covered cells more precise and smaller, resulting at the end to less <a href="https://en.wikipedia.org/wiki/Point_in_polygon">PIP</a> tests which are costly.</p>

<p><img src="https://blog.nobugware.com/img/s2cpp.jpg" alt="S2 over a shape" title="S2 cover" /><br />
The same coverage with Go S2 would have returned 8 big cells of the same size, covering over regions.</p>

<p>I&rsquo;ve created <a href="https://github.com/akhenakh/regionagogogen">regionagogogen</a> a quick and dirty command line program for OSX that takes a GeoJSON file containing your regions and then compute the database using the S2 C++ implementation, it&rsquo;s for OSX only cause I&rsquo;m using ObjC as a bridge to C++ which I don&rsquo;t know enough.</p>

<p>Also note that <a href="https://github.com/akhenakh/regionagogogen">regionagogogen</a> includes an S2 port that works on iOS/OSX and some ObjC geo helper classes.</p>

<p>The <a href="https://hub.docker.com/r/akhenakh/regionagogo/">Docker image fore regionagogo</a> is also using the optimized database.</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">18 Feb 2016, 17:16</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.nobugware.com/post/2016/geo_db_s2_region_polygon/" class="post-title">A geo database for polygons, foundations</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                <a class="post-category post-category-Geo" href="https://blog.nobugware.com/categories/geo">Geo</a><a class="post-category post-category-Golang" href="https://blog.nobugware.com/categories/golang">Golang</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<p>On a previous post, <a href="http://blog.nobugware.com/post/2016/geo_db_s2_geohash_database/">I&rsquo;ve described how to use the S2 geo library</a> to create a fast geo database, but it was to store locations (points) and only to perform range queries, a complete geo database would have regions/polygons queries.</p>

<h2 id="looking-for-a-solution">Looking for a solution</h2>

<p>I had this need: querying for the countries or subregions of hundreds of coordinates per second, without relying on an external service.</p>

<p>One solution, using my previous technique, could have been to store every cities in the world and then perform a proximity query around my point to get the closest cities, but it works only in populated area and it&rsquo;s only an approximation.</p>

<p>I looked into others solutions, there is some smart ideas <a href="https://github.com/hlaw/codegrid-js">using UTF-grid</a>, but it&rsquo;s a client side solution and also an approximation tied to the resolution of the computed grid.</p>

<h2 id="s2-to-the-rescue">S2 to the rescue</h2>

<p>S2 cells have some nice properties, they are segments on the <a href="https://en.wikipedia.org/wiki/Hilbert_curve">Hilbert curve</a>, expressed as range of <code>uint64</code>, so I had the intuition the problem to perform fast region lookup could be simplified as find all mathematical segments containing my location expressed as an <code>uint64</code>.</p>

<p><img src="https://blog.nobugware.com/img/s2belgium.jpg" alt="S2 over a country" title="S2 covering belgium" /></p>

<p>Using a <a href="https://en.wikipedia.org/wiki/Segment_tree">Segment Tree</a> datastructure, I first tried an in memory engine, using <a href="http://www.naturalearthdata.com/">Natural Earth Data</a>, loading the whole world countries shapes into S2 loops (a <code>Loop</code> represents a simple spherical polygon), transforming then into cells using the region coverer, it returns cells of different levels, add them to the segment tree.</p>

<p><img src="https://blog.nobugware.com/img/stree.gif" alt="Segment Tree" title="Segment tree picture fron Wikipedia" /></p>

<p>To query, simply tranform the location into an S2 <code>Cell</code> (level 30) and perform a stubbing query that intersects the segments, every segments crossed are cells that covered a part of a <code>Loop</code>.<br />
It will reduce the problem to test a few <code>Loop</code> vs thousands of them, finally perform <code>ContainsPoint</code> against the found loops cause the point could be inside the <code>Cell</code> but not inside the <code>Loop</code> itself.</p>

<p>Et voilà! It works!</p>

<p>The segment tree structure itself is very low on memory, the loops/polygons data could be stored on disk and loaded on requests, I&rsquo;ve tested a second implementation using LevelDB using this technique.</p>

<p>If you have a very large tree (for example cities limits for the whole world), you can even put the segment tree on a KV storage, using this paper <a href="http://students.ceid.upatras.gr/~patlakas/papers/ICDE13_conf_full_420.pdf">Interval Indexing and Querying on Key-Value Cloud Stores</a>.</p>

<h2 id="region-a-gogo">Region a gogo</h2>

<p>As a demonstration here is a working microservice called <a href="https://github.com/akhenakh/regionagogo">regionagogo</a>, simply returning the country &amp; state for a given location.<br />
It loads geo data for the whole world and answers to HTTP queries using small amout of memory.</p>

<pre><code>GET /country?lat=19.542915&amp;lng=-155.665857

{
    &quot;code&quot;: &quot;US&quot;,
    &quot;name&quot;: &quot;Hawaii&quot;
}
</code></pre>

<p>Here is a <a href="https://hub.docker.com/r/akhenakh/regionagogo/">Docker image</a> so you can deploy it on your stack.</p>

<p>Note that it performs really well but can be improved a lot, for example the actual Go S2 implementation is still using Rect boxing around loops, that&rsquo;s why <a href="https://github.com/akhenakh/regionagogo">regionagogo</a> is using a data file so it can be generated from the C++ version.</p>

<h2 id="future">Future</h2>

<p>This technique seems to work well for stubbing queries, region queries, geofencing &hellip;<br />
It can be a solid foundation to create a flexible and simple geo database.</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">26 Jan 2016, 14:01</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.nobugware.com/post/2016/geo_db_s2_geohash_database/" class="post-title">A fast geo database with Google S2 take #2</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                <a class="post-category post-category-Geo" href="https://blog.nobugware.com/categories/geo">Geo</a><a class="post-category post-category-Golang" href="https://blog.nobugware.com/categories/golang">Golang</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<p>Six months ago, I wrote on this blog about <a href="https://blog.nobugware.com/post/2015/leveldb_geohash_golang/">Geohashes and LevelDB with Go</a>, to create a fast geo database.<br />
This post is very similar as it works the same way but replacing GeoHashes with <a href="http://blog.christianperone.com/2015/08/googles-s2-geometry-on-the-sphere-cells-and-hilbert-curve/">Google S2</a> library for better performances.</p>

<p>There is an <a href="https://github.com/golang/geo">S2 Golang implementation maintened by Google</a> not as complete as the C++ one but close.</p>

<p>For the storage this post will stay agnostic to avoid any troll, but it applies to any Key Value storages: LevelDB/RocksDB, LMDB, Redis&hellip;<br />
I personnaly use <a href="https://github.com/boltdb/bolt">BoltDB</a> and <a href="https://github.com/steveyen/gtreap">gtreap</a> for my experimentations.</p>

<p>This post will focus on Go usage but can be applied to any languages.</p>

<p>Or skip to the images below for visual explanations.</p>

<h2 id="why-not-geohash">Why not Geohash?</h2>

<p>Geohash is a great solution to perform geo coordinates queries but the way it works can sometimes be an issue with your data.</p>

<ul>
<li><p>Remember geohashes are cells of 12 different widths from 5000km to 3.7cm, when you perform a lookup around a position, if your position is close to a cell&rsquo;s edge you could miss some points from the adjacent cell, that&rsquo;s why you have to query for the 8 neightbour cells, it means 9 range queries into your DB to find all the closest points from your location.</p></li>

<li><p>If your lookup does not fit in level <code>4</code> 39km by 19.5km, the next level is 156km by 156km!</p></li>

<li><p>The query is not performed around your coordinates, you search for the cell you are in then you query for the adjacent cells at the same level/radius, based on your needs, it means it works very approximately and you can only perform &lsquo;circles&rsquo; lookup around the cell you are in.</p></li>

<li><p>The most precise geohash needs 12 bytes storage.</p></li>

<li><p>-90 +90 and +180 -180, -0 +0 are not sides by sides prefixes.</p></li>
</ul>

<h2 id="why-s2">Why S2?</h2>

<p>S2 cells have a level ranging from <code>30</code> ~0.7cm² to <code>0</code> ~85,000,000km².<br />
S2 cells are encoded on an uint64, easy to store.</p>

<p>The main advantage is the <strong>region coverer algorithm</strong>, give it a region and the maximum number of cells you want, S2 will return some cells at <strong>different levels that cover the region you asked for</strong>, remember one cell corresponds to a range lookup you&rsquo;ll have to perform in your database.</p>

<p>The coverage is more accurate it means less read from the DB,  less objects unmarshalling&hellip;</p>

<h2 id="real-world-study">Real world study</h2>

<p>We want to query for objects inside Paris city limits using a rectangle:</p>

<p><img src="https://blog.nobugware.com/img/h5.jpg" alt="h5" title="Geohash using level 5" /><br />
Using level 5 we can&rsquo;t fit the left part of the city.<br />
We could add 3 cells (12 total DB queries ) on the left but most algorithms will zoom out to level 4.</p>

<p><img src="https://blog.nobugware.com/img/h4.jpg" alt="h4" title="Geohash using level 4" /><br />
But now we are querying for the whole region.</p>

<p><img src="https://blog.nobugware.com/img/s2.jpg" alt="s2" title="S2 9 cells" /><br />
Using s2 asking for 9 cells using a rectangle around the city limits.</p>

<p><img src="https://blog.nobugware.com/img/h4vss2.jpg" alt="s2 vs h4" title="Geohash vs s2" /><br />
The zones queried by Geohash in pink and S2 in green.</p>

<h2 id="example-s2-storage">Example S2 storage</h2>

<p>Let&rsquo;s say we want to store every cities in the world and perform a lookup to find the closest cities around, first we need to compute the <code>CellId</code> for each cities.</p>

<pre><code class="language-go">// Compute the CellID for lat, lng
c := s2.CellIDFromLatLng(s2.LatLngFromDegrees(lat, lng))

// store the uint64 value of c to its bigendian binary form
key := make([]byte, 8)
binary.BigEndian.PutUint64(key, uint64(c))
</code></pre>

<p>Big endian is needed to order bytes lexicographically, so we can seek later from one cell to the next closest cell on the Hilbert curve.</p>

<p><code>c</code> is a CellID to the level <code>30</code>.</p>

<p>Now we can store <code>key</code> as the key and a value (a string or msgpack/protobuf) for our city, in the database.</p>

<h2 id="example-s2-lookup">Example S2 lookup</h2>

<p>For the lookup we use the opposite procedure, first looking for one CellID.</p>

<pre><code class="language-go">// citiesInCellID looks for cities inside c
func citiesInCellID(c s2.CellID) {
  // compute min &amp; max limits for c
  bmin := make([]byte, 8)
  bmax := make([]byte, 8)
  binary.BigEndian.PutUint64(bmin, uint64(c.RangeMin()))
  binary.BigEndian.PutUint64(bmax, uint64(c.RangeMax()))

  // perform a range lookup in the DB from bmin key to bmax key, cur is our DB cursor
  var cell s2.CellID
  for k, v := cur.Seek(bmin); k != nil &amp;&amp; bytes.Compare(k, bmax) &lt;= 0; k, v = cur.Next() {
    buf := bytes.NewReader(k)
    binary.Read(buf, binary.BigEndian, &amp;cell)

    // Read back a city
    ll := cell.LatLng()
    lat := float64(ll.Lat.Degrees())
    lng := float64(ll.Lng.Degrees())
    name = string(v)
    fmt.Println(lat, lng, name)
  }
}
</code></pre>

<p>Then compute the CellIDs for the region we want to cover.</p>

<pre><code class="language-go">rect := s2.RectFromLatLng(s2.LatLngFromDegrees(48.99, 1.852))
rect = rect.AddPoint(s2.LatLngFromDegrees(48.68, 2.75))

rc := &amp;s2.RegionCoverer{MaxLevel: 20, MaxCells: 8}
r := s2.Region(rect.CapBound())
covering := rc.Covering(r)

for _, c := range covering {
    citiesInCellID(c)
}
</code></pre>

<p>RegionCoverer will return at most 8 cells (in this case 7 cells: 4 <code>8</code>, 1 <code>7</code>, 1 <code>9</code>, 1 <code>10</code>) that is guaranteed to cover the given region, it means we may have to exclude cities that were <strong>NOT</strong> in our <code>rect</code>, with <code>func (Rect) ContainsLatLng(LatLng)</code>.</p>

<p>Congrats we have a working geo db.</p>

<p>S2 can do more with complex shapes like Polygons and includes a lot of tools to compute distances, areas, intersections between shapes&hellip;</p>

<p>Here is a <a href="https://github.com/akhenakh/CompareGeoHashvsS2/blob/master/h4.json">Github repo for the data &amp; scripts generated for the images</a></p>

                    </div>
                </section>
                
                <h1 class="content-subhead">30 Aug 2015, 18:25</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.nobugware.com/post/2015/leveldb_geohash_golang/" class="post-title">A blazing fast geo database with LevelDB, Go and Geohashes</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                <a class="post-category post-category-Geo" href="https://blog.nobugware.com/categories/geo">Geo</a><a class="post-category post-category-Golang" href="https://blog.nobugware.com/categories/golang">Golang</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p>You probably have heard of <a href="https://github.com/google/leveldb">LevelDB</a> it’s a blazing fast key value store (as a library not a daemon), that uses Snappy compression.<br />
There is plenty of usages for it, the API is very simple at least in Go (I will be using <a href="https://github.com/syndtr/goleveldb">Goleveldb</a>).</p>

<p>The key is a <code>[]byte</code> the value is a <code>[]byte</code> so you can “get”, “put” &amp; “delete” that’s it.</p>

<p>I needed a low memory low cpu system that could collect millions of geo data and query over them,  <a href="https://en.wikipedia.org/wiki/Geohash">Geohash</a> has an interesting property you can encode longitude and latitude into a string : <code>f2m616nn</code> this hash represents the lat &amp; long 46.770, -71.304 <a href="http://geohash.org/f2m616nn">f2m616nn</a>, if you shorten the string to <code>f2m61</code> it still refers to the same lat &amp; long but with less precisions <a href="http://geohash.org/f2m61">f2m61</a>.<br />
A 4 digits hash leads to 19545 meters precision, to perfom a lookup around a position you simply query for the 8 adjacent blocks. <a href="http://github.com/TomiHiltunen/geohash-golang">A Geohash library for Go</a>.</p>

<p>Here you would store all of your data points matching a geohash to the same set.<br />
Problem there is no such thing as a set in LevelDB.</p>

<p>But there is a cursor so you can seek to a position then iterate over the next or previous one (byte ordered).<br />
So your data could be stored that way:  4 digits geohash + a uniq id.</p>

<p>Then you can perform proximity lookup by searching for the 8 adjacents hashes from the position your are looking with a precision of 20km, good but not very flexible.</p>

<p>We can have a more generic solution, first we need a key a simple int64 uniq id.</p>

<pre><code class="language-go">// NewKey generates a new key using time prefixed by 'K'
func NewKey() Key {
	return NewKeyWithInt(time.Now().UnixNano())
}

// NewKeyWithInt returns a key prefixed by 'K' with value i
func NewKeyWithInt(id int64) Key {
	key := bytes.NewBufferString(&quot;K&quot;)
	binary.Write(key, binary.BigEndian, id)
	return key.Bytes()
}
</code></pre>

<p>Here we can encode a key with a Unix timestamp so our key is not just a key it’s also an encoded time value, it will be uniq thanks to the nanosecond precision. We are using BigEndian so it can be byte compared: older will be before newer after.</p>

<p>Now about geo encoding our key will be of the form:<br />
<code>G201508282105dhv766K��Ϸ�Y�</code>  (note the end of the key is binary encoded)
You always need a prefix for your keys so you can seek and browse them without running over different keys types, here I have a <code>G</code> as Geo, then a string encoded date prefix, so we can search by date, but we don’t want extra precision here, it would add extra seek to LevelDB, (that’s why we have a modulo of 10 for minutes) then we add a precise geohash and finally our previous uniq id.</p>

<pre><code class="language-go">// NewGeoKey generates a new key using a position &amp; a key
func NewGeoKey(latitude, longitude float64) GeoKey {
	t := time.Now().UTC()
	kint := t.UnixNano()
	kid := NewKeyWithInt(kint)
	// G + string date + geohash 6 + timestamped key 
	// G201508282105dhv766K....
	gk := geohash.EncodeWithPrecision(latitude, longitude, 6)
	ts := t.Format(&quot;2006010215&quot;)

	// modulo 10 to store 10mn interval
	m := t.Minute() - t.Minute()%10
	zkey := []byte(&quot;G&quot; + ts + fmt.Sprintf(&quot;%02d&quot;, m) + gk)
	zkey = append(zkey, kid...)
	return zkey
}
</code></pre>

<p>We can now lookup by flexible date &amp; by flexible proximity like a Redis ZRANGE, you simply need to reverse the process.</p>

<pre><code class="language-go">// GeoKeyPrefix return prefixes to lookup using a GeoKey and timerange
func GeoKeyPrefix(start, stop time.Time) []string {
	var res []string
	d := 10 * time.Minute
	var t time.Time
	t = start
	for {
		if t.After(stop) {
			break
		}

		key := &quot;G&quot; + t.Format(&quot;2006010215&quot;) + fmt.Sprintf(&quot;%02d&quot;, t.Minute()-t.Minute()%10)
		res = append(res, key)
		t = t.Add(d)
	}
	return res
}
</code></pre>

<p>Lookup that way:</p>

<pre><code class="language-go">	d := time.Duration(-10) * time.Minute
	geoPrefixs := GeoKeyPrefix(time.Now().UTC().Add(d), time.Now().UTC())

	// find adjacent hashes in m
	// 1, 5003530
	// 2, 625441
	// 3, 123264
	// 4, 19545
	// 5, 3803
	// 6, 610
	gk := geohash.EncodeWithPrecision(lat, long, 4)
	adjs := geohash.CalculateAllAdjacent(gk)
	adjs = append(adjs, gk)

	// for each adjacent blocks
	for _, gkl := range adjs {

		// for each time range modulo 10
		for _, geoPrefix := range geoPrefixs {
			startGeoKey := []byte(geoPrefix + gkl)
			iter := s.NewIterator(util.BytesPrefix(startGeoKey), nil)

			for iter.Next() {
				log.Println(iter.Value())
			}
			iter.Release()
		}
	}
</code></pre>

<p>It can be optimized, reducing the size of the keys, but it performs extremely well storing around 3 millions geopoints per day, using less than 3% cpu and can received hundreds of queries per second.</p>

<p>Oh did I forget to mention it&rsquo;s running on a Raspberry Pi? :)</p>

<p>I could maybe turn it into a library but it&rsquo;s so simple it&rsquo;s probably useless.<br />
Next blog post: what are those millions points used for?</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">02 Aug 2015, 13:10</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.nobugware.com/post/2015/metrics_golang_operating_system/" class="post-title">Access OS metrics from Golang</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                <a class="post-category post-category-Golang" href="https://blog.nobugware.com/categories/golang">Golang</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p>I&rsquo;ve recently published <a href="https://github.com/akhenakh/statgo">StatGo</a>, it gives you access to your operating system metrics like free memory, used disk spaces &hellip;</p>

<p>It&rsquo;s a binding to the C library <a href="http://www.i-scream.org/libstatgrab/">libstatgrab</a>, a proven stable piece of code that works on many different systems, FreeBSD, Linux, OSX &hellip;</p>

<p>It&rsquo;s very simple to use:</p>

<pre><code class="language-go">s := NewStat()
c := s.CPUStats()
fmt.Prinln(c.Idle)
98.2
</code></pre>

<p>Feel free to contribute, it may need some improvement but it&rsquo;s working I&rsquo;m using it in a small metrics web server to monitor small network of servers.</p>

<p>The <a href="https://github.com/akhenakh/statgo">code is on Github</a></p>

                    </div>
                </section>
                
                <h1 class="content-subhead">02 Apr 2015, 12:49</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.nobugware.com/post/2015/04/grafana_influxdb/" class="post-title">A 10 minutes walk into Grafana &amp; Influxdb</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                <a class="post-category post-category-Golang" href="https://blog.nobugware.com/categories/golang">Golang</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p>This is a 10 minute tutorial to set up an <a href="http://influxdb.com/">InfluxDB</a> + <a href="http://grafana.org/">Grafana</a> with Go on your Mac, but should work with minor modifcations on your favorite Unix too, it assumes you already have a working Go compiler.</p>

<p><a href="http://influxdb.com/">InfluxDB</a> is a database specialized into time series, think store everything associated with a time, makes it perfect for monitoring and graphing values.
<a href="http://grafana.org/">Grafana</a> is a js frontend capable of reading the data from InfluxDB and graphing it.</p>

<p><code>brew install influxdb</code></p>

<p>Start <a href="http://influxdb.com/">InfluxDB</a>, and then point your browser to <a href="http://localhost:8083">http://localhost:8083</a> default user is root, password is root and default port is 8086.</p>

<p><code>influxdb -config /usr/local/etc/influxdb.conf</code>
Create a database called test.</p>

<p>Let&rsquo;s test the connection with the db and Go, first install the InfluxDB driver for Go:</p>

<p><code>go get github.com/influxdb/influxdb/client</code>
Test your setup with some code:</p>

<pre><code class="language-go">package main

import (
    &quot;fmt&quot;

    &quot;github.com/influxdb/influxdb/client&quot;
)

func main() {
    c, err := client.NewClient(&amp;client.ClientConfig{
        Username: &quot;root&quot;,
        Password: &quot;root&quot;,
        Database: &quot;test&quot;,
    })

    if err != nil {
        panic(err)
    }

    dbs, err := c.GetDatabaseList()
    if err != nil {
        panic(err)
    }

    fmt.Println(dbs)
}
</code></pre>

<p>If you are good you should see a map containing all your created <a href="http://influxdb.com/">InfluxDB</a> databases.</p>

<p>Now let&rsquo;s measure something real: the time it takes for your http handler to answer.</p>

<pre><code class="language-go">package main

import (
    &quot;fmt&quot;
    &quot;log&quot;
    &quot;math/rand&quot;
    &quot;net/http&quot;
    &quot;time&quot;

    &quot;github.com/influxdb/influxdb/client&quot;
)

var c *client.Client

func mySuperFastHandler(rw http.ResponseWriter, r *http.Request) {
    start := time.Now()
    // sleeping some random time
    rand.Seed(time.Now().Unix())
    i := rand.Intn(1000)
    time.Sleep(time.Duration(time.Duration(i) * time.Millisecond))
    fmt.Fprintf(rw, &quot;Waiting %dms&quot;, i)
    t := time.Since(start)

    // sending the serie
    s := &amp;client.Series{
        Name:    &quot;myhostname.nethttp.mySuperFastHandler.resp_time&quot;,
        Columns: []string{&quot;duration&quot;, &quot;code&quot;, &quot;url&quot;, &quot;method&quot;},
        Points: [][]interface{}{
            []interface{}{int64(t / time.Millisecond), 200, r.RequestURI, r.Method},
        },
    }
    err := c.WriteSeries([]*client.Series{s})
    if err != nil {
        log.Println(err)
    }
}

func main() {
    var err error
    c, err = client.NewClient(&amp;client.ClientConfig{
        Username: &quot;root&quot;,
        Password: &quot;root&quot;,
        Database: &quot;test&quot;,
    })
    if err != nil {
        panic(err)
    }

    http.HandleFunc(&quot;/&quot;, mySuperFastHandler)
    http.ListenAndServe(&quot;:8080&quot;, nil)
}
</code></pre>

<p>This is not very useful as it&rsquo;s measuring the time to write to the ResponseWriter that&rsquo;s why I&rsquo;ve added some random time but you get the sense.
It will save a serie per request as: duration, status code, url, http method, the name of the serie is important as many tools (as Graphite) are using the dots as separator, so think twice before naming your serie.
Point your browser to <a href="http://localhost:8080">http://localhost:8080</a> and reload the page several times.</p>

<p>Now that we have data let&rsquo;s browse them with the <a href="http://influxdb.com/">InfluxDB</a> browser, go to the <a href="http://influxdb.com/">InfluxDB</a> admin and hit &ldquo;explore data&rdquo; and select with:</p>

<p><code>SELECT duration FROM myhostname.nethttp.mySuperFastHandler.resp_time WHERE code = 200;</code></p>

<p><img src="http://kdl.nobugware.com/public/shotinflux.png" alt="Image Alt" /></p>

<p>You should be able to see the inserted data points.</p>

<p>Now let&rsquo;s work with <a href="http://grafana.org/">Grafana</a>, download the tar gz, uncompress it somewhere, <a href="https://gist.githubusercontent.com/akhenakh/39e1950bf95859878748/raw/f8b0531d88cfb481213541253329c5730c4a2b06/config.js">copy this demo config.js</a> file in the root directory of <a href="http://grafana.org/">Grafana</a>.
Go to the <a href="http://influxdb.com/">InfluxDB</a> admin with your browser and add a new database called &ldquo;grafana&rdquo;.</p>

<p>In your web browser, open the file index.html in the <a href="http://grafana.org/">Grafana</a> directory, you should see a the <a href="http://grafana.org/">Grafana</a> interface edit the default graph, enter the query as follow:</p>

<ul>
<li>click on series it will complete with myhostname.nethttp.mySuperFastHandler.resp_time</li>
<li>In alias type $0 $2, it will use the 1st part and the 3rd part of the name (remember the dots) so it will display myhostname mySuperFastHandler</li>
<li>Finally click on mean and choose duration in the completion, then add code = 200 as where clause.<br /></li>
</ul>

<p>Hit save and you are done !</p>

<p><img src="http://kdl.nobugware.com/public/shotgrafana.png" alt="Image Alt" /></p>

<p>There is so much more you can do with <a href="http://influxdb.com/">InfluxDB</a> &amp; <a href="http://grafana.org/">Grafana</a>, it&rsquo;s really simple to collect and display, hope you want to go further after this.
You can look at my <a href="https://github.com/akhenakh/influxhandler">generic net/http handler for <a href="http://influxdb.com/">InfluxDB</a> on Github</a> that can be integrated into your code.</p>

                    </div>
                </section>
                
            </div>
            
<div class="pagination">
  <nav role="pagination" class="post-list-pagination">
      
    <span class="post-list-pagination-item post-list-pagination-item-current">Page 1 of 2</span>
    
      <a href="https://blog.nobugware.com/categories/golang/page/2/" class="post-list-pagination-item pure-button post-list-pagination-item-next">
        Older&nbsp;<i class="fa fa-angle-double-right"></i>
      </a>
    
  </nav>
</div>


            <div class="footer">
    <div class="pure-menu pure-menu-horizontal pure-menu-open">
        <ul>
            <li>Powered by <a class="hugo" href="http://hugo.spf13.com/" target="_blank">hugo</a></li>
        </ul>
    </div>
</div>
<script src="https://blog.nobugware.com/js/all.min.js"></script>
        </div>
    </div>
</div>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-1245966-1', 'auto');
ga('send', 'pageview');

</script>

</body>
</html>
