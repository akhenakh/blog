<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8"/>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta name="generator" content="Hugo 0.58.1" />
		<title>Nomad an alternative to Kubernetes - Fabrice Aneche</title>

		<meta name="description" content="Hashicorp Nomad as an alternative to Kubernetes to orchestrate containers deployments">


		
	
		




<link rel="stylesheet" href="https://blog.nobugware.com/css/ui.css">

	
		

		<link  rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Mono|Lato|Raleway">

		
	</head>

<body>
<header class="container no-print">
	<div class="u-header">
		<nav class="bar">
	<ul><li>
			<a href="https://blog.nobugware.com/">
				<img class="icon-text" src="https://blog.nobugware.com/img/prev.svg"/>
			</a>
		</li><li><a href="https://blog.nobugware.com/about">About</a></li><li><a href="https://blog.nobugware.com/post/">Post</a></li></ul>
</nav>

	</div>
</header>
<main class="container">

<article>
	<header><hgroup id="brand">
	<h1>Nomad an alternative to Kubernetes</h1>
	<h5>
		
		<time datetime="2019-11-12 03:00:00 &#43;0000 UTC">Nov 12, 2019</time>
		<span class="no-print">
			-
				
				<a href="https://blog.nobugware.com/tags/devops">devops</a>
				
				<a href="https://blog.nobugware.com/tags/nomad">nomad</a>
				
				<a href="https://blog.nobugware.com/tags/kubernetes">kubernetes</a>
				
				<a href="https://blog.nobugware.com/tags/grpc">grpc</a>
				
				<a href="https://blog.nobugware.com/tags/go">go</a>
				<span>
	</h5>
	
</hgroup>
<hr class="sep" />
</header>
	

<p>If you are familiar with this blog you know I really appreciate <a href="https://kubernetes.io/">Kubernetes</a>: as a former ops I strongly believe Kubernetes is one way to bundle &ldquo;the sum of 20y ops good practices&rdquo;.</p>

<p>But there are others solutions one is <a href="https://www.hashicorp.com/products/nomad/">Nomad</a>.<br />
It&rsquo;s made by <a href="https://www.hashicorp.com/">Hashicorp</a>, creators of <a href="https://www.hashicorp.com/products/vault/">Vault</a>, <a href="https://www.hashicorp.com/products/consul/">Consul</a>, <a href="https://www.hashicorp.com/products/terraform/">Terraform</a>&hellip;<br />
In general Hashicorp is synonym with quality.</p>

<p><a href="https://www.hashicorp.com/products/nomad/">Nomad</a> is a task scheduler, a task could be execute a command, run a Docker container or a QEMU vm&hellip;<br />
The project is open sourced with several enterprise features.</p>

<p>I had the opportunity to deploy the same project on Kubernetes and Nomad.<br />
Here are some key points:</p>

<h2 id="self-deployment">Self Deployment</h2>

<p>If you are self hosted before using Kubernetes or Nomad, you first need to deploy them.<br />
Nomad is one binary, but the truth is Nomad is almost useless without <a href="https://www.consul.io/docs/index.html">Consul</a> (also one binary).<br />
First deploy a Consul cluster, then deploy Nomad, both are so integrated Nomad will automatically create and join a cluster on top of an existing Consul instance running on the same host.<br />
Deploying a working Nomad cluster is easy vs painful Kubernetes but it&rsquo;s unfair to compare since some parts are missing in Nomad, see below.</p>

<h2 id="migration">Migration</h2>

<p>This project consists of several gRPC micro services, Redis, PostgreSQL, <a href="https://docs.traefik.io/">Traefik</a> and <a href="https://nats.io/">NATS</a>.<br />
I was afraid the rewrite needed to work on a different target than Kuberneres would be time consuming.<br />
But with containers and following good practices, no matter how or on what you deploy it&rsquo;s almost the same.<br />
I find the Nomad deployment files (<a href="https://github.com/hashicorp/hcl#syntax">HCL</a>) a lot easier to look at and understand than Kubernetes YAML which I&rsquo;ve read for 4 years !@#</p>

<p><a href="https://gist.github.com/akhenakh/9769c41fa1912dd4ff4026f94e37a007">Here is one of my Nomad deployment file</a> as an example, I find every lines to be self-explanatory.</p>

<h2 id="service-discovery">Service Discovery</h2>

<p>One big difference with Kubernetes: the services are not load balanced behind an IP address, by default Docker instances run on the existing node network stack using different ports to avoid conflicts.<br />
So for a container to reach another service, you have to know the address in advance which is not always possible, hardcode a listening port which is also not always possible, or use Consul services resolution, via templates, via DNS or the Consul API.</p>

<p>Not all the apps know about Consul especially containers you don&rsquo;t own, Redis for example.<br />
For those Nomad is providing a template language (build around <a href="https://github.com/hashicorp/consul-template">Consul-template</a>) which allow you to change files or environment according to Consul:</p>

<pre><code>      template {
        data = &lt;&lt;EOH
NATSBROKERS = &quot;{{range $index, $service := service &quot;nats-client&quot; }}{{if ne $index 0}},{{end}}{{$service.Address}}:{{$service.Port}}{{end}}&quot;
REDISADDR = &quot;{{range $index, $service := service &quot;redis-cache&quot; }}{{if ne $index 0}},{{end}}{{$service.Address}}:{{$service.Port}}{{end}}&quot;
EOH

        destination = &quot;secrets/file.env&quot;
        env = true
      }
</code></pre>

<p>This will create a file in <code>/secrets/file.env</code> (<code>/local</code> &amp; <code>/secret</code> are volumes automatically mounted into your containers), with all addresses &amp; ports entered in Consul as <code>nats-client</code> service, so on every starts your container will know about other services.</p>

<p>Finding the endpoints to a dependency service when your program start is one thing, updating this list in the long run is something else.</p>

<p>Nomad offers a way to <a href="https://www.nomadproject.io/docs/job-specification/template.html#change_mode">notify your program for templates changes via a signal</a>, but it&rsquo;s not always optimal, you should probably go with client load balancing when possible:</p>

<p>I&rsquo;ve already blogged about <a href="https://blog.nobugware.com/post/2019/kubernetes_mesh_network_load_balancing_grpc_services">client load balancing inside Kubernetes with gRPC</a>, the same applies with Nomad using a <a href="http://github.com/mbobakov/grpc-consul-resolver">Consul gRPC resolver</a>.<br />
The code modifications needed for this to work with Consul has been just one line, import the package.</p>

<h2 id="dns">DNS</h2>

<p>Kubernetes installation includes most of the time <a href="https://coredns.io/">CoreDNS</a> which talks to the Kube API and updates the DNS entries accordingly.<br />
With Nomad you&rsquo;ll use Consul.<br />
Consul is a key value storage (same as ETCD in k8s world) where you can register some special keys: a service.<br />
This service can then be queried via the Consul API or via an embedded DNS server.<br />
There are many ways to make this DNS visible to your programs, <a href="https://learn.hashicorp.com/consul/security-networking/forwarding">they are documented here</a> and need some manual actions for your hosts to respond to <code>consul.</code> top level domain.</p>

<p>I&rsquo;m using a simple dnsmasq.</p>

<pre><code># Enable forward lookup of the 'consul' domain:
server=/consul/127.0.0.1#8600

# Accept DNS queries only from hosts whose address is on a local subnet.
local-service
</code></pre>

<p>If systemd resolver is running you&rsquo;ll hit an issue since it&rsquo;s already binding 127.0.0.1:53.<br />
Add this to <code>/etc/systemd/resolved.conf</code></p>

<pre><code>DNSStubListener=no
</code></pre>

<p>Then use the <a href="https://www.nomadproject.io/docs/drivers/docker.html#dns_servers"><code>dns_servers</code></a> directive to point your containers to dnsmasq.</p>

<h2 id="network">Network</h2>

<p>Since there is no automatic level 4 load balancing, no network manager ala Flannel, in base Nomad, you are on your own on the network management of your cluster which is probably a good thing, dealing with k8s sometimes unnecessary network complexity is no fun.</p>

<p>Beginning with Nomad 0.10.x there is a mesh solution using a sidecared Envoy called Connect, very similar to Istio.<br />
Again I&rsquo;m not convinced about the whole &ldquo;Mesh is the solution for everything&rdquo;, especially using Envoy which still suffers big issues with gRPC.</p>

<h2 id="load-balancing">Load Balancing</h2>

<p>Load balancing (level 7) is no different than Kubernetes, I&rsquo;m used to Traefik and the move was easy (note that only Traefik 1.x is supporting Nomad so far).</p>

<p>With this section Traefik queries the Consul API and find any services tagged <code>service</code>.</p>

<pre><code>[consulCatalog]
endpoint = &quot;127.0.0.1:8500&quot;
domain = &quot;consul.localhost&quot;
prefix = &quot;traefik&quot;
constraints = [&quot;tag==service&quot;]
</code></pre>

<p>Than tag your Nomad service to automatically create an endpoint load balanced to all the Nomad allocations:</p>

<pre><code>        tags = [
          &quot;traefik.tags=service&quot;,
          &quot;traefik.frontend.rule=Host:map.dev.mydomain&quot;,
        ]
</code></pre>

<h2 id="consumption">Consumption</h2>

<p>When deployed in Kubernetes this project was running on GCP/GKE but also on <a href="https://blog.nobugware.com/post/2019/bare-metal-kubernetes-quick-installations-on-arch/">a ARM64 Kubernetes cluster</a>.<br />
My ARM64 cluster made of 50$ servers was really unstable which is a good way to test for failures, since Nomad I&rsquo;m suffering way less reboots.<br />
I was really surprised for the same workload the overall Nomad cluster was way less resource consuming, surely Kubernetes is capable of more but we are comparing the same project deployments here.<br />
Even on x86 GCP with 3 medium servers you&rsquo;ll hit resources issues very fast, for some reasons Nomad is resources friendly.</p>

<h2 id="documentation-help">Documentation &amp; Help</h2>

<p>I found the Hashicorp documentation very well written but sometimes they assume you are in the Hashicorp ecosystem for too long.<br />
There is no good documentation for service resolution inside Nomad since it&rsquo;s Consul based&hellip;</p>

<p>Kubernetes is the de facto orchestrator, finding answers is easier, don&rsquo;t go with Nomad if you are new to this.</p>

<h2 id="included">Included</h2>

<ul>
<li>DNS server (Consul)</li>
<li>Key Value storage (Consul) you are encouraged to use it, in opposition to Kubernetes <a href="https://etcd.io/">ETCD</a> which should be dedicated</li>
<li>Web interface to manage your deployments (there is also a builtin UI for Consul)</li>
<li>Container Logs (best effort to keep recent logs)</li>
<li>Rolling upgrades</li>
<li>Metrics (<a href="https://www.nomadproject.io/api/metrics.html">Prometheus compatible</a>)</li>
</ul>

<h2 id="overall">Overall</h2>

<p>As always, there is no such thing as a tool to rule them all.<br />
Kubernetes is getting all the visibility for good reasons, but it&rsquo;s probably not suitable for small to medium companies, you don&rsquo;t need to deploy Google infrastructure when you are not Google.<br />
Nomad is a clear alternative and a fresh challenger with great ideas.<br />
I&rsquo;ll definitely keep Nomad for this project, not going back to k8s.<br />
There are giant Consul deployments out there, not sure about Nomad but will follow the project actively.</p>

</article>
<nav class="no-print post-nav">

	<a class="prev-post" href="https://blog.nobugware.com/post/2019/advanced-traefik-2-0-with-kubernetes/">
		<img class="icon-text" src="https://blog.nobugware.com/img/prev.svg"/>Advanced Traefik 2.0 with Kubernetes</a>


</nav>


<section id="related">
  <h4>See Also</h4>
  <ul>
    
  	<li><a href="https://blog.nobugware.com/post/2019/advanced-traefik-2-0-with-kubernetes/">Advanced Traefik 2.0 with Kubernetes</a></li>
  	
  	<li><a href="https://blog.nobugware.com/post/2019/self_hosted_world_maps/">Self Hosted World Maps</a></li>
  	
  	<li><a href="https://blog.nobugware.com/post/2019/google-kubernetes-engine-gcp/">Google Kubernetes Engine &amp; GCP</a></li>
  	
  </ul>
</section>




			<hr class="sep" />
		</main>
		<footer class="container no-print">
			<div class="u-footer">
				

<a href="https://github.com/akhenakh/"><img class="icon-social" src="https://blog.nobugware.com/img/github.svg" alt="Github"/></a>


<a href="https://twitter.com/akhenakh"><img class="icon-social" src="https://blog.nobugware.com/img/twitter.svg" alt="Twitter"/></a>

<a href="https://blog.nobugware.com/index.xml" target="_blank"><img class="icon-social" src="https://blog.nobugware.com/img/feed.svg" alt="Feed"></a>

				<p>
					
					Theme used: <a href="https://github.com/yursan9/manis-hugo-theme">Manis</a><br>
					
					
					
				</p>
				
				<a href="#brand">
					<img class="icon-text" src="https://blog.nobugware.com/img/toup.svg" alt="To Up"/>
					<span>Back to Up</span>
				</a>
				
			</div>
		</footer>
                
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-1245966-1', 'auto');
ga('send', 'pageview');

</script>

		
	</body>
</html>

