<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fabrice Aneche &middot; Fabrice Aneche</title>

    <meta name="description" content="">

    <meta name="generator" content="Hugo 0.55.3" />
    <meta name="twitter:card" content="summary">
    
    <meta name="twitter:title" content="Fabrice Aneche &middot; Fabrice Aneche">
    <meta name="twitter:description" content="">

    <meta property="og:type" content="article">
    <meta property="og:title" content="Fabrice Aneche &middot; Fabrice Aneche">
    <meta property="og:description" content="">

    <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700|Oxygen:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/pure-min.css">
    <!--[if lte IE 8]>
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-old-ie-min.css">
    <![endif]-->
    <!--[if gt IE 8]><!-->
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-min.css">
    <!--<![endif]-->

    <link rel="stylesheet" href="https://blog.nobugware.com/css/all.min.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">

    <link rel="alternate" type="application/rss+xml" title="Fabrice Aneche" href="https://blog.nobugware.com/index.xml" />
    <link href="https://blog.nobugware.com/css/prism.css" rel="stylesheet" />
</head>
<body>


<div id="layout" class="pure-g">
    <div class="sidebar pure-u-1 pure-u-md-1-4">
    <div class="header">
        <hgroup>
            <h1 class="brand-title"><a href="https://blog.nobugware.com">Fabrice Aneche</a></h1>
            <h2 class="brand-tagline"></h2>
        </hgroup>

        <nav class="nav">
            <ul class="nav-list">
                
                <li class="nav-item">
                    <a class="pure-button" href="http://www.nobugware.com"><i class="fa fa-building-o"></i> Hiring</a>
                </li>
                
                
                <li class="nav-item">
                    <a class="pure-button" href="https://twitter.com/akhenakh"><i class="fa fa-twitter"></i> Twitter</a>
                </li>
                
                
                <li class="nav-item">
                    <a class="pure-button" href="https://github.com/akhenakh "><i class="fa fa-github-alt"></i> github</a>
                </li>
                
                <li class="nav-item">
                    <a class="pure-button" href="https://blog.nobugware.com/index.xml"><i class="fa fa-rss"></i> rss</a>
                </li>
            </ul>
        </nav>
    </div>
</div>


    <div class="content pure-u-1 pure-u-md-3-4">
        <div>
            
            <div class="posts">
                
                <h1 class="content-subhead">20 Sep 2016, 17:40</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.nobugware.com/post/2016/grpc_envoy_nghttp2_load_balancing/" class="post-title">gRPC Envoy Nghttp2 and Load Balancing</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                <a class="post-category post-category-Golang" href="https://blog.nobugware.com/categories/golang">Golang</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p>I&rsquo;ve been using <a href="http://www.grpc.io/">gRPC</a> at work and in several personal projects for months and happy with it, but when it comes to load balancing gRPC does not come with batteries included.</p>

<p>For a long time the only document was the <a href="https://github.com/grpc/grpc/commit/b31ec1e81c93d4c9bf30a4600096a6a6f5b90935">Load Balancing draft in the gRPC repo</a>, the clients should implement a Picker interface to know about the servers, so the pooling and controling the load were handled by the clients.<br />
HTTP/2 was new and most of the reverse proxies implementations were not capable of load balancing gRPC HTTP2 frames, the only solution was to use a TCP load balancer, generating errors, improper  and weird behaviours for the clients.</p>

<p>At least two projects are now supporting gRPC load balancing easily.</p>

<ul>
<li>The recently announced <a href="https://lyft.github.io/envoy/">Envoy</a> from Lyft</li>
<li>And nghttpx from <a href="https://www.nghttp2.org/">nghttp2</a></li>
</ul>

<p>Here are some notes to simply load balance two <a href="https://github.com/grpc/grpc-go/tree/master/examples/helloworld">gRPC Helloworld server!</a> running on ports 50050 &amp; 50051.</p>

<ul>
<li><p>For nghttp2, a simple configuration file will do</p>

<pre><code>frontend=*,8000;no-tls
backend=localhost,50050;;no-tls;proto=h2;fall=2;rise=2
backend=localhost,50051;;no-tls;proto=h2;fall=2;rise=2
workers=8
</code></pre></li>

<li><p>For envoy, here is the cluster part</p>

<pre><code class="language-js">&quot;clusters&quot;: [
  {
    &quot;name&quot;: &quot;local_service&quot;,
    &quot;connect_timeout_ms&quot;: 250,
    &quot;type&quot;: &quot;static&quot;,
    &quot;lb_type&quot;: &quot;least_request&quot;,
    &quot;features&quot;: &quot;http2&quot;,
    &quot;hosts&quot;: [
      {
        &quot;url&quot;: &quot;tcp://127.0.0.1:50050&quot;
      },
      {
        &quot;url&quot;: &quot;tcp://127.0.0.1:50051&quot;
      }
    ]
  }
]
</code></pre></li>
</ul>

<p>You can then tweak the greeter_client to loop for requests, so you can simulate a client doing multiple requests while killing/restarting your servers.</p>

<pre><code class="language-go">for {  
    r, err := c.SayHello(context.Background(), &amp;pb.HelloRequest{Name: name}) 
    if err != nil { 
        log.Printf(&quot;could not greet: %v&quot;, err)
    }
    log.Printf(&quot;Greeting: %s&quot;, r.Message)
}
</code></pre>

<p>And modify the greeter_server to show on which port/server you get your response:</p>

<pre><code class="language-go">// SayHello implements helloworld.GreeterServer
func (s *server) SayHello(ctx context.Context, in *pb.HelloRequest) (*pb.HelloReply, error) {
    return &amp;pb.HelloReply{Message: &quot;Hello &quot; + in.Name + port}, nil 
}
</code></pre>

<p>Those tests aren&rsquo;t enabling any TLS so use <code>grpc.WithInsecure()</code>.</p>

<p>Note that Envoy is also capable of <a href="https://lyft.github.io/envoy/docs/configuration/http_filters/grpc_http1_bridge_filter.html">bridging your HTTP/1.1 queries to gRPC</a>, which is a killer feature (I haven&rsquo;t tested it yet) , you would normally do it by code with <a href="https://github.com/grpc-ecosystem/grpc-gateway">gRPC-gateway</a>.</p>

<p>Envoy is really new and I&rsquo;m still digging into but already proves itself to be a <strong>complete load balancing proxy solution</strong>  with or without gRPC in your stack.</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">22 Jul 2016, 19:11</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.nobugware.com/post/2016/streaming_raspberry_twitch_audio_rtl_sdr/" class="post-title">Streaming using a Raspberry Pi Camera to Twitch in Full HD while injecting audio from rtl sdr</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                <a class="post-category post-category-HamRadio" href="https://blog.nobugware.com/categories/hamradio">HamRadio</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<p>I have found the right setup to stream in 1080p from a Raspberry Pi using the camera to <a href="https://www.twitch.tv">TwitchTV</a> while injecting audio on the fly!</p>

<p>Create an account on Twitch and grab you stream key in the Dashboard.</p>

<p>This <code>stream.sh</code> script will create a FIFO start <code>rtl_fm</code> at freq 162.550M to listen to Canada weather bulletin (use your local NOAA channel) and inject and encode the audio to the existing h264 stream from the camera then stream it to twitch using rtmp.</p>

<pre><code>#! /bin/bash
STREAM_URL=&quot;rtmp://live.justin.tv/app/&quot;
KEY=&quot;live_XXXXX_XXXXXXXXXXXXXX&quot; # put your key here

mkfifo /tmp/streamaudio.wav
rtl_fm -f 162.550M -s 22050 -g 30 | sox -r 22050 -t raw -e signed -b 16 -c 1 -V1 - -r 22050 -t wavpcm  -  &gt; /tmp/streamaudio.wav &amp;

/opt/vc/bin/raspivid -n -vf -t 0 -w 1920 -h 1080 -fps 25 -o - | ffmpeg -re -i - -i /tmp/streamaudio.wav -codec copy -strict experimental -acodec libmp3lame -ar 22050 -threads 8 -f flv &quot;$STREAM_URL/$KEY&quot;
</code></pre>

<p>You can of course send other audio sources or no audio at all.</p>

<p>This setup is taking around 10% cpu on a Raspberry Pi 2.</p>

<p>If you are lucky enough my channel will be up and running.<br />
<div class="embed">
    <iframe height="378" width="620" frameborder="0" scrolling="no" src="http://www.twitch.tv/akhenakh/embed"></iframe>
</div>
</p>

<h2 id="what-is-rtl-sdr">What is RTL SDR ?</h2>

<p>Using a 20$ <a href="http://www.rtl-sdr.com/buy-rtl-sdr-dvb-t-dongles/">USB dongle</a> you have a  software radio scranner, capable of listening to radio amateurs, NOAA weather bulletin even <a href="http://blog.nobugware.com/post/2015/listening_to_satellites_for_30_dollars/">satellites</a>.</p>

<p>Note that you can also stream from your laptop using the great and free <a href="https://obsproject.com/">ObsProject</a>.</p>

<p>Happy streaming.</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">03 Jul 2016, 08:15</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.nobugware.com/post/2016/gometalinter_jetbrains_idea/" class="post-title">Enabling Gometalinter with Jetbrains Editors</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                <a class="post-category post-category-Golang" href="https://blog.nobugware.com/categories/golang">Golang</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p>I&rsquo;ve been using Jetbrains editor (the free <a href="https://www.jetbrains.com/idea/download/">Idea community edition</a>) or Pycharm with the <a href="https://github.com/go-lang-plugin-org/go-lang-idea-plugin">Go plugins</a> and very happy with this setup, the editor is providing some realtime linting but I was missing <code>gometalinter</code>.</p>

<p>First install <code>gometalinter</code></p>

<pre><code>go get -u github.com/alecthomas/gometalinter
gometalinter --install --update
</code></pre>

<p>To add support inside Jetbrains editors use the External tools feature.<br />
In Preferences &gt; Tools &gt; External Tools, add a configuration.</p>

<p><img src="https://blog.nobugware.com/img/gometalinter.jpg" alt="gometalinter setup for jetbrains" title="gometalinter setup for jetbrains" /></p>

<p>Set the Program path to your <code>$GOPATH/bin/gometalinter</code><br />
Parameters to <code>--deadline=15s --vendor $FileDir$</code><br />
Working directory to <code>$ProjectFileDir$</code></p>

<p>For the linters messages to be clickable and jump to code add an Output filter with Regular expression to match output <code>$FILE_PATH$:$LINE$</code></p>

<p><img src="https://blog.nobugware.com/img/gometalinter2.jpg" alt="gometalinter setup filter for jetbrains" title="gometalinter setup filter for jetbrains" /></p>

                    </div>
                </section>
                
                <h1 class="content-subhead">08 Mar 2016, 11:23</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.nobugware.com/post/2016/geo_db_s2_region_polygon_optmization/" class="post-title">A geo database for polygons, optimization</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                <a class="post-category post-category-Geo" href="https://blog.nobugware.com/categories/geo">Geo</a><a class="post-category post-category-Golang" href="https://blog.nobugware.com/categories/golang">Golang</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p>If you read this blog, you know I&rsquo;ve recently released a project called <a href="https://github.com/akhenakh/regionagogo">regionagogo</a>, a geo shape lookup database, described in <a href="https://blog.nobugware.com/post/2016/geo_db_s2_region_polygon/">this blogpost</a>.</p>

<p>It uses the current <a href="https://godoc.org/github.com/golang/geo/s2">Go S2 implementation</a>, which is not yet as complete as the C++ implementation, for example the region coverer of a shape does not really compute cell around the shape but around the bounding box instead.</p>

<p>Using the shape of the polygon makes the covered cells more precise and smaller, resulting at the end to less <a href="https://en.wikipedia.org/wiki/Point_in_polygon">PIP</a> tests which are costly.</p>

<p><img src="https://blog.nobugware.com/img/s2cpp.jpg" alt="S2 over a shape" title="S2 cover" /><br />
The same coverage with Go S2 would have returned 8 big cells of the same size, covering over regions.</p>

<p>I&rsquo;ve created <a href="https://github.com/akhenakh/regionagogogen">regionagogogen</a> a quick and dirty command line program for OSX that takes a GeoJSON file containing your regions and then compute the database using the S2 C++ implementation, it&rsquo;s for OSX only cause I&rsquo;m using ObjC as a bridge to C++ which I don&rsquo;t know enough.</p>

<p>Also note that <a href="https://github.com/akhenakh/regionagogogen">regionagogogen</a> includes an S2 port that works on iOS/OSX and some ObjC geo helper classes.</p>

<p>The <a href="https://hub.docker.com/r/akhenakh/regionagogo/">Docker image fore regionagogo</a> is also using the optimized database.</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">18 Feb 2016, 17:16</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.nobugware.com/post/2016/geo_db_s2_region_polygon/" class="post-title">A geo database for polygons, foundations</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                <a class="post-category post-category-Geo" href="https://blog.nobugware.com/categories/geo">Geo</a><a class="post-category post-category-Golang" href="https://blog.nobugware.com/categories/golang">Golang</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<p>On a previous post, <a href="http://blog.nobugware.com/post/2016/geo_db_s2_geohash_database/">I&rsquo;ve described how to use the S2 geo library</a> to create a fast geo database, but it was to store locations (points) and only to perform range queries, a complete geo database would have regions/polygons queries.</p>

<h2 id="looking-for-a-solution">Looking for a solution</h2>

<p>I had this need: querying for the countries or subregions of hundreds of coordinates per second, without relying on an external service.</p>

<p>One solution, using my previous technique, could have been to store every cities in the world and then perform a proximity query around my point to get the closest cities, but it works only in populated area and it&rsquo;s only an approximation.</p>

<p>I looked into others solutions, there is some smart ideas <a href="https://github.com/hlaw/codegrid-js">using UTF-grid</a>, but it&rsquo;s a client side solution and also an approximation tied to the resolution of the computed grid.</p>

<h2 id="s2-to-the-rescue">S2 to the rescue</h2>

<p>S2 cells have some nice properties, they are segments on the <a href="https://en.wikipedia.org/wiki/Hilbert_curve">Hilbert curve</a>, expressed as range of <code>uint64</code>, so I had the intuition the problem to perform fast region lookup could be simplified as find all mathematical segments containing my location expressed as an <code>uint64</code>.</p>

<p><img src="https://blog.nobugware.com/img/s2belgium.jpg" alt="S2 over a country" title="S2 covering belgium" /></p>

<p>Using a <a href="https://en.wikipedia.org/wiki/Segment_tree">Segment Tree</a> datastructure, I first tried an in memory engine, using <a href="http://www.naturalearthdata.com/">Natural Earth Data</a>, loading the whole world countries shapes into S2 loops (a <code>Loop</code> represents a simple spherical polygon), transforming then into cells using the region coverer, it returns cells of different levels, add them to the segment tree.</p>

<p><img src="https://blog.nobugware.com/img/stree.gif" alt="Segment Tree" title="Segment tree picture fron Wikipedia" /></p>

<p>To query, simply tranform the location into an S2 <code>Cell</code> (level 30) and perform a stubbing query that intersects the segments, every segments crossed are cells that covered a part of a <code>Loop</code>.<br />
It will reduce the problem to test a few <code>Loop</code> vs thousands of them, finally perform <code>ContainsPoint</code> against the found loops cause the point could be inside the <code>Cell</code> but not inside the <code>Loop</code> itself.</p>

<p>Et voilà! It works!</p>

<p>The segment tree structure itself is very low on memory, the loops/polygons data could be stored on disk and loaded on requests, I&rsquo;ve tested a second implementation using LevelDB using this technique.</p>

<p>If you have a very large tree (for example cities limits for the whole world), you can even put the segment tree on a KV storage, using this paper <a href="http://students.ceid.upatras.gr/~patlakas/papers/ICDE13_conf_full_420.pdf">Interval Indexing and Querying on Key-Value Cloud Stores</a>.</p>

<h2 id="region-a-gogo">Region a gogo</h2>

<p>As a demonstration here is a working microservice called <a href="https://github.com/akhenakh/regionagogo">regionagogo</a>, simply returning the country &amp; state for a given location.<br />
It loads geo data for the whole world and answers to HTTP queries using small amout of memory.</p>

<pre><code>GET /country?lat=19.542915&amp;lng=-155.665857

{
    &quot;code&quot;: &quot;US&quot;,
    &quot;name&quot;: &quot;Hawaii&quot;
}
</code></pre>

<p>Here is a <a href="https://hub.docker.com/r/akhenakh/regionagogo/">Docker image</a> so you can deploy it on your stack.</p>

<p>Note that it performs really well but can be improved a lot, for example the actual Go S2 implementation is still using Rect boxing around loops, that&rsquo;s why <a href="https://github.com/akhenakh/regionagogo">regionagogo</a> is using a data file so it can be generated from the C++ version.</p>

<h2 id="future">Future</h2>

<p>This technique seems to work well for stubbing queries, region queries, geofencing &hellip;<br />
It can be a solid foundation to create a flexible and simple geo database.</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">26 Jan 2016, 14:01</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.nobugware.com/post/2016/geo_db_s2_geohash_database/" class="post-title">A fast geo database with Google S2 take #2</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                <a class="post-category post-category-Geo" href="https://blog.nobugware.com/categories/geo">Geo</a><a class="post-category post-category-Golang" href="https://blog.nobugware.com/categories/golang">Golang</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<p>Six months ago, I wrote on this blog about <a href="https://blog.nobugware.com/post/2015/leveldb_geohash_golang/">Geohashes and LevelDB with Go</a>, to create a fast geo database.<br />
This post is very similar as it works the same way but replacing GeoHashes with <a href="http://blog.christianperone.com/2015/08/googles-s2-geometry-on-the-sphere-cells-and-hilbert-curve/">Google S2</a> library for better performances.</p>

<p>There is an <a href="https://github.com/golang/geo">S2 Golang implementation maintened by Google</a> not as complete as the C++ one but close.</p>

<p>For the storage this post will stay agnostic to avoid any troll, but it applies to any Key Value storages: LevelDB/RocksDB, LMDB, Redis&hellip;<br />
I personnaly use <a href="https://github.com/boltdb/bolt">BoltDB</a> and <a href="https://github.com/steveyen/gtreap">gtreap</a> for my experimentations.</p>

<p>This post will focus on Go usage but can be applied to any languages.</p>

<p>Or skip to the images below for visual explanations.</p>

<h2 id="why-not-geohash">Why not Geohash?</h2>

<p>Geohash is a great solution to perform geo coordinates queries but the way it works can sometimes be an issue with your data.</p>

<ul>
<li><p>Remember geohashes are cells of 12 different widths from 5000km to 3.7cm, when you perform a lookup around a position, if your position is close to a cell&rsquo;s edge you could miss some points from the adjacent cell, that&rsquo;s why you have to query for the 8 neightbour cells, it means 9 range queries into your DB to find all the closest points from your location.</p></li>

<li><p>If your lookup does not fit in level <code>4</code> 39km by 19.5km, the next level is 156km by 156km!</p></li>

<li><p>The query is not performed around your coordinates, you search for the cell you are in then you query for the adjacent cells at the same level/radius, based on your needs, it means it works very approximately and you can only perform &lsquo;circles&rsquo; lookup around the cell you are in.</p></li>

<li><p>The most precise geohash needs 12 bytes storage.</p></li>

<li><p>-90 +90 and +180 -180, -0 +0 are not sides by sides prefixes.</p></li>
</ul>

<h2 id="why-s2">Why S2?</h2>

<p>S2 cells have a level ranging from <code>30</code> ~0.7cm² to <code>0</code> ~85,000,000km².<br />
S2 cells are encoded on an uint64, easy to store.</p>

<p>The main advantage is the <strong>region coverer algorithm</strong>, give it a region and the maximum number of cells you want, S2 will return some cells at <strong>different levels that cover the region you asked for</strong>, remember one cell corresponds to a range lookup you&rsquo;ll have to perform in your database.</p>

<p>The coverage is more accurate it means less read from the DB,  less objects unmarshalling&hellip;</p>

<h2 id="real-world-study">Real world study</h2>

<p>We want to query for objects inside Paris city limits using a rectangle:</p>

<p><img src="https://blog.nobugware.com/img/h5.jpg" alt="h5" title="Geohash using level 5" /><br />
Using level 5 we can&rsquo;t fit the left part of the city.<br />
We could add 3 cells (12 total DB queries ) on the left but most algorithms will zoom out to level 4.</p>

<p><img src="https://blog.nobugware.com/img/h4.jpg" alt="h4" title="Geohash using level 4" /><br />
But now we are querying for the whole region.</p>

<p><img src="https://blog.nobugware.com/img/s2.jpg" alt="s2" title="S2 9 cells" /><br />
Using s2 asking for 9 cells using a rectangle around the city limits.</p>

<p><img src="https://blog.nobugware.com/img/h4vss2.jpg" alt="s2 vs h4" title="Geohash vs s2" /><br />
The zones queried by Geohash in pink and S2 in green.</p>

<h2 id="example-s2-storage">Example S2 storage</h2>

<p>Let&rsquo;s say we want to store every cities in the world and perform a lookup to find the closest cities around, first we need to compute the <code>CellId</code> for each cities.</p>

<pre><code class="language-go">// Compute the CellID for lat, lng
c := s2.CellIDFromLatLng(s2.LatLngFromDegrees(lat, lng))

// store the uint64 value of c to its bigendian binary form
key := make([]byte, 8)
binary.BigEndian.PutUint64(key, uint64(c))
</code></pre>

<p>Big endian is needed to order bytes lexicographically, so we can seek later from one cell to the next closest cell on the Hilbert curve.</p>

<p><code>c</code> is a CellID to the level <code>30</code>.</p>

<p>Now we can store <code>key</code> as the key and a value (a string or msgpack/protobuf) for our city, in the database.</p>

<h2 id="example-s2-lookup">Example S2 lookup</h2>

<p>For the lookup we use the opposite procedure, first looking for one CellID.</p>

<pre><code class="language-go">// citiesInCellID looks for cities inside c
func citiesInCellID(c s2.CellID) {
  // compute min &amp; max limits for c
  bmin := make([]byte, 8)
  bmax := make([]byte, 8)
  binary.BigEndian.PutUint64(bmin, uint64(c.RangeMin()))
  binary.BigEndian.PutUint64(bmax, uint64(c.RangeMax()))

  // perform a range lookup in the DB from bmin key to bmax key, cur is our DB cursor
  var cell s2.CellID
  for k, v := cur.Seek(bmin); k != nil &amp;&amp; bytes.Compare(k, bmax) &lt;= 0; k, v = cur.Next() {
    buf := bytes.NewReader(k)
    binary.Read(buf, binary.BigEndian, &amp;cell)

    // Read back a city
    ll := cell.LatLng()
    lat := float64(ll.Lat.Degrees())
    lng := float64(ll.Lng.Degrees())
    name = string(v)
    fmt.Println(lat, lng, name)
  }
}
</code></pre>

<p>Then compute the CellIDs for the region we want to cover.</p>

<pre><code class="language-go">rect := s2.RectFromLatLng(s2.LatLngFromDegrees(48.99, 1.852))
rect = rect.AddPoint(s2.LatLngFromDegrees(48.68, 2.75))

rc := &amp;s2.RegionCoverer{MaxLevel: 20, MaxCells: 8}
r := s2.Region(rect.CapBound())
covering := rc.Covering(r)

for _, c := range covering {
    citiesInCellID(c)
}
</code></pre>

<p>RegionCoverer will return at most 8 cells (in this case 7 cells: 4 <code>8</code>, 1 <code>7</code>, 1 <code>9</code>, 1 <code>10</code>) that is guaranteed to cover the given region, it means we may have to exclude cities that were <strong>NOT</strong> in our <code>rect</code>, with <code>func (Rect) ContainsLatLng(LatLng)</code>.</p>

<p>Congrats we have a working geo db.</p>

<p>S2 can do more with complex shapes like Polygons and includes a lot of tools to compute distances, areas, intersections between shapes&hellip;</p>

<p>Here is a <a href="https://github.com/akhenakh/CompareGeoHashvsS2/blob/master/h4.json">Github repo for the data &amp; scripts generated for the images</a></p>

                    </div>
                </section>
                
                <h1 class="content-subhead">11 Jan 2016, 09:33</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.nobugware.com/post/2016/myaprs_aprs_on_iphone/" class="post-title">MyAPRS APRS for iPhone</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                <a class="post-category post-category-HamRadio" href="https://blog.nobugware.com/categories/hamradio">HamRadio</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p>I&rsquo;m happy to announce a new side project: <a href="http://myaprs.com">MyAPRS</a>, a modern iOS APRS application, for radio amateur enthusiasts.</p>

<p>I&rsquo;ve already mentioned <a href="http://blog.nobugware.com/post/2014/07/28/simple-aprs/">APRS on this blog</a>, it will mainly be useful for radio amateurs but can be interesting to RTL-SDR listeners too.</p>

<p>The application is built around <a href="http://blog.nobugware.com/post/2015/leveldb_geohash_golang/">LevelDB and geo hashing as mentioned in this post blog</a>, it&rsquo;s a lot faster than using SQLite especially on iOS, <a href="http://SatSat.space">SatSat</a> is still using the SQLite cities lookup and you can compare it&rsquo;s terribly slow.<br />
It receives weather data &amp; APRS data from APRS-IS connections, then decodes and stores the packets into LevelDB for indexation.</p>

<p><a href="http://myaprs.com">MyAPRS</a> has some extra features over other applications, like transceiver models detection, so it can highlight all C4FM/Fusion users in your area.<br />
It receives the latest 10mn packets for your area, helped by a small Golang API.</p>

<p>The first release is simple but works very well to discover repeaters and amateurs around you or a region you plan to visit, I&rsquo;ll add position sharing later: due to the way APRS-IS works it&rsquo;s the responsability of the developer to provide passwords &amp; check for the amateur license of the users (even if the algorithm is known publicly&hellip;).</p>

<p>I plan to make it work with <a href="https://github.com/akhenakh/nanoAPRS">some bluetooth modems starting with the one I&rsquo;ve worked on</a> to be used completely off the grid, so we can have a cheap and powerful APRS application, with a real keyboard (try to answer a message with a Yaesu&hellip;).</p>

<p>I had to put some ads in it, a lot of people have asked for a paid <a href="http://SatSat.space">SatSat</a> version to get rid of the ads but that&rsquo;s the only way I can maintain these apps, so I&rsquo;m experimenting with ads for now.</p>

<p>It was a fun project to develop for, I hope you will find a use for it.</p>

<p>73 de KK6NXK</p>

<p><img src="https://blog.nobugware.com/img/myaprspreview.png" alt="MyAPRS" /></p>

                    </div>
                </section>
                
                <h1 class="content-subhead">10 Jan 2016, 11:32</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.nobugware.com/post/2016/freebsd_raspberry_pi2/" class="post-title">Freebsd on Raspberry Pi 2 and Golang</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                <a class="post-category post-category-FreeBSD" href="https://blog.nobugware.com/categories/freebsd">FreeBSD</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<p>FreeBSD is now <a href="https://wiki.freebsd.org/FreeBSD/arm/Raspberry%20Pi">fully supported on the Raspberry Pi2</a>, makes it a fun small computer to experiment with BSD.</p>

<p>If you have a Raspberry Pi 1, you can simply install <a href="ftp://ftp.freebsd.org/pub/FreeBSD/releases/arm/armv6/ISO-IMAGES/10.2/FreeBSD-10.2-RELEASE-arm-armv6-RPI-B.img.xz">10.2-RELEASE image</a>.</p>

<p>For Raspberry Pi 2, you need 11.0-CURRENT which is the development branch, images can be <a href="ftp://ftp.freebsd.org/pub/FreeBSD/snapshots/arm/armv6/ISO-IMAGES/11.0/">found here</a>.</p>

<p><code>dd</code> the image as usual to a SD card, it will be auto resized at first boot. (See <code>growfs_enable=&quot;YES&quot;</code>) in <code>rc.conf</code>.</p>

<h2 id="cpu-frequency">CPU frequency</h2>

<p>To enable on demand cpu overclocking (ranging from 600 to 1000MHz), enable powerd by adding this to <code>rc.conf</code>.</p>

<pre><code>powerd_enable=&quot;YES&quot;
powerd_flags=&quot;-a hadp&quot;
</code></pre>

<h2 id="production-speed">Production speed</h2>

<p>FreeBSD CURRENT is the development version, some debugging tools may slow down your system.</p>

<p>As stated in <a href="https://raw.githubusercontent.com/freebsd/freebsd/master/UPDATING">UPDATING</a> if you are running CURRENT:</p>

<pre><code>ln -s 'abort:false,junk:false' /etc/malloc.conf
</code></pre>

<h2 id="wifi">Wifi</h2>

<p>Depending on your wifi dongle this may be different, for RealTek devices add an entry to <code>/etc/wpa_supplicant.conf</code>:</p>

<pre><code>network={
    ssid=&quot;myssid&quot;
    psk=&quot;mypass&quot;
}
</code></pre>

<p>And this to <code>/etc/rc.conf</code>:</p>

<pre><code>wlans_urtwn0=&quot;wlan0&quot;
ifconfig_wlan0=&quot;WPA SYNCDHCP&quot;
</code></pre>

<p>And this to <code>/boot/loader.conf</code></p>

<pre><code>legal.realtek.license_ack=1
</code></pre>

<p>And type <code>service netif restart</code>.</p>

<h2 id="installing-the-ports">Installing the ports</h2>

<p>The ports are a long list of third parties software you can install on your system, first synchronize the ports tree:</p>

<pre><code>portsnap fetch
portsnap extract
</code></pre>

<p>It&rsquo;s highly recommend you install <code>portmaster</code> to keep your ports updated:</p>

<pre><code>cd /usr/ports/ports-mgmt/portmaster/
make install clean
</code></pre>

<p>To later update your ports tree and ports:</p>

<pre><code>portsnap fetch update
portmaster -a
</code></pre>

<p>To compile and install a port simply go to its directory and run <code>make install clean</code>.</p>

<h2 id="keeping-the-sources-updated-optional">Keeping the sources updated (optional)</h2>

<p>All the FreeBSD sources are available and can be used to recompile the whole system.</p>

<p>Subversion needs some space in <code>/tmp</code> to complete this task, edit <code>/etc/fstab</code> to grow tmpfs to at least 70M the reboot:</p>

<pre><code>tmpfs /tmp tmpfs rw,mode=1777,size=70m 0 0
</code></pre>

<pre><code>cd /usr/ports/security/ca_root_nss
make install clean
svnlite checkout https://svn.FreeBSD.org/base/head /usr/src
</code></pre>

<p>To keep it in sync later, just type:</p>

<pre><code>cd /usr/src
svnlite update
</code></pre>

<p>Keeping your FreeBSD updated can be achieved by recompiling the system aka <a href="https://www.freebsd.org/doc/en/books/handbook/makeworld.html">make world</a>, note that this could take a long time on a Raspberry Pi but still doable (remember to use <code>make -j 4</code> on RPi2).</p>

<h2 id="installing-go-optional">Installing Go (optional)</h2>

<p>If you are into Go and need a recent version, first you need to compile Go 1.4 as a bootstraper (note that you also need to install <code>git</code>):</p>

<pre><code>cd /usr/ports/lang/go14
make install clean
</code></pre>

<p>Then you can compile a more recent Go, for example using <code>/usr/local/go</code>:</p>

<pre><code>cd /usr/local
git clone https://go.googlesource.com/go
cd go/src
env TMPDIR=/var/tmp GOARM=7 GOROOT_BOOTSTRAP=/usr/local/go14 ./all.bash
</code></pre>

<p>Add <code>/usr/local/go/bin</code> to your <code>PATH</code>.</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">09 Nov 2015, 18:51</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.nobugware.com/post/2015/listening_to_satellites_for_30_dollars/" class="post-title">Listening to satellites for 30 dollars</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                <a class="post-category post-category-HamRadio" href="https://blog.nobugware.com/categories/hamradio">HamRadio</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<p>I&rsquo;ve ever dreamed of space &amp; satellites, it turms out you can received pictures from them.<br />
After getting my radio amateur license in the US, I&rsquo;ve discovered there was some satellites dedicated to radio amateurs but also some weather satellites from the late 90s still working and capable of sending pictures from the space like this one <a href="https://en.wikipedia.org/wiki/NOAA-15">NOOA-15</a>.</p>

<h2 id="sdr">SDR</h2>

<p>You don&rsquo;t need expensive hardware anymore thanks to the <a href="https://en.wikipedia.org/wiki/Software-defined_radio">SDR movement Software defined radio</a> and some great developers, a <a href="http://www.amazon.com/NESDR-Mini-Compatible-Packages-Guaranteed/dp/B00P2UOU72/ref=sr_1_1?ie=UTF8&amp;qid=1438740302&amp;sr=8-1&amp;keywords=nooelec">simple 20$ USB</a> key and some pratices are good enough to make it work.</p>

<h2 id="software">Software</h2>

<p>There is plenty of softwares available but the ones I&rsquo;m using for OSX or Linux are:</p>

<ul>
<li><a href="http://gqrx.dk/">GQRX</a> the software receiver</li>
<li><a href="http://web.audacityteam.org/">Audacity</a> for sounds editing</li>
<li><a href="http://rogueamoeba.com/freebies/soundflower/">Soundflower</a> (OSX only) to reroute the sound from GQRX to Audacity, but you can do that with pulseaudio on Linux.<br /></li>
</ul>

<p>They are all free.</p>

<h2 id="know-what-when-and-where-to-listen">Know what, when and where to listen</h2>

<p>The most important things to know is what frequency and when to listen to.<br />
For that you need a software for passes prediction, I have developed an app for iOS devices called <a href="https://itunes.apple.com/us/app/satsat/id1017063968?ls=1&amp;mt=8">SatSat</a>, it&rsquo;s free (with ads), hoping enough people could be interested I&rsquo;ll invest more into the product.</p>

<p><img src="https://blog.nobugware.com/img/satsat.png" alt="SatSat" /></p>

<p>Good satellites candidates for a start, some weather satellites, are:</p>

<ul>
<li>NOAA-15</li>
<li>NOAA-18</li>
<li>NOAA-19</li>
</ul>

<p>Experiment with GQRX options:<br />
Receiver options -&gt; Mode Narrow FM -&gt; Mode options -&gt; Max Dev APT 17k -&gt; Tau OFF.<br />
Record in mono inside Audacity at 11025Hz.</p>

<p>With the sound you just recorded, open it inside <a href="http://www.wxtoimg.com">WXtoImg</a>.</p>

<p>Cities are really noisy, expect best results outdoor, sometimes a simple wire antenna is enough for great results.</p>

<p>Here is an example of a weather satellite:<br />
<img src="https://blog.nobugware.com/img/satpreview.png" alt="Sat view" /></p>

<p>And this is the &ldquo;sound&rdquo; of a satellite:

<div class="embed soundcloud-player">
        <iframe width="100%" height="450" scrolling="no" frameborder="no" src="https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/222055837&amp;auto_play=false&amp;hide_related=false&amp;show_comments=true&amp;show_user=true&amp;show_reposts=false&amp;visual=true"></iframe>
    </iframe>
</div>
</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">30 Aug 2015, 18:25</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.nobugware.com/post/2015/leveldb_geohash_golang/" class="post-title">A blazing fast geo database with LevelDB, Go and Geohashes</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                <a class="post-category post-category-Geo" href="https://blog.nobugware.com/categories/geo">Geo</a><a class="post-category post-category-Golang" href="https://blog.nobugware.com/categories/golang">Golang</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p>You probably have heard of <a href="https://github.com/google/leveldb">LevelDB</a> it’s a blazing fast key value store (as a library not a daemon), that uses Snappy compression.<br />
There is plenty of usages for it, the API is very simple at least in Go (I will be using <a href="https://github.com/syndtr/goleveldb">Goleveldb</a>).</p>

<p>The key is a <code>[]byte</code> the value is a <code>[]byte</code> so you can “get”, “put” &amp; “delete” that’s it.</p>

<p>I needed a low memory low cpu system that could collect millions of geo data and query over them,  <a href="https://en.wikipedia.org/wiki/Geohash">Geohash</a> has an interesting property you can encode longitude and latitude into a string : <code>f2m616nn</code> this hash represents the lat &amp; long 46.770, -71.304 <a href="http://geohash.org/f2m616nn">f2m616nn</a>, if you shorten the string to <code>f2m61</code> it still refers to the same lat &amp; long but with less precisions <a href="http://geohash.org/f2m61">f2m61</a>.<br />
A 4 digits hash leads to 19545 meters precision, to perfom a lookup around a position you simply query for the 8 adjacent blocks. <a href="http://github.com/TomiHiltunen/geohash-golang">A Geohash library for Go</a>.</p>

<p>Here you would store all of your data points matching a geohash to the same set.<br />
Problem there is no such thing as a set in LevelDB.</p>

<p>But there is a cursor so you can seek to a position then iterate over the next or previous one (byte ordered).<br />
So your data could be stored that way:  4 digits geohash + a uniq id.</p>

<p>Then you can perform proximity lookup by searching for the 8 adjacents hashes from the position your are looking with a precision of 20km, good but not very flexible.</p>

<p>We can have a more generic solution, first we need a key a simple int64 uniq id.</p>

<pre><code class="language-go">// NewKey generates a new key using time prefixed by 'K'
func NewKey() Key {
	return NewKeyWithInt(time.Now().UnixNano())
}

// NewKeyWithInt returns a key prefixed by 'K' with value i
func NewKeyWithInt(id int64) Key {
	key := bytes.NewBufferString(&quot;K&quot;)
	binary.Write(key, binary.BigEndian, id)
	return key.Bytes()
}
</code></pre>

<p>Here we can encode a key with a Unix timestamp so our key is not just a key it’s also an encoded time value, it will be uniq thanks to the nanosecond precision. We are using BigEndian so it can be byte compared: older will be before newer after.</p>

<p>Now about geo encoding our key will be of the form:<br />
<code>G201508282105dhv766K��Ϸ�Y�</code>  (note the end of the key is binary encoded)
You always need a prefix for your keys so you can seek and browse them without running over different keys types, here I have a <code>G</code> as Geo, then a string encoded date prefix, so we can search by date, but we don’t want extra precision here, it would add extra seek to LevelDB, (that’s why we have a modulo of 10 for minutes) then we add a precise geohash and finally our previous uniq id.</p>

<pre><code class="language-go">// NewGeoKey generates a new key using a position &amp; a key
func NewGeoKey(latitude, longitude float64) GeoKey {
	t := time.Now().UTC()
	kint := t.UnixNano()
	kid := NewKeyWithInt(kint)
	// G + string date + geohash 6 + timestamped key 
	// G201508282105dhv766K....
	gk := geohash.EncodeWithPrecision(latitude, longitude, 6)
	ts := t.Format(&quot;2006010215&quot;)

	// modulo 10 to store 10mn interval
	m := t.Minute() - t.Minute()%10
	zkey := []byte(&quot;G&quot; + ts + fmt.Sprintf(&quot;%02d&quot;, m) + gk)
	zkey = append(zkey, kid...)
	return zkey
}
</code></pre>

<p>We can now lookup by flexible date &amp; by flexible proximity like a Redis ZRANGE, you simply need to reverse the process.</p>

<pre><code class="language-go">// GeoKeyPrefix return prefixes to lookup using a GeoKey and timerange
func GeoKeyPrefix(start, stop time.Time) []string {
	var res []string
	d := 10 * time.Minute
	var t time.Time
	t = start
	for {
		if t.After(stop) {
			break
		}

		key := &quot;G&quot; + t.Format(&quot;2006010215&quot;) + fmt.Sprintf(&quot;%02d&quot;, t.Minute()-t.Minute()%10)
		res = append(res, key)
		t = t.Add(d)
	}
	return res
}
</code></pre>

<p>Lookup that way:</p>

<pre><code class="language-go">	d := time.Duration(-10) * time.Minute
	geoPrefixs := GeoKeyPrefix(time.Now().UTC().Add(d), time.Now().UTC())

	// find adjacent hashes in m
	// 1, 5003530
	// 2, 625441
	// 3, 123264
	// 4, 19545
	// 5, 3803
	// 6, 610
	gk := geohash.EncodeWithPrecision(lat, long, 4)
	adjs := geohash.CalculateAllAdjacent(gk)
	adjs = append(adjs, gk)

	// for each adjacent blocks
	for _, gkl := range adjs {

		// for each time range modulo 10
		for _, geoPrefix := range geoPrefixs {
			startGeoKey := []byte(geoPrefix + gkl)
			iter := s.NewIterator(util.BytesPrefix(startGeoKey), nil)

			for iter.Next() {
				log.Println(iter.Value())
			}
			iter.Release()
		}
	}
</code></pre>

<p>It can be optimized, reducing the size of the keys, but it performs extremely well storing around 3 millions geopoints per day, using less than 3% cpu and can received hundreds of queries per second.</p>

<p>Oh did I forget to mention it&rsquo;s running on a Raspberry Pi? :)</p>

<p>I could maybe turn it into a library but it&rsquo;s so simple it&rsquo;s probably useless.<br />
Next blog post: what are those millions points used for?</p>

                    </div>
                </section>
                
            </div>
            
<div class="pagination">
  <nav role="pagination" class="post-list-pagination">
      
      <a href="https://blog.nobugware.com/page/2/" class="post-list-pagination-item pure-button post-list-pagination-item-prev">
        <i class="fa fa-angle-double-left"></i>&nbsp;Newer
      </a>
      
    <span class="post-list-pagination-item post-list-pagination-item-current">Page 3 of 9</span>
    
      <a href="https://blog.nobugware.com/page/4/" class="post-list-pagination-item pure-button post-list-pagination-item-next">
        Older&nbsp;<i class="fa fa-angle-double-right"></i>
      </a>
    
  </nav>
</div>


            <div class="footer">
    <div class="pure-menu pure-menu-horizontal pure-menu-open">
        <ul>
            <li>Powered by <a class="hugo" href="http://hugo.spf13.com/" target="_blank">hugo</a></li>
        </ul>
    </div>
</div>
<script src="https://blog.nobugware.com/js/all.min.js"></script>
        </div>
    </div>
</div>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-1245966-1', 'auto');
ga('send', 'pageview');

</script>

</body>
</html>
