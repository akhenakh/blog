<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>gentoo &middot; Fabrice Aneche</title>

    <meta name="description" content="">

    <meta name="generator" content="Hugo 0.55.3" />
    <meta name="twitter:card" content="summary">
    
    <meta name="twitter:title" content="gentoo &middot; Fabrice Aneche">
    <meta name="twitter:description" content="">

    <meta property="og:type" content="article">
    <meta property="og:title" content="gentoo &middot; Fabrice Aneche">
    <meta property="og:description" content="">

    <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700|Oxygen:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/pure-min.css">
    <!--[if lte IE 8]>
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-old-ie-min.css">
    <![endif]-->
    <!--[if gt IE 8]><!-->
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-min.css">
    <!--<![endif]-->

    <link rel="stylesheet" href="https://blog.nobugware.com/css/all.min.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">

    <link rel="alternate" type="application/rss+xml" title="Fabrice Aneche" href="https://blog.nobugware.com/index.xml" />
    <link href="https://blog.nobugware.com/css/prism.css" rel="stylesheet" />
</head>
<body>


<div id="layout" class="pure-g">
    <div class="sidebar pure-u-1 pure-u-md-1-4">
    <div class="header">
        <hgroup>
            <h1 class="brand-title"><a href="https://blog.nobugware.com">Fabrice Aneche</a></h1>
            <h2 class="brand-tagline"></h2>
        </hgroup>

        <nav class="nav">
            <ul class="nav-list">
                
                <li class="nav-item">
                    <a class="pure-button" href="http://www.nobugware.com"><i class="fa fa-building-o"></i> Hiring</a>
                </li>
                
                
                <li class="nav-item">
                    <a class="pure-button" href="https://twitter.com/akhenakh"><i class="fa fa-twitter"></i> Twitter</a>
                </li>
                
                
                <li class="nav-item">
                    <a class="pure-button" href="https://github.com/akhenakh "><i class="fa fa-github-alt"></i> github</a>
                </li>
                
                <li class="nav-item">
                    <a class="pure-button" href="https://blog.nobugware.com/index.xml"><i class="fa fa-rss"></i> rss</a>
                </li>
            </ul>
        </nav>
    </div>
</div>


    <div class="content pure-u-1 pure-u-md-3-4">
        <div>
            
            <div class="posts">
                
                <h1 class="content-subhead">02 Feb 2011, 22:06</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.nobugware.com/post/2011/02/02/gentoo-lvmraid-root/" class="post-title">Gentoo lvm&#43;raid root</a>

                        <p class="post-meta">
                            
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p>Gentoo support for lvm root is still a pain in the ass, here is a working
solution.</p>

<p>Assuming you have 2 disks same size to be mirrored.</p>

<p>You want a mirrored /boot and a big lvm.</p>

<p>Start a normal gentoo installation with this disks layout:</p>

<pre><code>fdisk -l /dev/sda
   Device Boot      Start         End      Blocks   Id  System
/dev/sda1   *           1          31      248976   fd  Linux raid autodetect
/dev/sda2              32      242246  1945591987+  fd  Linux raid autodetect

fdisk -l /dev/sdb
   Device Boot      Start         End      Blocks   Id  System
/dev/sdb1   *           1          31      248976   fd  Linux raid autodetect
/dev/sdb2              32      242246  1945591987+  83  Linux raid autodetect
</code></pre>

<p>Set both disk the boot flags on the first partition and set all partitions to
FD Linux raid autodetect.</p>

<pre><code>mdadm --create /dev/md0 --level=1 --raid-devices=2 /dev/sda1 /dev/sdb1
mdadm --create /dev/md1 --level=1 --raid-devices=2 /dev/sda2 /dev/sdb2
</code></pre>

<p>If it complains about another array by this is name is already running or disk
used.</p>

<p>First stop them all:</p>

<pre><code>cat /proc/mdstat
</code></pre>

<p>Identify the old arrays then stop it:</p>

<pre><code>mdadm --stop /dev/md??
</code></pre>

<p>Clean the partition if necessaray</p>

<pre><code>dd if=/dev/zero of=/dev/sda1 count=100 bs=1024
dd if=/dev/zero of=/dev/sda1 count=100 bs=1024
</code></pre>

<p>Create the boot:</p>

<pre><code>mkfs.ext3 /dev/md0
</code></pre>

<p>Create the lvm root and swap:</p>

<pre><code>pvcreate /dev/md1
vgcreate vg0 /dev/md1
lvcreate  -L10G -nroot vg0
lvcreate  -L16G -nswap vg0
# set the minfree to 0 and increase the number of inodes to 600k
mkfs.ext4 -m0 -N 600000  /dev/vg0/root
mkswap /dev/vg0/swap
</code></pre>

<p>Mount them all !</p>

<pre><code>mount /dev/vg0/root /mnt/gentoo
mkdir /mnt/gentoo/boot
mount /dev/md0 /mnt/gentoo/boot
</code></pre>

<p>Continue with the standard install procedure, mount -t proc &hellip;</p>

<p>After the emerge &ndash;sync in the install procedure get back here:</p>

<pre><code>emerge lvm2 dmadm genkernel
emerge gentoo-sources
mdadm --examine --scan &gt;&gt; /etc/mdadm.conf
</code></pre>

<p>Edit /etc/genkernel.conf:</p>

<p>Set LVM=&ldquo;yes&rdquo;</p>

<p>Set MDADM=&ldquo;yes&rdquo;</p>

<p>Edit /etc/fstab</p>

<pre><code>/dev/md0        /boot       ext3        noauto,noatime  1 2
/dev/vg0/root       /       ext4        noatime     0 1
/dev/vg0/swap       none        swap        sw      0 0
</code></pre>

<p>Compile your kernel with genkernel (note that if you want to compile your own
kernel without genkernel this is possible with the command genkernel
initramfs).</p>

<pre><code>genkernel --menuconfig all
</code></pre>

<p>Continue to normal procedure until grub, apply grub on both disks:</p>

<pre><code>grub&gt; root (hd0,0) 
grub&gt; setup (hd0)   
grub&gt; root (hd2,0) 
grub&gt; setup (hd1)   
grub&gt; quit           
</code></pre>

<p>Then edit grub.conf</p>

<pre><code>title Gentoo
root (hd0,0)
kernel /boot/kernel-genkernel-x86_64-2.6.36-gentoo-r5 root=/dev/ram0 real_root=/dev/vg0/root dolvm domdadm lvmraid=/dev/md1
initrd /boot/initramfs-genkernel-x86_64-2.6.36-gentoo-r5
</code></pre>

<p>Explanation, for lvm to find his disks, we need a ramfs with the static lvm
command, but to find back our raids md we also need mdadm to save the config
somewhere, that&rsquo;s exactly what the genkernel initramfs is doing.</p>

<p>Then we invoke the kernel with ramfs and domdadm dolvm and lvmraid.</p>

<p>You can use the initramfs with your own kernel, you only have to be sure all
needed hardware drivers to detect the disks are in the kernel, and not as
modules.</p>

<p>Remember that when gentoo stable will update to baselayout2 you will have to
add rc-update add mdraid boot.</p>

<p>EDIT: on recent Gentoo I have to add this to kernel boot line:</p>

<pre><code>kernel /boot/kernel-genkernel-x86_64-3.1.10-gentoo-r1 root=/dev/ram0 init=/linuxrc real_root=/dev/vg0/root udev dolvm domdadm gentoo=nodevfs lvmraid=/dev/md1 rootfstype=ext4
</code></pre>

                    </div>
                </section>
                
                <h1 class="content-subhead">31 Jul 2009, 10:37</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.nobugware.com/post/2009/07/31/python-26-gentoo-stable/" class="post-title">Python 2.6 in Gentoo stable</a>

                        <p class="post-meta">
                            
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p>It was so long but python 2.6 is now in Gentoo stable, here is how to upgrade.</p>

<p>First <em>emerge &ndash;sync</em> your ports tree (as of 31st July 2009).</p>

<p>Then update your ports _emerge -upvD world _remove -p when ready.</p>

<p>When emerging python-2.6.2 it will become the main python, as you can see with
<em>eselect python list.</em></p>

<p><em>So you only have to rebuild every ports that rely on python, simple ? Yes
with python-update</em></p>

<p><em>Just run python-update It will run all the needed emerge for you (40 ports on
my server)</em></p>

<p>_Remove the old python version(s) with emerge &ndash;prune python _(Note that
removal is not mandatory, old python interpreter could coexists).</p>

<p>_Run revdep-rebuild _to be sure there is no remaining tools that depends on
libpython2.5, then you are done, restart your apache, daemons, whatever is in
Python.</p>

<p>Happy Python.</p>

<p>PS: if you are using postgresql-8.3 as stable, you will have some problems
with egenix-mx-base: a package needed by postgresql-server</p>

<p>dev-db/postgresql-server-8.3.7 (python? dev-python/egenix-mx-base)</p>

<p>There is a &ldquo;with&rdquo; parameter in a function, in 2.6 witch is a reserved keyword
solution was to update to &gt;=dev-python/egenix-mx-base-3.1.1.</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">03 Dec 2008, 10:32</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.nobugware.com/post/2008/12/03/gentoo-bref-recap-des-commandes-de-gestion-de-paquets/" class="post-title">Gentoo bref r√©cap des commandes de gestion de paquets</a>

                        <p class="post-meta">
                            
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p>Avant toute chose installer l&rsquo;outil gentoolkit</p>

<p><code>emerge -av gentoolkit</code></p>

<p>Ces nouvelles commandes vont vous permettre de:</p>

<p>A quel port appartient un binaire:</p>

<pre><code> equery belongs cjpeg
 [ Searching for file(s) cjpeg in *... ] 
media-libs/jpeg-6b-r8 (/usr/bin/cjpeg) 
</code></pre>

<p>Quels sont les dependances d&rsquo;un port:</p>

<pre><code>equery depends gd
[ Searching for packages depending on gd... ]
dev-lang/php-5.2.6-r7 (gd-external? media-libs/gd)
</code></pre>

<p>Quels sont les fichiers installes par un package:</p>

<pre><code> equery files less
[ Searching for packages matching less... ]
* Contents of sys-apps/less-418:
/etc
/etc/env.d
/etc/env.d/70less
/usr
/usr/bin
/usr/bin/code2color
/usr/bin/less
/usr/bin/lessecho
/usr/bin/lesskey
/usr/bin/lesspipe.sh
/usr/share
/usr/share/doc
/usr/share/doc/less-418
/usr/share/doc/less-418/NEWS.bz2
/usr/share/doc/less-418/README.Gentoo.bz2
/usr/share/doc/less-418/README.bz2
/usr/share/man
/usr/share/man/man1
/usr/share/man/man1/less.1.bz2
/usr/share/man/man1/lessecho.1.bz2
/usr/share/man/man1/lesskey.1.bz2
</code></pre>

<p>Mettre a jour vos machines en s&rsquo;assurant que tous les USE soient respectes, si
vous changez une variable USE en ajoutant mysql par exemple, il est en theorie
necessaire de recompiler tous les packages qui peuvent avoir ce use flag, puis
enlever le &ndash;pretent</p>

<p><code>emerge --update --deep --newuse world --pretend</code></p>

<p>Verifier que chaque binaire reference une librairie encore existante sur votre
syseme:</p>

<p>Apres une mise a jour il se peut par exemple que la libgdbm ai change de
revision majeure libgdbm.so.3, un binaire linke a cette librairie en
libgdbm.so.2 ne fonctionnera plus, c&rsquo;est le role de <em>revdep-rebuild</em> de
retrouver quels binaires doivent etre recompile.</p>

<p>Enlever les versions obsoletes d&rsquo;un package:</p>

<p><code>emerge --prune gentoo-sources</code></p>

                    </div>
                </section>
                
            </div>
            

            <div class="footer">
    <div class="pure-menu pure-menu-horizontal pure-menu-open">
        <ul>
            <li>Powered by <a class="hugo" href="http://hugo.spf13.com/" target="_blank">hugo</a></li>
        </ul>
    </div>
</div>
<script src="https://blog.nobugware.com/js/all.min.js"></script>
        </div>
    </div>
</div>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-1245966-1', 'auto');
ga('send', 'pageview');

</script>

</body>
</html>
