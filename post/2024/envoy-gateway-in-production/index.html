<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=generator content="Hugo 0.89.4">
<title>Envoy Gateway In Production - Fabrice Aneche</title>
<meta name=description content="Envoy Gateway In Production Tips to Manages Envoy Proxy with Envoy Gateway in Kubernetes">
<link rel=stylesheet href=https://blog.nobugware.com/css/ui.css>
<link rel=stylesheet href="https://fonts.googleapis.com/css?family=Fira+Mono|Lato|Raleway">
</head>
<body>
<header class="container no-print">
<div class=u-header>
<nav class=bar>
<ul><li>
<a href=https://blog.nobugware.com/>
<img class=icon-text src=https://blog.nobugware.com/img/prev.svg>
</a>
</li><li><a href=https://blog.nobugware.com/about>About</a></li><li><a href=https://blog.nobugware.com/post/>Post</a></li></ul>
</nav>
</div>
</header>
<main class=container>
<article>
<header><hgroup id=brand>
<h1>Envoy Gateway In Production</h1>
<h5>
<time datetime="2024-02-05 20:01:00 +0000 UTC">Feb 05, 2024</time>
<span class=no-print>
-
<a href=https://blog.nobugware.com/tags/kubernetes>kubernetes</a>
<a href=https://blog.nobugware.com/tags/envoy>envoy</a>
<a href=https://blog.nobugware.com/tags/proxy>proxy</a>
<a href=https://blog.nobugware.com/tags/gateway>gateway</a>
<span>
</h5>
</hgroup>
<hr class=sep>
</header>
<p><a href=https://blog.nobugware.com/post/2023/envoy-gateway-new-gateway-api-kubernetes/>Previous post</a> was about discovering a new offer in the Kubernetes Gateway space <a href=https://gateway.envoyproxy.io/>Envoy Gateway</a>, in this one I&rsquo;ll share some notes to make it to production.</p>
<p>Envoy Gateway is still rough on the edges, but remember Gateway is mainly a Kubernetes API frontend to provision Envoy Proxy, Envoy Proxy configuration can still be patched to enable a specific feature.</p>
<h2 id=enable-patching>Enable Patching</h2>
<p>Patching is not enabled by default, create this configmap if you need it:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ConfigMap</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>envoy-gateway-config</span>
  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>envoy-gateway-system</span>
<span style=color:#f92672>data</span>:
  <span style=color:#f92672>envoy-gateway.yaml</span>: |<span style=color:#e6db74>
</span><span style=color:#e6db74>    apiVersion: gateway.envoyproxy.io/v1alpha1
</span><span style=color:#e6db74>    kind: EnvoyGateway
</span><span style=color:#e6db74>    provider:
</span><span style=color:#e6db74>      type: Kubernetes
</span><span style=color:#e6db74>    gateway:
</span><span style=color:#e6db74>      controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span><span style=color:#e6db74>    extensionApis:
</span><span style=color:#e6db74>      enableEnvoyPatchPolicy: true</span>    
</code></pre></div><h2 id=compression>Compression</h2>
<p>This very basic functionality is not enabled by default with 0.6.0 Gateway.</p>
<p>This is a patch for an HTTPS listener, the path to patch is different for HTTP <code>"/default_filter_chain/filters/0/typed_config/http_filters/0"</code>)</p>
<p>Example patch to enable compression:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>gateway.envoyproxy.io/v1alpha1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>EnvoyPatchPolicy</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>compressor-patch-policy</span>
  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>envoy-gateway-system</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>targetRef</span>:
    <span style=color:#f92672>group</span>: <span style=color:#ae81ff>gateway.networking.k8s.io</span>
    <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Gateway</span>
    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>eg</span>
    <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>envoy-gateway-system</span>
  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>JSONPatch</span>
  <span style=color:#f92672>jsonPatches</span>:
    - <span style=color:#f92672>type</span>: <span style=color:#e6db74>&#34;type.googleapis.com/envoy.config.listener.v3.Listener&#34;</span>
      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>envoy-gateway-system/eg/https</span>
      <span style=color:#f92672>operation</span>:
        <span style=color:#f92672>op</span>: <span style=color:#ae81ff>add</span>
        <span style=color:#f92672>path</span>: <span style=color:#e6db74>&#34;/filter_chains/0/filters/0/typed_config/http_filters/0&#34;</span>
        <span style=color:#f92672>value</span>:
          <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;envoy.filters.http.compressor&#34;</span>
          <span style=color:#f92672>typed_config</span>:
            <span style=color:#f92672>&#34;@type&#34;: </span><span style=color:#e6db74>&#34;type.googleapis.com/envoy.extensions.filters.http.compressor.v3.Compressor&#34;</span>
            <span style=color:#f92672>compressor_library</span>:
              <span style=color:#f92672>name</span>: <span style=color:#ae81ff>text_optimized</span>
              <span style=color:#f92672>typed_config</span>:
                <span style=color:#f92672>&#34;@type&#34;: </span><span style=color:#e6db74>&#34;type.googleapis.com/envoy.extensions.compression.gzip.compressor.v3.Gzip&#34;</span>
                <span style=color:#f92672>compression_level</span>: <span style=color:#ae81ff>BEST_SPEED</span>
                <span style=color:#f92672>compression_strategy</span>: <span style=color:#ae81ff>DEFAULT_STRATEGY</span>
                <span style=color:#f92672>memory_level</span>: <span style=color:#ae81ff>8</span>
                <span style=color:#f92672>window_bits</span>: <span style=color:#ae81ff>15</span>
                <span style=color:#f92672>chunk_size</span>: <span style=color:#ae81ff>4096</span>
            <span style=color:#f92672>response_direction_config</span>:
              <span style=color:#f92672>remove_accept_encoding_header</span>: <span style=color:#66d9ef>true</span>
              <span style=color:#f92672>common_config</span>:
                <span style=color:#f92672>enabled</span>:
                  <span style=color:#f92672>default_value</span>: <span style=color:#66d9ef>true</span>
                  <span style=color:#f92672>runtime_key</span>: <span style=color:#ae81ff>response_direction_config_enabled</span>
                <span style=color:#f92672>content_type</span>:
                  - <span style=color:#e6db74>&#34;application/javascript&#34;</span>
                  - <span style=color:#e6db74>&#34;application/json&#34;</span>
                  - <span style=color:#e6db74>&#34;application/x-web-app-manifest+json&#34;</span>
                  - <span style=color:#e6db74>&#34;application/xhtml+xml&#34;</span>
                  - <span style=color:#e6db74>&#34;application/xml&#34;</span>
                  - <span style=color:#e6db74>&#34;font/opentype&#34;</span>
                  - <span style=color:#e6db74>&#34;image/svg+xml&#34;</span>
                  - <span style=color:#e6db74>&#34;image/x-icon&#34;</span>
                  - <span style=color:#e6db74>&#34;text/css&#34;</span>
                  - <span style=color:#e6db74>&#34;text/html&#34;</span>
                  - <span style=color:#e6db74>&#34;text/plain&#34;</span>
                  - <span style=color:#e6db74>&#34;text/xml&#34;</span>
                <span style=color:#f92672>min_content_length</span>: <span style=color:#ae81ff>60</span>
            <span style=color:#f92672>request_direction_config</span>:
              <span style=color:#f92672>common_config</span>:
                <span style=color:#f92672>enabled</span>:
                  <span style=color:#f92672>default_value</span>: <span style=color:#66d9ef>false</span>
                  <span style=color:#f92672>runtime_key</span>: <span style=color:#ae81ff>request_direction_config_enabled</span>
</code></pre></div><p>You should see a response with an <code>content-encoding: gzip</code> header for an HTTP/1.1 request with a <code>Accept-Encoding: deflate, gzip</code> header.</p>
<p>It should be easier in future releases <a href=https://github.com/envoyproxy/gateway/pull/2474>with this PR</a>.</p>
<h2 id=logging>Logging</h2>
<p>To enable JSON logging:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>gateway.envoyproxy.io/v1alpha1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>EnvoyProxy</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>custom-proxy-config</span>
  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>envoy-gateway-system</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>telemetry</span>:
    <span style=color:#f92672>accessLog</span>:
      <span style=color:#f92672>settings</span>:
        - <span style=color:#f92672>format</span>:
            <span style=color:#f92672>type</span>: <span style=color:#ae81ff>JSON</span>
            <span style=color:#f92672>json</span>:
              <span style=color:#f92672>authority</span>: <span style=color:#e6db74>&#34;%REQ(:AUTHORITY)%&#34;</span>
              <span style=color:#f92672>bytes_received</span>: <span style=color:#e6db74>&#34;%BYTES_RECEIVED%&#34;</span>
              <span style=color:#f92672>bytes_sent</span>: <span style=color:#e6db74>&#34;%BYTES_SENT%&#34;</span>
              <span style=color:#f92672>duration</span>: <span style=color:#e6db74>&#34;%DURATION%&#34;</span>
              <span style=color:#f92672>method</span>: <span style=color:#e6db74>&#34;%REQ(:METHOD)%&#34;</span>
              <span style=color:#f92672>path</span>: <span style=color:#e6db74>&#34;%REQ(X-ENVOY-ORIGINAL-PATH?:PATH)%&#34;</span>
              <span style=color:#f92672>status</span>: <span style=color:#e6db74>&#34;%RESPONSE_CODE%&#34;</span>
              <span style=color:#f92672>upstream_host</span>: <span style=color:#e6db74>&#34;%UPSTREAM_HOST%&#34;</span>
              <span style=color:#f92672>user_agent</span>: <span style=color:#e6db74>&#34;%REQ(USER-AGENT)%&#34;</span>
              <span style=color:#f92672>x_forwarded_for</span>: <span style=color:#e6db74>&#34;%REQ(X-FORWARDED-FOR)%&#34;</span>
              <span style=color:#f92672>x_request_id</span>: <span style=color:#e6db74>&#34;%REQ(X-REQUEST-ID)%&#34;</span>
              <span style=color:#f92672>cluster</span>: <span style=color:#e6db74>&#34;%UPSTREAM_CLUSTER%&#34;</span>
          <span style=color:#f92672>sinks</span>:
            - <span style=color:#f92672>type</span>: <span style=color:#ae81ff>File</span>
              <span style=color:#f92672>file</span>:
                <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/dev/stdout</span>
</code></pre></div><p>Note the <code>cluster</code> field, it will really help debugging your installation, it will generate the path to the actual container:
<code>"cluster":"httproute/mycontainer/mycontainer-backend-open-0/rule/0"</code></p>
<h2 id=cors>CORS</h2>
<p>Enabling CORS is <a href=https://gateway.envoyproxy.io/v0.6.0/user/cors/>well documented</a> but one detail was missing, if for some reasons the routes are matching on methods (<code>GET</code>,<code>PUT</code> &mldr;), Envoy Proy won&rsquo;t be able to respond to preflights HTTP requests, since they are using <code>OPTIONS</code>:</p>
<p>The documentation has been updated to reflect that:
<em>The targeted HTTPRoute or the HTTPRoutes that the targeted Gateway routes to must allow the OPTIONS method for the CORS filter to work. Otherwise, the OPTIONS request won&rsquo;t match the routes and the CORS filter won&rsquo;t be invoked.</em></p>
<h2 id=regex-match>Regex Match</h2>
<p>By default, Envoy Proxy is using a very small limit for the regex complexity, it means a very simple regex may be rejected.<br>
Envoy Gateway (as of 0.6.0) does not increase that value, you should probably do it by changing the default bootstrap config.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>gateway.envoyproxy.io/v1alpha1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>EnvoyProxy</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>custom-proxy-config</span>
  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>envoy-gateway-system</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>provider</span>:
    <span style=color:#f92672>type</span>: <span style=color:#ae81ff>Kubernetes</span>
    <span style=color:#f92672>kubernetes</span>:
      <span style=color:#f92672>envoyDeployment</span>:
        <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>1</span>
  <span style=color:#f92672>bootstrap</span>:
    <span style=color:#f92672>type</span>: <span style=color:#ae81ff>Merge</span>
    <span style=color:#f92672>value</span>: |<span style=color:#e6db74>
</span><span style=color:#e6db74>      layered_runtime:
</span><span style=color:#e6db74>        layers:
</span><span style=color:#e6db74>        - name: &#34;static-runtime&#34;
</span><span style=color:#e6db74>          static_layer:
</span><span style=color:#e6db74>            re2.max_program_size.error_level: 1000</span>      
</code></pre></div><p>The error message would be something like this:</p>
<pre tabindex=0><code>[2024-01-30 17:38:22.851][1][warning][config] [source/extensions/config_subscription/grpc/grpc_subscription_impl.cc:138] gRPC config for type.googleapis.com/envoy.config.route.v3.RouteConfiguration rejected: regex '^\/v1\/myapi\/([0-9a-z-]{36})\/blah$' RE2 program size of 120 &gt; max program size of 100 set for the error level threshold. Increase configured max program size if necessary.
</code></pre><p>It could be a huge issue, if for some reasons Envoy is restarting, <strong>it will respond with 404 for all the routes</strong> until the route is removed or the threshold is increased.</p>
<p>Tracking the <a href=https://github.com/envoyproxy/gateway/issues/2543>issue</a>.</p>
<h2 id=external-authorization-authz>External Authorization (Authz)</h2>
<p>I&rsquo;m running a <a href=https://github.com/akhenakh/gateway/tree/ext_authz>0.6.0 fork</a> with gRPC authz enabled.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>gateway.envoyproxy.io/v1alpha1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>SecurityPolicy</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>myapp-back-policy</span>
  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>myapp</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>extAuthz</span>:
    <span style=color:#f92672>grpcURI</span>: <span style=color:#ae81ff>http://ext-auth.envoy-gateway-system.svc.cluster.local:10003</span>
  <span style=color:#f92672>jwt</span>:
    <span style=color:#f92672>providers</span>:
    - <span style=color:#f92672>audiences</span>:
      - <span style=color:#ae81ff>https://my.domain.net</span>
      <span style=color:#f92672>issuer</span>: <span style=color:#ae81ff>https://id.issuer-domain.net</span>
      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>auth0</span>
      <span style=color:#f92672>remoteJWKS</span>:
        <span style=color:#f92672>uri</span>: <span style=color:#ae81ff>https://myid.issuer-domain.net/.well-known/jwks.json</span>
  <span style=color:#f92672>targetRef</span>:
    <span style=color:#f92672>group</span>: <span style=color:#ae81ff>gateway.networking.k8s.io</span>
    <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>HTTPRoute</span>
    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>myapp-back-authz-0</span>
</code></pre></div><p>Note that in 0.6.0, after the JWT filter the payload was not forwarded anymore, it has been changed since (my fork includes that change).</p>
<p>An <a href=https://github.com/envoyproxy/gateway/issues/1059>Extauthz solution by the Gateway team</a> is in development and should land soon.</p>
<h2 id=oidc-openid>OIDC OpenID</h2>
<p>Not in 0.6.0 but already merged, OIDC is supported to protect an <code>HTTPRoute</code> via a <code>SecurityPolicy</code>.</p>
<p>With Azure (but similar with other providers), register an application, get the client ID (application ID) and the client secret, the issuer URL is built with the UUID from &ldquo;Directory (tenant) ID&rdquo;.
Set the Redirect URL to this form:
<code>https://myapp.mydomain.com/oauth2/callback</code></p>
<p>On Envoy Gateway side, apply the <code>SecurityPolicy</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>gateway.envoyproxy.io/v1alpha1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>SecurityPolicy</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>myapp-oidc-policy</span>
  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>myapp</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>targetRef</span>:
    <span style=color:#f92672>group</span>: <span style=color:#ae81ff>gateway.networking.k8s.io</span>
    <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>HTTPRoute</span>
    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>myapp-public-route</span>
  <span style=color:#f92672>oidc</span>:
    <span style=color:#f92672>provider</span>:
      <span style=color:#f92672>issuer</span>: <span style=color:#e6db74>&#34;https://login.microsoftonline.com/4410211c-15ba-427f-bdf7-cd04eb1aa75c/v2.0&#34;</span>
    <span style=color:#f92672>clientID</span>: <span style=color:#e6db74>&#34;4e550576-cd82-4566-a00c-4c1fee89f808&#34;</span>
    <span style=color:#f92672>clientSecret</span>:
      <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;myapp-oidc-client-secret&#34;</span>
</code></pre></div><p>Envoy Gateway will try to discover most of the configuration (Authorization & Token Endpoints) from the provider&rsquo;s <a href=https://openid.net/specs/openid-connect-discovery-1_0.html#ProviderConfigurationResponse>Well-Known Configuration Endpoint</a>.</p>
<h2 id=conclusion>Conclusion</h2>
<p>Most if not any of those required extra configurations will probably disappear with the 1.0 release.<br>
Gateway is flexible enough to provide those in the meantime.</p>
</article>
<nav class="no-print post-nav">
<a class=prev-post href=https://blog.nobugware.com/post/2023/envoy-gateway-new-gateway-api-kubernetes/>
<img class=icon-text src=https://blog.nobugware.com/img/prev.svg>Envoy Gateway a new Gateway API for Kubernetes</a>
</nav>
<section id=related>
<h4>See Also</h4>
<ul>
<li><a href=https://blog.nobugware.com/post/2023/envoy-gateway-new-gateway-api-kubernetes/>Envoy Gateway a new Gateway API for Kubernetes</a></li>
<li><a href=https://blog.nobugware.com/post/enabling-cloudflare-in-front-of-your-kubernetes-cluster-with-traefik/>Enabling Cloudflare in front of your Kubernetes cluster with Traefik</a></li>
<li><a href=https://blog.nobugware.com/post/2019/k3s-containterd-zfs/>k3s, containerd & ZFS</a></li>
</ul>
</section>
<hr class=sep>
</main>
<footer class="container no-print">
<div class=u-footer>
<a href=https://github.com/akhenakh/><img class=icon-social src=https://blog.nobugware.com/img/github.svg alt=Github></a>
<a href=https://twitter.com/akhenakh><img class=icon-social src=https://blog.nobugware.com/img/twitter.svg alt=Twitter></a>
<a href=https://blog.nobugware.com/index.xml target=_blank><img class=icon-social src=https://blog.nobugware.com/img/feed.svg alt=Feed></a>
<p>
Theme used: <a href=https://github.com/yursan9/manis-hugo-theme>Manis</a><br>
</p>
<a href=#brand>
<img class=icon-text src=https://blog.nobugware.com/img/toup.svg alt="To Up">
<span>Back to Up</span>
</a>
</div>
</footer>
<script>(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)})(window,document,'script','//www.google-analytics.com/analytics.js','ga'),ga('create','UA-1245966-1','auto'),ga('send','pageview')</script>
</body>
</html>