<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=generator content="Hugo 0.89.4">
<title>Install FreeBSD 9.0 with ZFS root - Fabrice Aneche</title>
<meta name=description content="The &ldquo;new&rdquo; FreeBSD installer does not give you the options to simply install ZFS as root, so sad, here is how to do it.
Most installation recommand to install / in the zpool root, which is not always clean, for example a recursive snapshot will snapshot your swap &mldr;
#Boot cd and choose shell: umount /dev/md1 mdmfs -s 1024M md1 /tmp gpart destroy -F ada0 gpart create -s gpt ada0 gpart add -b 34 -s 64k -t freebsd-boot ada0 #gpart add -s 4G -t freebsd-swap -l swap0 ada0 gpart add -t freebsd-zfs -l disk0 ada0 gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 ada0 zpool destroy rpool # use -f if you already have a zpool zpool create -f rpool /dev/gpt/disk0 zfs set checksum=fletcher4 rpool zfs create rpool/root zfs set mountpoint=none rpool zfs set mountpoint=/mnt rpool/root zfs create -o canmount=off rpool/root/usr zfs create -o canmount=off rpool/root/var zfs create -o compression=on -o exec=on -o setuid=off rpool/root/tmp zfs create -o compression=gzip -o setuid=off rpool/root/usr/ports zfs create -o compression=off -o exec=off -o setuid=off rpool/root/usr/ports/distfiles zfs create -o compression=off -o exec=off -o setuid=off rpool/root/usr/ports/packages zfs create -o compression=gzip -o exec=off -o setuid=off rpool/root/usr/src zfs create -o compression=lzjb rpool/root/usr/obj zfs create -o compression=lzjb -o exec=off -o setuid=off rpool/root/var/crash zfs create -o compression=off -o exec=off -o setuid=off rpool/root/var/empty zfs create -o compression=lzjb -o exec=on -o setuid=off rpool/root/var/tmp zpool export rpool zpool import -o cachefile=/tmp/zpool.">
<link rel=stylesheet href=https://blog.nobugware.com/css/ui.css>
<link rel=stylesheet href="https://fonts.googleapis.com/css?family=Fira+Mono|Lato|Raleway">
</head>
<body>
<header class="container no-print">
<div class=u-header>
<nav class=bar>
<ul><li>
<a href=https://blog.nobugware.com/>
<img class=icon-text src=https://blog.nobugware.com/img/prev.svg>
</a>
</li><li><a href=https://blog.nobugware.com/about>About</a></li><li><a href=https://blog.nobugware.com/post/>Post</a></li></ul>
</nav>
</div>
</header>
<main class=container>
<article>
<header><hgroup id=brand>
<h1>Install FreeBSD 9.0 with ZFS root</h1>
<h5>
<time datetime="2011-10-14 11:00:22 -0400 -0400">Oct 14, 2011</time>
<span class=no-print>
-
<a href=https://blog.nobugware.com/tags/freebsd>freebsd</a>
<a href=https://blog.nobugware.com/tags/zfs>zfs</a>
<span>
</h5>
</hgroup>
<hr class=sep>
</header>
<p>The &ldquo;new&rdquo; FreeBSD installer does not give you the options to simply install
ZFS as root, so sad, here is how to do it.</p>
<p>Most installation recommand to install / in the zpool root, which is not
always clean, for example a recursive snapshot will snapshot your swap &mldr;</p>
<pre><code>#Boot cd and choose shell:


umount /dev/md1
mdmfs -s 1024M md1 /tmp

gpart destroy -F ada0

gpart create -s gpt ada0

gpart add -b 34 -s 64k -t freebsd-boot ada0
#gpart add -s 4G -t freebsd-swap -l swap0 ada0
gpart add -t freebsd-zfs -l disk0 ada0
gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 ada0

zpool destroy rpool
# use -f if you already have a zpool
zpool create -f rpool /dev/gpt/disk0

zfs set checksum=fletcher4 rpool
zfs create rpool/root
zfs set mountpoint=none rpool
zfs set mountpoint=/mnt rpool/root

zfs create -o canmount=off  rpool/root/usr
zfs create  -o canmount=off rpool/root/var
zfs create -o compression=on -o exec=on -o setuid=off rpool/root/tmp
zfs create -o compression=gzip -o setuid=off  rpool/root/usr/ports
zfs create -o compression=off -o exec=off -o setuid=off rpool/root/usr/ports/distfiles
zfs create -o compression=off -o exec=off -o setuid=off rpool/root/usr/ports/packages
zfs create -o compression=gzip -o exec=off -o setuid=off  rpool/root/usr/src
zfs create -o compression=lzjb rpool/root/usr/obj
zfs create -o compression=lzjb  -o exec=off     -o setuid=off   rpool/root/var/crash
zfs create -o compression=off -o exec=off -o setuid=off   rpool/root/var/empty
zfs create -o compression=lzjb  -o exec=on -o setuid=off   rpool/root/var/tmp

zpool export rpool
zpool import -o cachefile=/tmp/zpool.cache rpool
chmod 1777 /mnt/tmp
chmod 1777 /mnt/var/tmp

sh
cd /usr/freebsd-dist
export DESTDIR=/mnt
for file in base.txz lib32.txz kernel.txz doc.txz ports.txz src.txz;
do (cat $file | tar --unlink -xpJf - -C ${DESTDIR:-/}); done

cp /tmp/zpool.cache /mnt/boot/zfs/zpool.cache
echo 'zfs_enable=&quot;YES&quot;' &gt;&gt; /mnt/etc/rc.conf
echo 'zfs_load=&quot;YES&quot;' &gt;&gt; /mnt/boot/loader.conf
echo 'vfs.root.mountfrom=&quot;zfs:rpool/root&quot;' &gt;&gt; /mnt/boot/loader.conf

zfs set readonly=on rpool/root/var/empty
touch /mnt/etc/fstab
zfs umount -a

zfs set mountpoint=legacy rpool/root
zfs set mountpoint=/tmp rpool/root/tmp
zfs set mountpoint=/usr rpool/root/usr
zfs set mountpoint=/var rpool/root/var
zpool set bootfs=rpool/root rpool
zfs create -V 2G rpool/swap
zfs set checksum=off rpool/swap
zfs set org.freebsd:swap=on rpool/swap


#reboot

# if close to 4G of memory
#echo &quot;vfs.zfs.prefetch_disable=0&quot; &gt;&gt; /boot/loader.conf

#echo WRKDIRPREFIX=/usr/obj &gt;&gt; /etc/make.conf
#passwd root
</code></pre>
<p>This installation has been made on a Linux KVM, later blog post will follow
how to enable Dtrace, virtio &mldr;</p>
</article>
<nav class="no-print post-nav">
<a class=prev-post href=https://blog.nobugware.com/post/2011/08/31/gimp-273-osx/>
<img class=icon-text src=https://blog.nobugware.com/img/prev.svg>Gimp 2.7.3 on OSX</a>
<a class=next-post href=https://blog.nobugware.com/post/2011/10/14/freebsd-90-guest-virtio-support-in-kvm/>FreeBSD 9.0 guest with virtio support in KVM<img class=icon-text src=https://blog.nobugware.com/img/next.svg>
</a>
</nav>
<section id=related>
<h4>See Also</h4>
<ul>
<li><a href=https://blog.nobugware.com/post/2011/03/31/freebsd-zfs/>(Re)Discovering FreeBSD and ZFS</a></li>
<li><a href=https://blog.nobugware.com/post/2010/08/09/zfs-linux/>ZFS on linux</a></li>
<li><a href=https://blog.nobugware.com/post/2009/02/26/understanding-zfs-tuning/>Understanding the ZFS tuning</a></li>
</ul>
</section>
<hr class=sep>
</main>
<footer class="container no-print">
<div class=u-footer>
<a href=https://github.com/akhenakh/><img class=icon-social src=https://blog.nobugware.com/img/github.svg alt=Github></a>
<a href=https://twitter.com/akhenakh><img class=icon-social src=https://blog.nobugware.com/img/twitter.svg alt=Twitter></a>
<a href=https://blog.nobugware.com/index.xml target=_blank><img class=icon-social src=https://blog.nobugware.com/img/feed.svg alt=Feed></a>
<p>
Theme used: <a href=https://github.com/yursan9/manis-hugo-theme>Manis</a><br>
</p>
<a href=#brand>
<img class=icon-text src=https://blog.nobugware.com/img/toup.svg alt="To Up">
<span>Back to Up</span>
</a>
</div>
</footer>
<script>(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)})(window,document,'script','//www.google-analytics.com/analytics.js','ga'),ga('create','UA-1245966-1','auto'),ga('send','pageview')</script>
</body>
</html>