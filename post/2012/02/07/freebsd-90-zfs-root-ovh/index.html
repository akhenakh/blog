<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=generator content="Hugo 0.89.4">
<title>FreeBSD 9.0 ZFS root on OVH - Fabrice Aneche</title>
<meta name=description content="I had so much pain to make it work so here is how to have a ZFS root with a raidz pool on 5 disks, specially with OVH without any console or kvm to debug the boot process.
The server has 5 disks that I put in raidz and boot on it, but this should apply to most installation.
gpart destroy -F ada0 gpart destroy -F ada1 gpart destroy -F ada2 gpart destroy -F ada3 gpart destroy -F ada4 gpart create -s gpt ada0 gpart create -s gpt ada1 gpart create -s gpt ada2 gpart create -s gpt ada3 gpart create -s gpt ada4 gpart add -b 34 -s 64k -t freebsd-boot ada0 gpart add -b 34 -s 64k -t freebsd-boot ada1 gpart add -b 34 -s 64k -t freebsd-boot ada2 gpart add -b 34 -s 64k -t freebsd-boot ada3 gpart add -b 34 -s 64k -t freebsd-boot ada4 # if you are very low on ram use a real partition for swap otherwise don't gpart add -s 4G -t freebsd-swap -l swap0 ada0 gpart add -s 4G -t freebsd-swap -l swap1 ada1 gpart add -s 4G -t freebsd-swap -l swap2 ada2 gpart add -s 4G -t freebsd-swap -l swap3 ada3 gpart add -s 4G -t freebsd-swap -l swap4 ada4 gpart add -t freebsd-zfs -l disk0 ada0 gpart add -t freebsd-zfs -l disk1 ada1 gpart add -t freebsd-zfs -l disk2 ada2 gpart add -t freebsd-zfs -l disk3 ada3 gpart add -t freebsd-zfs -l disk4 ada4 gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 ada0 gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 ada1 gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 ada2 gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 ada3 gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 ada4 zpool create -o cachefile=/boot/zfs/zpool.">
<link rel=stylesheet href=https://blog.nobugware.com/css/ui.css>
<link rel=stylesheet href="https://fonts.googleapis.com/css?family=Fira+Mono|Lato|Raleway">
</head>
<body>
<header class="container no-print">
<div class=u-header>
<nav class=bar>
<ul><li>
<a href=https://blog.nobugware.com/>
<img class=icon-text src=https://blog.nobugware.com/img/prev.svg>
</a>
</li><li><a href=https://blog.nobugware.com/about>About</a></li><li><a href=https://blog.nobugware.com/post/>Post</a></li></ul>
</nav>
</div>
</header>
<main class=container>
<article>
<header><hgroup id=brand>
<h1>FreeBSD 9.0 ZFS root on OVH</h1>
<h5>
<time datetime="2012-02-07 15:05:48 -0400 -0400">Feb 07, 2012</time>
<span class=no-print>
-
<a href=https://blog.nobugware.com/tags/zfs>zfs</a>
<a href=https://blog.nobugware.com/tags/freebsd>freebsd</a>
<span>
</h5>
</hgroup>
<hr class=sep>
</header>
<p>I had so much pain to make it work so here is how to have a ZFS root with a
raidz pool on 5 disks, specially with OVH without any console or kvm to debug
the boot process.</p>
<p>The server has 5 disks that I put in raidz and boot on it, but this should
apply to most installation.</p>
<pre><code>gpart destroy -F ada0
gpart destroy -F ada1
gpart destroy -F ada2
gpart destroy -F ada3
gpart destroy -F ada4

gpart create -s gpt ada0
gpart create -s gpt ada1
gpart create -s gpt ada2
gpart create -s gpt ada3
gpart create -s gpt ada4

gpart add -b 34 -s 64k -t freebsd-boot ada0
gpart add -b 34 -s 64k -t freebsd-boot ada1
gpart add -b 34 -s 64k -t freebsd-boot ada2
gpart add -b 34 -s 64k -t freebsd-boot ada3
gpart add -b 34 -s 64k -t freebsd-boot ada4

# if you are very low on ram use a real partition for swap otherwise don't  
gpart add -s 4G -t freebsd-swap -l swap0 ada0 
gpart add -s 4G -t freebsd-swap -l swap1 ada1 
gpart add -s 4G -t freebsd-swap -l swap2 ada2 
gpart add -s 4G -t freebsd-swap -l swap3 ada3 
gpart add -s 4G -t freebsd-swap -l swap4 ada4  

gpart add -t freebsd-zfs -l disk0 ada0 
gpart add -t freebsd-zfs -l disk1 ada1 
gpart add -t freebsd-zfs -l disk2 ada2 
gpart add -t freebsd-zfs -l disk3 ada3 
gpart add -t freebsd-zfs -l disk4 ada4  

gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 ada0 
gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 ada1 
gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 ada2 
gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 ada3 
gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 ada4  

zpool create -o cachefile=/boot/zfs/zpool.cache -m none -f rpool raidz /dev/gpt/disk0 /dev/gpt/disk1 /dev/gpt/disk2 /dev/gpt/disk3 /dev/gpt/disk4 
#cannot mount '/rpool': failed to create mountpoint  
zfs set checksum=fletcher4 rpool 
zfs create rpool/root 
mkdir /tmp/mntzfs 
zfs set mountpoint=/tmp/mntzfs rpool/root  
zfs create -o canmount=off  rpool/root/usr 
zfs create  -o canmount=off rpool/root/var 
zfs create -o compression=on -o exec=on -o setuid=off rpool/root/tmp 
zfs create -o compression=gzip -o setuid=off  rpool/root/usr/ports 
zfs create -o compression=off -o exec=off -o setuid=off rpool/root/usr/ports/distfiles 
zfs create -o compression=off -o exec=off -o setuid=off rpool/root/usr/ports/packages 
zfs create -o compression=gzip -o exec=off -o setuid=off  rpool/root/usr/src 
zfs create -o compression=lzjb rpool/root/usr/obj zfs create -o compression=lzjb  -o exec=off     -o setuid=off   rpool/root/var/crash 
zfs create -o compression=off -o exec=off -o setuid=off   rpool/root/var/empty 
zfs create -o compression=lzjb  -o exec=on -o setuid=off   rpool/root/var/tmp  
zpool export rpool 
zpool import -o cachefile=/tmp/zpool.cache rpool chmod 1777 /tmp/mntzfs/tmp chmod 1777 /tmp/mntzfs/var/tmp  
sh cd /tmp/mntzfs 
mkdir fileinstall 
cd fileinstall 
fetch http://ftp1.fr.FreeBSD.org/pub/FreeBSD/releases/amd64/9.0-RELEASE/base.txz 
fetch http://ftp1.fr.FreeBSD.org/pub/FreeBSD/releases/amd64/9.0-RELEASE/kernel.txz 
fetch http://ftp1.fr.FreeBSD.org/pub/FreeBSD/releases/amd64/9.0-RELEASE/src.txz 
fetch http://ftp1.fr.FreeBSD.org/pub/FreeBSD/releases/amd64/9.0-RELEASE/doc.txz 
export DESTDIR=/tmp/mntzfs 
for file in base.txz kernel.txz doc.txz src.txz; 
do (cat $file | tar --unlink -xpJf - -C ${DESTDIR:-/}); 
done

cp /tmp/zpool.cache /tmp/mntzfs/boot/zfs/zpool.cache 
echo 'zfs_enable=&quot;YES&quot;' &gt;&gt; /tmp/mntzfs/etc/rc.conf 
echo 'zfs_load=&quot;YES&quot;' &gt;&gt; /tmp/mntzfs/boot/loader.conf 
echo 'if_em_load=&quot;YES&quot;' &gt;&gt; /tmp/mntzfs/boot/loader.conf 
echo 'vfs.root.mountfrom=&quot;zfs:rpool/root&quot;' &gt;&gt; /tmp/mntzfs/boot/loader.conf  
echo 'sshd_enable=&quot;YES&quot;' &gt;&gt; /tmp/mntzfs/etc/rc.conf 
echo 'ifconfig_em0=&quot;inet 188.165.XXX.XXX netmask 255.255.255.0 broadcast 188.165.XXX.255&quot;' &gt;&gt; /tmp/mntzfs/etc/rc.conf 
echo 'defaultrouter=&quot;188.165.XXX.254&quot;' &gt;&gt; /tmp/mntzfs/etc/rc.conf 
echo 'hostname=&quot;ksXXXX.kimsufi.com&quot;' &gt;&gt; /tmp/mntzfs/etc/rc.conf  
chroot /tmp/mntzfs /bin/sh 
passwd root 
vi /etc/ssh/sshd_config 
# Change PermitRootLogin to yes for debug only exit  

zfs set mountpoint=legacy rpool/root
zfs set mountpoint=/tmp rpool/root/tmp 
zfs set mountpoint=/usr rpool/root/usr 
zfs set mountpoint=/var rpool/root/var 
zpool set bootfs=rpool/root rpool  

# not if you are low on RAM 
zfs create -V 8G rpool/swap 
zfs set checksum=off rpool/swap 
zfs set org.freebsd:swap=on rpool/swap  

zfs set readonly=on rpool/root/var/empty 
touch /tmp/mntzfs/etc/fstab 
# or add the swap if you use real partition 
cd /   
zfs umount -a
</code></pre>
<p>EDIT: as mentioned here do not put the swap in the zpool if you are low on ram
or unstability will occur. [http://lists.freebsd.org/pipermail/freebsd-
current/2007-September/076831.html](<a href=http://lists.freebsd.org/pipermail>http://lists.freebsd.org/pipermail</a>
/freebsd-current/2007-September/076831.html)</p>
</article>
<nav class="no-print post-nav">
<a class=prev-post href=https://blog.nobugware.com/post/2012/01/05/compile-and-run-xv6-mac-os-x-6828/>
<img class=icon-text src=https://blog.nobugware.com/img/prev.svg>compile and run xv6 on Mac Os X 6.828</a>
<a class=next-post href=https://blog.nobugware.com/post/2012/02/28/freebsd-vimage-jails/>FreeBSD vimage jails<img class=icon-text src=https://blog.nobugware.com/img/next.svg>
</a>
</nav>
<section id=related>
<h4>See Also</h4>
<ul>
<li><a href=https://blog.nobugware.com/post/2011/10/14/install-freebsd-90-zfs-root/>Install FreeBSD 9.0 with ZFS root</a></li>
<li><a href=https://blog.nobugware.com/post/2011/03/31/freebsd-zfs/>(Re)Discovering FreeBSD and ZFS</a></li>
<li><a href=https://blog.nobugware.com/post/2011/10/14/freebsd-90-guest-virtio-support-in-kvm/>FreeBSD 9.0 guest with virtio support in KVM</a></li>
</ul>
</section>
<hr class=sep>
</main>
<footer class="container no-print">
<div class=u-footer>
<a href=https://github.com/akhenakh/><img class=icon-social src=https://blog.nobugware.com/img/github.svg alt=Github></a>
<a href=https://twitter.com/akhenakh><img class=icon-social src=https://blog.nobugware.com/img/twitter.svg alt=Twitter></a>
<a href=https://blog.nobugware.com/index.xml target=_blank><img class=icon-social src=https://blog.nobugware.com/img/feed.svg alt=Feed></a>
<p>
Theme used: <a href=https://github.com/yursan9/manis-hugo-theme>Manis</a><br>
</p>
<a href=#brand>
<img class=icon-text src=https://blog.nobugware.com/img/toup.svg alt="To Up">
<span>Back to Up</span>
</a>
</div>
</footer>
<script async src=https://us.umami.is/script.js data-website-id=1566cf98-efb9-475c-b96e-709666a74819></script>
</body>
</html>