<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=generator content="Hugo 0.89.4">
<title>A geo database for polygons, foundations - Fabrice Aneche</title>
<meta name=description content="On a previous post, I&rsquo;ve described how to use the S2 geo library to create a fast geo database, but it was to store locations (points) and only to perform range queries, a complete geo database would have regions/polygons queries.
Looking for a solution I had this need: querying for the countries or subregions of hundreds of coordinates per second, without relying on an external service.
One solution, using my previous technique, could have been to store every cities in the world and then perform a proximity query around my point to get the closest cities, but it works only in populated area and it&rsquo;s only an approximation.">
<link rel=stylesheet href=https://blog.nobugware.com/css/ui.css>
<link rel=stylesheet href="https://fonts.googleapis.com/css?family=Fira+Mono|Lato|Raleway">
</head>
<body>
<header class="container no-print">
<div class=u-header>
<nav class=bar>
<ul><li>
<a href=https://blog.nobugware.com/>
<img class=icon-text src=https://blog.nobugware.com/img/prev.svg>
</a>
</li><li><a href=https://blog.nobugware.com/about>About</a></li><li><a href=https://blog.nobugware.com/post/>Post</a></li></ul>
</nav>
</div>
</header>
<main class=container>
<article>
<header><hgroup id=brand>
<h1>A geo database for polygons, foundations</h1>
<h5>
<time datetime="2016-02-18 17:16:55 -0500 -0500">Feb 18, 2016</time>
<span class=no-print>
<span>
</h5>
</hgroup>
<hr class=sep>
</header>
<p>On a previous post, <a href=http://blog.nobugware.com/post/2016/geo_db_s2_geohash_database/>I&rsquo;ve described how to use the S2 geo library</a> to create a fast geo database, but it was to store locations (points) and only to perform range queries, a complete geo database would have regions/polygons queries.</p>
<h2 id=looking-for-a-solution>Looking for a solution</h2>
<p>I had this need: querying for the countries or subregions of hundreds of coordinates per second, without relying on an external service.</p>
<p>One solution, using my previous technique, could have been to store every cities in the world and then perform a proximity query around my point to get the closest cities, but it works only in populated area and it&rsquo;s only an approximation.</p>
<p>I looked into others solutions, there is some smart ideas <a href=https://github.com/hlaw/codegrid-js>using UTF-grid</a>, but it&rsquo;s a client side solution and also an approximation tied to the resolution of the computed grid.</p>
<h2 id=s2-to-the-rescue>S2 to the rescue</h2>
<p>S2 cells have some nice properties, they are segments on the <a href=https://en.wikipedia.org/wiki/Hilbert_curve>Hilbert curve</a>, expressed as range of <code>uint64</code>, so I had the intuition the problem to perform fast region lookup could be simplified as find all mathematical segments containing my location expressed as an <code>uint64</code>.</p>
<p><img src=https://blog.nobugware.com/img/s2belgium.jpg alt="S2 over a country" title="S2 covering belgium"></p>
<p>Using a <a href=https://en.wikipedia.org/wiki/Segment_tree>Segment Tree</a> datastructure, I first tried an in memory engine, using <a href=http://www.naturalearthdata.com/>Natural Earth Data</a>, loading the whole world countries shapes into S2 loops (a <code>Loop</code> represents a simple spherical polygon), transforming then into cells using the region coverer, it returns cells of different levels, add them to the segment tree.</p>
<p><img src=https://blog.nobugware.com/img/stree.gif alt="Segment Tree" title="Segment tree picture fron Wikipedia"></p>
<p>To query, simply tranform the location into an S2 <code>Cell</code> (level 30) and perform a stubbing query that intersects the segments, every segments crossed are cells that covered a part of a <code>Loop</code>.<br>
It will reduce the problem to test a few <code>Loop</code> vs thousands of them, finally perform <code>ContainsPoint</code> against the found loops cause the point could be inside the <code>Cell</code> but not inside the <code>Loop</code> itself.</p>
<p>Et voil√†! It works!</p>
<p>The segment tree structure itself is very low on memory, the loops/polygons data could be stored on disk and loaded on requests, I&rsquo;ve tested a second implementation using LevelDB using this technique.</p>
<p>If you have a very large tree (for example cities limits for the whole world), you can even put the segment tree on a KV storage, using this paper <a href=http://students.ceid.upatras.gr/~patlakas/papers/ICDE13_conf_full_420.pdf>Interval Indexing and Querying on Key-Value Cloud Stores</a>.</p>
<h2 id=region-a-gogo>Region a gogo</h2>
<p>As a demonstration here is a working microservice called <a href=https://github.com/akhenakh/regionagogo>regionagogo</a>, simply returning the country & state for a given location.<br>
It loads geo data for the whole world and answers to HTTP queries using small amout of memory.</p>
<pre tabindex=0><code>GET /country?lat=19.542915&amp;lng=-155.665857

{
    &quot;code&quot;: &quot;US&quot;,
    &quot;name&quot;: &quot;Hawaii&quot;
}
</code></pre><p>Here is a <a href=https://hub.docker.com/r/akhenakh/regionagogo/>Docker image</a> so you can deploy it on your stack.</p>
<p>Note that it performs really well but can be improved a lot, for example the actual Go S2 implementation is still using Rect boxing around loops, that&rsquo;s why <a href=https://github.com/akhenakh/regionagogo>regionagogo</a> is using a data file so it can be generated from the C++ version.</p>
<h2 id=future>Future</h2>
<p>This technique seems to work well for stubbing queries, region queries, geofencing &mldr;<br>
It can be a solid foundation to create a flexible and simple geo database.</p>
</article>
<nav class="no-print post-nav">
<a class=prev-post href=https://blog.nobugware.com/post/2016/geo_db_s2_geohash_database/>
<img class=icon-text src=https://blog.nobugware.com/img/prev.svg>A fast geo database with Google S2 take #2</a>
<a class=next-post href=https://blog.nobugware.com/post/2016/geo_db_s2_region_polygon_optmization/>A geo database for polygons, optimization<img class=icon-text src=https://blog.nobugware.com/img/next.svg>
</a>
</nav>
<hr class=sep>
</main>
<footer class="container no-print">
<div class=u-footer>
<a href=https://github.com/akhenakh/><img class=icon-social src=https://blog.nobugware.com/img/github.svg alt=Github></a>
<a href=https://twitter.com/akhenakh><img class=icon-social src=https://blog.nobugware.com/img/twitter.svg alt=Twitter></a>
<a href=https://blog.nobugware.com/index.xml target=_blank><img class=icon-social src=https://blog.nobugware.com/img/feed.svg alt=Feed></a>
<p>
Theme used: <a href=https://github.com/yursan9/manis-hugo-theme>Manis</a><br>
</p>
<a href=#brand>
<img class=icon-text src=https://blog.nobugware.com/img/toup.svg alt="To Up">
<span>Back to Up</span>
</a>
</div>
</footer>
<script async src=https://us.umami.is/script.js data-website-id=1566cf98-efb9-475c-b96e-709666a74819></script>
</body>
</html>