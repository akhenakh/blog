<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=generator content="Hugo 0.89.4">
<title>Surprising result while transpiling C to Go - Fabrice Aneche</title>
<meta name=description content="Experimenting transpiling Uber h3 library with ccgo.">
<link rel=stylesheet href=https://blog.nobugware.com/css/ui.css>
<link rel=stylesheet href="https://fonts.googleapis.com/css?family=Fira+Mono|Lato|Raleway">
</head>
<body>
<header class="container no-print">
<div class=u-header>
<nav class=bar>
<ul><li>
<a href=https://blog.nobugware.com/>
<img class=icon-text src=https://blog.nobugware.com/img/prev.svg>
</a>
</li><li><a href=https://blog.nobugware.com/about>About</a></li><li><a href=https://blog.nobugware.com/post/>Post</a></li></ul>
</nav>
</div>
</header>
<main class=container>
<article>
<header><hgroup id=brand>
<h1>Surprising result while transpiling C to Go</h1>
<h5>
<time datetime="2022-06-20 04:00:00 +0000 UTC">Jun 20, 2022</time>
<span class=no-print>
-
<a href=https://blog.nobugware.com/tags/go>go</a>
<a href=https://blog.nobugware.com/tags/geo>geo</a>
<a href=https://blog.nobugware.com/tags/golang>golang</a>
<a href=https://blog.nobugware.com/tags/h3>h3</a>
<span>
</h5>
</hgroup>
<hr class=sep>
</header>
<p><a href=https://github.com/uber/h3/>H3</a> is a geospacial indexing library created by Uber. If you are familiar with this blog it&rsquo;s similar to <a href=https://s2geometry.io/>S2</a>.</p>
<p>Uber is providing <a href=https://github.com/uber/h3-go>h3 for Go</a>. Unfortunately it&rsquo;s a CGO version, a C to Go binding as you may know <a href=https://dave.cheney.net/2016/01/18/cgo-is-not-go>CGO is not Go</a>.</p>
<p>Having a native Go library is easier to deal with but would mean a full rewrite.</p>
<h2 id=transpiling>Transpiling</h2>
<p>You may have heard about a recent effort to transpile C to Go using <a href=https://pkg.go.dev/modernc.org/ccgo/v3>ccgo</a> and the associated <a href=https://pkg.go.dev/modernc.org/libc>libc</a>.</p>
<p>Sqlite has been <a href=https://pkg.go.dev/modernc.org/sqlite#section-readme>transpiled using this technique</a> with great success; more recently <a href=https://www.reddit.com/r/golang/comments/v0sdn2/a_cgofree_port_of_the_pcre2_regular_expression/>PCRE2</a> as well.</p>
<p>The result library is often slower than pure C (~2x magnitude) but still having a native Go port could simplify some aspects of the workflow like testing.</p>
<p>I&rsquo;m working on a side project where I need to index millions of coordinates using h3 indexation, so I gave ccgo a try, hoping for something working.</p>
<p>Not 100% of the libc is covered, some builtins are not defined I had to define <code>isFinite</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#66d9ef>bool</span> <span style=color:#a6e22e>isXFinite</span>(<span style=color:#66d9ef>double</span> f) { <span style=color:#66d9ef>return</span> <span style=color:#f92672>!</span>isnan(f <span style=color:#f92672>-</span> f); }

<span style=color:#75715e>/**
</span><span style=color:#75715e> * Encodes a coordinate on the sphere to the H3 index of the containing cell at
</span><span style=color:#75715e> * the specified resolution.
</span><span style=color:#75715e> *
</span><span style=color:#75715e> * Returns 0 on invalid input.
</span><span style=color:#75715e> *
</span><span style=color:#75715e> * @param g The spherical coordinates to encode.
</span><span style=color:#75715e> * @param res The desired H3 resolution for the encoding.
</span><span style=color:#75715e> * @return The encoded H3Index (or H3_NULL on failure).
</span><span style=color:#75715e> */</span>
H3Index <span style=color:#a6e22e>H3_EXPORT</span>(geoToH3)(<span style=color:#66d9ef>const</span> GeoCoord<span style=color:#f92672>*</span> g, <span style=color:#66d9ef>int</span> res) {
    <span style=color:#66d9ef>if</span> (res <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>||</span> res <span style=color:#f92672>&gt;</span> MAX_H3_RES) {
        <span style=color:#66d9ef>return</span> H3_NULL;
    }
    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>isXFinite(g<span style=color:#f92672>-&gt;</span>lat) <span style=color:#f92672>||</span> <span style=color:#f92672>!</span>isXFinite(g<span style=color:#f92672>-&gt;</span>lon)) {
        <span style=color:#66d9ef>return</span> H3_NULL;
    }

    FaceIJK fijk;
    _geoToFaceIjk(g, res, <span style=color:#f92672>&amp;</span>fijk);
    <span style=color:#66d9ef>return</span> _faceIjkToH3(<span style=color:#f92672>&amp;</span>fijk, res);
}

</code></pre></div><p>The C tests are passing, let&rsquo;s continue transpiling:</p>
<pre tabindex=0><code>  CC=/usr/bin/gcc ccgo  -pkgname ch3  -trace-translation-units -export-externs X -export-defines D -export-fields F -export-structs S -export-typedefs T -Isrc/h3lib/include  -I../src/h3lib/include ../src/h3lib/lib/*.c
</code></pre><p>The generated code is visible on <a href=https://github.com/akhenakh/goh3/tree/main/ch3>my goh3 repo</a>, with some <a href=https://github.com/akhenakh/goh3/blob/main/h3.go>helper functions</a>, it can be used exactly like the original Uber library.</p>
<p>Note that for this experiment I&rsquo;ve only created the helper functions for the indexation part.</p>
<p>It works!! But no surprise it&rsquo;s slower, way slower&mldr;</p>
<p>1 millions coordinates to cell and back:</p>
<ul>
<li>In pure C (-O2): <strong>2.03s</strong></li>
<li>Using Uber CGO: <strong>2.25s</strong></li>
<li>Using the transpiled code: <strong>13.07s</strong></li>
</ul>
<h2 id=profiling>Profiling</h2>
<p>What is slow? Using the profiler it&rsquo;s evident the cost to initialize the ccgo libc is too big:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>FromGeo</span>(<span style=color:#a6e22e>geo</span> <span style=color:#a6e22e>GeoCoord</span>, <span style=color:#a6e22e>res</span> <span style=color:#66d9ef>int</span>) <span style=color:#a6e22e>H3Index</span> {
	<span style=color:#a6e22e>tls</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>libc</span>.<span style=color:#a6e22e>NewTLS</span>()
	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>tls</span>.<span style=color:#a6e22e>Close</span>()

	<span style=color:#a6e22e>cgeo</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ch3</span>.<span style=color:#a6e22e>TGeoCoord</span>{
		<span style=color:#a6e22e>Flat</span>: <span style=color:#a6e22e>deg2rad</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>geo</span>.<span style=color:#a6e22e>Latitude</span>,
		<span style=color:#a6e22e>Flon</span>: <span style=color:#a6e22e>deg2rad</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>geo</span>.<span style=color:#a6e22e>Longitude</span>,
	}

	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>H3Index</span>(<span style=color:#a6e22e>ch3</span>.<span style=color:#a6e22e>XgeoToH3</span>(<span style=color:#a6e22e>tls</span>, uintptr(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>cgeo</span>)), int32(<span style=color:#a6e22e>res</span>)))
}
</code></pre></div><p>What if we could initialize then batch?</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewBatch</span>() <span style=color:#f92672>*</span><span style=color:#a6e22e>Batch</span> {
	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>Batch</span>{<span style=color:#a6e22e>TLS</span>: <span style=color:#a6e22e>libc</span>.<span style=color:#a6e22e>NewTLS</span>()}
}

<span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Batch</span>) <span style=color:#a6e22e>FromGeo</span>(<span style=color:#a6e22e>geo</span> <span style=color:#a6e22e>GeoCoord</span>, <span style=color:#a6e22e>res</span> <span style=color:#66d9ef>int</span>) <span style=color:#a6e22e>H3Index</span> {
	<span style=color:#a6e22e>cgeo</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ch3</span>.<span style=color:#a6e22e>TGeoCoord</span>{
		<span style=color:#a6e22e>Flat</span>: <span style=color:#a6e22e>deg2rad</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>geo</span>.<span style=color:#a6e22e>Latitude</span>,
		<span style=color:#a6e22e>Flon</span>: <span style=color:#a6e22e>deg2rad</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>geo</span>.<span style=color:#a6e22e>Longitude</span>,
	}

	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>H3Index</span>(<span style=color:#a6e22e>ch3</span>.<span style=color:#a6e22e>XgeoToH3</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>TLS</span>, uintptr(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>cgeo</span>)), int32(<span style=color:#a6e22e>res</span>)))
}
</code></pre></div><p>Batching 1 million again: <strong>1.82s</strong></p>
<p>It&rsquo;s not only working it&rsquo;s as fast and sometimes faster than the C code, probably due to Go runtime scaling on multiple cores.</p>
<p>I put <a href=https://github.com/akhenakh/h3-bench>some benchmarks comparing CGO & CCGO</a>.</p>
<pre tabindex=0><code>cpu: Intel(R) Core(TM) i7-6700K CPU @ 4.00GHz
BenchmarkToGeoCCGO-8    	32722182	       367.9 ns/op	       0 B/op	       0 allocs/op
BenchmarkToGeoCGO-8     	30941000	       389.8 ns/op	      16 B/op	       1 allocs/op
BenchmarkFromToCCGO-8   	 6580898	      1831 ns/op	       0 B/op	       0 allocs/op
BenchmarkFromToCGO-8    	 5373619	      2230 ns/op	      32 B/op	       2 allocs/op
</code></pre><p>Interestingly it&rsquo;s faster on amd64 but a bit slower on arm64 M1.</p>
<h2 id=conclusion>Conclusion</h2>
<p>CCGO is an incredible piece of code with a bright future, it&rsquo;s one more tool in the Go ecosystem that we can rely on.</p>
</article>
<nav class="no-print post-nav">
<a class=prev-post href=https://blog.nobugware.com/post/enabling-cloudflare-in-front-of-your-kubernetes-cluster-with-traefik/>
<img class=icon-text src=https://blog.nobugware.com/img/prev.svg>Enabling Cloudflare in front of your Kubernetes cluster with Traefik</a>
<a class=next-post href=https://blog.nobugware.com/post/2023/envoy-gateway-new-gateway-api-kubernetes/>Envoy Gateway a new Gateway API for Kubernetes<img class=icon-text src=https://blog.nobugware.com/img/next.svg>
</a>
</nav>
<section id=related>
<h4>See Also</h4>
<ul>
<li><a href=https://blog.nobugware.com/post/2020/free-maps-for-all/>Free Maps For All</a></li>
<li><a href=https://blog.nobugware.com/post/2019/time_series_storage_for_coordinates/>A Time Series Storage for Coordinates</a></li>
<li><a href=https://blog.nobugware.com/post/2019/an_application_for__mapping_storing_your_iot_devices_data/>An application to map and store your IoT devices data</a></li>
</ul>
</section>
<hr class=sep>
</main>
<footer class="container no-print">
<div class=u-footer>
<a href=https://github.com/akhenakh/><img class=icon-social src=https://blog.nobugware.com/img/github.svg alt=Github></a>
<a href=https://twitter.com/akhenakh><img class=icon-social src=https://blog.nobugware.com/img/twitter.svg alt=Twitter></a>
<a href=https://blog.nobugware.com/index.xml target=_blank><img class=icon-social src=https://blog.nobugware.com/img/feed.svg alt=Feed></a>
<p>
Theme used: <a href=https://github.com/yursan9/manis-hugo-theme>Manis</a><br>
</p>
<a href=#brand>
<img class=icon-text src=https://blog.nobugware.com/img/toup.svg alt="To Up">
<span>Back to Up</span>
</a>
</div>
</footer>
<script async src=https://us.umami.is/script.js data-website-id=1566cf98-efb9-475c-b96e-709666a74819></script>
</body>
</html>