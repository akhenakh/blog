<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.123.7"><title>My Own Car System, Rear Camera, Offline Maps & Routing on Raspberry Pi part I - Fabrice Aneche</title>
<meta name=description content="At first I needed a car rear camera, one thing led to another&mldr;
My Car, from 2011, only has an LCD display and no rear camera, so I bought a PAL rear camera, we passed some cables from the rear window to the front then everything begun.
Here is my journey to transform my car into a modern system running on RPi3 (a never ending project).
Hardware I&rsquo;m using an Rpi3 (old model)."><link rel=stylesheet href=https://blog.nobugware.com/css/ui.css><script defer src=https://blog.nobugware.com/js/dark-mode.js></script><link disabled id=dark-mode-theme rel=stylesheet href=https://blog.nobugware.com/css/dark.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Fira+Mono|Lato|Raleway"><link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/ocean.min.css><script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js></script><script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/languages/go.min.js></script><script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/languages/yaml.min.js></script></head><body><header class="container no-print"><div class=u-header><nav class=bar><ul><li><a href=https://blog.nobugware.com/><img class=icon-text src=https://blog.nobugware.com/img/prev.svg></a></li><li><img class=icon-text id=dark-mode-toggle src=https://blog.nobugware.com/img/moon-regular.svg alt="Toggle Dark Mode"></a></li><li><a href=https://blog.nobugware.com/about>About</a></li><li><a href=https://blog.nobugware.com/post/>Post</a></li></ul></nav></div></header><main class=container><article><header><hgroup id=brand><h1>My Own Car System, Rear Camera, Offline Maps & Routing on Raspberry Pi part I</h1><h5><time datetime="2018-06-10 09:19:57 -0500 -0500">Jun 10, 2018</time>
<span class=no-print>-
<a href=https://blog.nobugware.com/tags/Geo>Geo</a>
<a href=https://blog.nobugware.com/tags/Go>Go</a>
<a href=https://blog.nobugware.com/tags/Qt>Qt</a>
<span></h5></hgroup><hr class=sep></header><p>At first I needed a car rear camera, one thing led to another&mldr;</p><p>My Car, from 2011, only has an LCD display and no rear camera, so I bought a <a href=https://www.amazon.ca/gp/product/B06ZY949CF>PAL rear camera</a>, we passed some cables from the rear window to the front then everything begun.<br>Here is my journey to transform my car into a modern system running on RPi3 (a never ending project).</p><h2 id=hardware>Hardware</h2><p>I&rsquo;m using an Rpi3 (old model).</p><p>With <a href=https://archlinuxarm.org>Arch for ARM</a> but any system will do.</p><p>The screen is an <a href="https://www.amazon.ca/gp/product/B019K6CRVY/ref=oh_aui_search_detailpage?ie=UTF8&amp;psc=1">Eleduino Raspberry Pi 7 Inch 1024x600 Pixel IPS Hdmi Input Capacitive Touch Screen Display</a><br>An <a href="https://www.ebay.ca/itm/USB-2-0-Easycap-Video-With-Audio-VHS-DC60-to-DVD-Converter-Capture-Card-Adapter-/142504839503?hash=item212df3494f&_uhb=1">USB 2.0 EasyCap</a> to retrieve the composite signal.</p><p>No driver needed for both the screen and the video capture dongle.</p><pre tabindex=0><code>mplayer tv:// -tv driver=v4l2:device=/dev/video0:fps=25:outfmt=yuy2:norm=PAL
</code></pre><p><img src=https://blog.nobugware.com/img/rearcam.jpg alt=Camera><br>mplayer is working out of the box, so I thought everything was okay with the camera, so I thought.</p><p>I needed a GUI to display the camera and the date (at this this time this project was just a rear camera display).<br>So I choose <a href=https://github.com/therecipe/qt>Qt & Golang</a>, not the normal contenders but I can&rsquo;t handle C++ and had experiences with QtGo, and modern Qt apps are just QML code anyway&mldr; So I thought&mldr;</p><p>I&rsquo;ve started to code a small QML app but when displaying the video I got:</p><pre tabindex=0><code>ERROR: from element /GstPipeline:pipeline0/GstV4l2Src:v4l2src0: Device &#39;/dev/video0&#39; does not support progressive interlacing
Additional debug info:
gstv4l2object.c(3768): gst_v4l2_object_set_format_full (): /GstPipeline:pipeline0/GstV4l2Src:v4l2src0:
Device wants interleaved interlacing
</code></pre><p>Qt via Gstreamer does not allow non interlaced videos :(<br>One solution is to force a pipeline with an interlacer.</p><p>Easy on the command line
<code>gst-launch-1.0 v4l2src ! interlace ! xvimagesink</code></p><p>Not that easy via Qt I had to patch the Qt Gstreamer plugin <code>camerabinsession.cpp</code> to insert a filter on the preview:
at the end of <code>GstElement *CameraBinSession::buildCameraSource()</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>    <span style=color:#66d9ef>const</span> QByteArray envInterlace <span style=color:#f92672>=</span> qgetenv(<span style=color:#e6db74>&#34;QT_GSTREAMER_CAMERABIN_VIDEO_INTERLACE&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (envInterlace.length() <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>        GstElement <span style=color:#f92672>*</span>interlace <span style=color:#f92672>=</span> gst_element_factory_make (<span style=color:#e6db74>&#34;interlace&#34;</span>, NULL);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (interlace <span style=color:#f92672>==</span> NULL)
</span></span><span style=display:flex><span>            g_error (<span style=color:#e6db74>&#34;Could not create &#39;interlace&#39; element&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        g_object_set(G_OBJECT(m_camerabin), <span style=color:#e6db74>&#34;viewfinder-filter&#34;</span>, interlace, NULL);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>#if CAMERABIN_DEBUG
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            qDebug() <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;set camera filter&#34;</span> <span style=color:#f92672>&lt;&lt;</span> interlace;
</span></span><span style=display:flex><span>        <span style=color:#75715e>#endif
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        gst_object_unref (interlace);
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><h2 id=gps>GPS</h2><p>I had a serial GPS around, why not display a moving map?</p><p>Enable serial port in <code>/boot/config.txt</code> (note Bluetooth must be disabled &mldr;)</p><pre tabindex=0><code>enable_uart=1
dtoverlay=pi3-disable-bt
</code></pre><p>pin 8 TXD<br>pin 10 RXD</p><p>remove <code>console=ttyAMA0,115200</code> and <code>kgdboc=ttyAMA0,115200</code> from <code>/boot/cmdline.txt</code></p><p>I thought it would be very easy to read NMEA via serial.<br>It was, gpsd worked in seconds but &mldr; it seems we can&rsquo;t disable the auto speed, equal 4s lost at start.<br>Plus Qt is using libgeoclue or Gypsy which <a href=https://gypsy.freedesktop.org/why-not-gpsd.html>does not want to talk with gpsd</a>.<br>I tried both of them, they didn&rsquo;t work, it&rsquo;s a mess to debug, documentation is just the API&mldr;</p><p>So one thing led to another&mldr; I&rsquo;ve written a very small and simple gpsd in Go with a gRPC interface, so it can be queried from anything.<br>It&rsquo;s also a bit more advanced since it can map match & route match the positions with OSRM.</p><h2 id=offline-maps>Offline maps</h2><p><a href=https://openmaptiles.org>OpenMapTiles project is great</a> to generate vectors data in MBTILES format, you can serve them with <a href=https://github.com/akhenakh/mbmatch>mbmatch</a>.<br>Qt Map QML can display them using the <code>mapboxgl</code> driver, some <a href=https://openmaptiles.org/styles/>free styles</a> are provided.</p><p>Here is an example QML Map plugin.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-QML data-lang=QML><span style=display:flex><span>    <span style=color:#a6e22e>Plugin</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>id: mapPlugin</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>name:</span> <span style=color:#e6db74>&#34;mapboxgl&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>PluginParameter</span>{
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>name:</span> <span style=color:#e6db74>&#34;mapboxgl.mapping.additional_style_urls&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>value:</span> <span style=color:#e6db74>&#34;http://localhost:4000/osm-liberty-gl.style&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>Note on X11 and EGL:<br>Using the mapboxgl renderer under X11 on the Rpi3 is taking a lot of ressources.<br>Qt5 is <a href=https://doc.qt.io/qt-5/embedded-linux.html>capable of directly talking to the GPU without X11</a>, the performance difference is night and day.</p><p>So just run your Qt app without X11 with the following env vars.</p><pre tabindex=0><code>QT_QPA_PLATFORM=eglfs:/dev/fb0
QT_QPA_EGLFS_HIDECURSOR=yes
</code></pre><h2 id=offline-routing>Offline Routing</h2><p>Hopefully the provided Qt <code>osm</code> plugins knows how to route using the <a href=https://github.com/Project-OSRM/osrm-backend/blob/master/docs/http.md>OSRM API</a>.<br>So you can run a local <a href=https://github.com/Project-OSRM/osrm-backend>OSRM backend</a> for routing and it will just work.</p><p>Generate the route indexes.</p><pre tabindex=0><code>osrm-extract -p /usr/share/osrm/profiles/car.lua quebec-latest.osm.pbf 
osrm-contract quebec-latest.osrm
osrm-routed quebec-latest.osrm
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-QML data-lang=QML><span style=display:flex><span>    <span style=color:#a6e22e>Plugin</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>id: routePlugin</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>name:</span> <span style=color:#e6db74>&#34;osm&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>PluginParameter</span>{
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>name:</span> <span style=color:#e6db74>&#34;osm.routing.host&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>value:</span> <span style=color:#e6db74>&#34;http://localhost:5000/route/v1/driving/&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p><img src=https://blog.nobugware.com/img/mocs.jpg alt=Mocs></p><p>The app can display the rear camera and a moving map !!</p><p><a href=https://blog.nobugware.com/post/2018/my_own_car_system_raspberry_pi_offline_mapping_map_matching_places_part2/>Part 2</a> will be about searching places by extracting OSM data and indexing them in a small Go program that can run on the rpi, reading ODB data from the car via Bluetooth, packaging the whole thing and open sourcing some code.</p></article><nav class="no-print post-nav"><a class=prev-post href=https://blog.nobugware.com/post/2018/bitlbee_slack_hangouts_facebook_irc_gateway/><img class=icon-text src=https://blog.nobugware.com/img/prev.svg>Bitlbee: Slack, Hangouts & Facebook via IRC gateway</a>
<a class=next-post href=https://blog.nobugware.com/post/2018/my_own_car_system_raspberry_pi_offline_mapping_map_matching_places_part2/>My Own Car System, Rear Camera, Offline Maps & Routing, Map Matching with Go on Raspberry Pi part II<img class=icon-text src=https://blog.nobugware.com/img/next.svg></a></nav><section id=related><h4>See Also</h4><ul><li><a href=https://blog.nobugware.com/post/2018/google-s2-python-jupyter/>Google S2 with Python & Jupyter</a></li><li><a href=https://blog.nobugware.com/post/2017/hacking_temperature_radio_sensors_and_graphing_with_prometheus/>Hacking Temperature Radio Sensors and Graphing with Prometheus</a></li><li><a href=https://blog.nobugware.com/post/2016/go_mobile_ios_real_usage/>Using Go mobile on iOS for real</a></li></ul></section><hr class=sep></main><footer class="container no-print"><div class=u-footer><a href=https://github.com/akhenakh/><img class=icon-social src=https://blog.nobugware.com/img/github.svg alt=Github></a>
<a href=https://c.im/@akhenakh><img class=icon-social src=https://blog.nobugware.com/img/mastodon.svg alt=Mastodon></a>
<a href=https://twitter.com/akhenakh><img class=icon-social src=https://blog.nobugware.com/img/twitter.svg alt=Twitter></a><p>Theme used: <a href=https://github.com/yursan9/manis-hugo-theme>Manis</a><br></p><a href=#brand><img class=icon-text src=https://blog.nobugware.com/img/toup.svg alt="To Up">
<span>Back to Up</span></a></div></footer><script>hljs.initHighlightingOnLoad()</script></body></html>