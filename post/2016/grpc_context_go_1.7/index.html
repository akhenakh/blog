<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.74.2"><title>gRPC wrong types context and Go 1.7 - Fabrice Aneche</title><meta name=description content="gRPC wrong types context and Go 1.7"><link rel=stylesheet href=https://blog.nobugware.com/css/ui.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Fira+Mono|Lato|Raleway"></head><body><header class="container no-print"><div class=u-header><nav class=bar><ul><li><a href=https://blog.nobugware.com/><img class=icon-text src=https://blog.nobugware.com/img/prev.svg></a></li><li><a href=https://blog.nobugware.com/about>About</a></li><li><a href=https://blog.nobugware.com/post/>Post</a></li></ul></nav></div></header><main class=container><article><header><hgroup id=brand><h1>gRPC wrong types context and Go 1.7</h1><h5><time datetime="2016-09-28 13:15:53 -0400 -0400">Sep 28, 2016</time>
<span class=no-print>-
<a href=https://blog.nobugware.com/tags/Golang>Golang</a>
<span></h5></hgroup><hr class=sep></header><p>If you are following Go development you probably know that:<br>Go 1.7 moves the <code>golang.org/x/net/context</code> package into the standard library as <a href=https://tip.golang.org/pkg/context/>context</a>, Yeah !<br>Unfortunately it won&rsquo;t work for everything, I&rsquo;ve spent some time understanding this one.</p><p>For example if you are using gRPC you can hit this problem, here is an interface generated by gRPC:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>APRSServer</span> <span style=color:#66d9ef>interface</span> {
    <span style=color:#a6e22e>GetPastMessages</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>Point</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>ARPSMessages</span>, <span style=color:#66d9ef>error</span>)
}
</code></pre></div><p>But when compiling:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=color:#f92672>/</span><span style=color:#a6e22e>main</span>.<span style=color:#66d9ef>go</span>:<span style=color:#ae81ff>153</span>: <span style=color:#a6e22e>cannot</span> <span style=color:#a6e22e>use</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>s</span> (<span style=color:#66d9ef>type</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Server</span>) <span style=color:#a6e22e>as</span> <span style=color:#66d9ef>type</span> <span style=color:#a6e22e>protorpc</span>.<span style=color:#a6e22e>APRSServer</span> <span style=color:#a6e22e>in</span> <span style=color:#a6e22e>argument</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>protorpc</span>.<span style=color:#a6e22e>RegisterAPRSServer</span>:                                                                           
        <span style=color:#f92672>*</span><span style=color:#a6e22e>Server</span> <span style=color:#a6e22e>does</span> <span style=color:#a6e22e>not</span> <span style=color:#a6e22e>implement</span> <span style=color:#a6e22e>protorpc</span>.<span style=color:#a6e22e>APRSServer</span> (<span style=color:#a6e22e>wrong</span> <span style=color:#66d9ef>type</span> <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>GetPastMessages</span> <span style=color:#a6e22e>method</span>)                                                                                                
                <span style=color:#a6e22e>have</span> <span style=color:#a6e22e>GetPastMessages</span>(<span style=color:#e6db74>&#34;context&#34;</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>protorpc</span>.<span style=color:#a6e22e>Point</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>protorpc</span>.<span style=color:#a6e22e>ARPSMessages</span>, <span style=color:#66d9ef>error</span>)                                                                                      
                <span style=color:#a6e22e>want</span> <span style=color:#a6e22e>GetPastMessages</span>(<span style=color:#e6db74>&#34;golang.org/x/net/context&#34;</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>protorpc</span>.<span style=color:#a6e22e>Point</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>protorpc</span>.<span style=color:#a6e22e>ARPSMessages</span>, <span style=color:#66d9ef>error</span>)   
</code></pre></div><p>The compiler is complaining about wrong types for the context argument.<br>Problem is gRPC generated code is importing <code>context</code> as <code>golang.org/x/net/context</code>, that&rsquo;s the only way it remains compatible between Go 1.6 & Go 1.7.</p><p>So a quick solution is to import context in your own code to use the old path:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=color:#75715e>// we have to use the old context path here for gRPC compat see https://github.com/grpc/grpc-go/issues/711
</span><span style=color:#75715e></span><span style=color:#a6e22e>context</span> <span style=color:#e6db74>&#34;golang.org/x/net/context&#34;</span>
</code></pre></div><p>Also note that go tool fix is now capable of <a href=https://github.com/golang/go/issues/17040>fixing the import path</a> with <code>-force context</code>.</p></article><nav class="no-print post-nav"><a class=prev-post href=https://blog.nobugware.com/post/2016/go_mobile_ios_real_usage/><img class=icon-text src=https://blog.nobugware.com/img/prev.svg>Using Go mobile on iOS for real</a>
<a class=next-post href=https://blog.nobugware.com/post/2016/telegraf_prometheus_metrics_swiss_army_knife/>Telegraf & Prometheus Swiss Army Knife for Metrics<img class=icon-text src=https://blog.nobugware.com/img/next.svg></a></nav><section id=related><h4>See Also</h4><ul><li><a href=https://blog.nobugware.com/post/2016/go_mobile_ios_real_usage/>Using Go mobile on iOS for real</a></li><li><a href=https://blog.nobugware.com/post/2016/geo_db_s2_geohash_database/>A fast geo database with Google S2 take #2</a></li><li><a href=https://blog.nobugware.com/post/2016/freebsd_raspberry_pi2/>Freebsd on Raspberry Pi 2 and Golang</a></li></ul></section><hr class=sep></main><footer class="container no-print"><div class=u-footer><a href=https://github.com/akhenakh/><img class=icon-social src=https://blog.nobugware.com/img/github.svg alt=Github></a>
<a href=https://twitter.com/akhenakh><img class=icon-social src=https://blog.nobugware.com/img/twitter.svg alt=Twitter></a>
<a href=https://blog.nobugware.com/index.xml target=_blank><img class=icon-social src=https://blog.nobugware.com/img/feed.svg alt=Feed></a><p>Theme used: <a href=https://github.com/yursan9/manis-hugo-theme>Manis</a><br></p><a href=#brand><img class=icon-text src=https://blog.nobugware.com/img/toup.svg alt="To Up">
<span>Back to Up</span></a></div></footer><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-1245966-1','auto');ga('send','pageview');</script></body></html>