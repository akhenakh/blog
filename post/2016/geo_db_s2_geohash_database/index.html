<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=generator content="Hugo 0.89.4">
<title>A fast geo database with Google S2 take #2 - Fabrice Aneche</title>
<meta name=description content="A fast geo database with Google S2, Golang, LevelDB, LMDB.">
<link rel=stylesheet href=https://blog.nobugware.com/css/ui.css>
<link rel=stylesheet href="https://fonts.googleapis.com/css?family=Fira+Mono|Lato|Raleway">
</head>
<body>
<header class="container no-print">
<div class=u-header>
<nav class=bar>
<ul><li>
<a href=https://blog.nobugware.com/>
<img class=icon-text src=https://blog.nobugware.com/img/prev.svg>
</a>
</li><li><a href=https://blog.nobugware.com/about>About</a></li><li><a href=https://blog.nobugware.com/post/>Post</a></li></ul>
</nav>
</div>
</header>
<main class=container>
<article>
<header><hgroup id=brand>
<h1>A fast geo database with Google S2 take #2</h1>
<h5>
<time datetime="2016-01-26 14:01:52 -0500 -0500">Jan 26, 2016</time>
<span class=no-print>
-
<a href=https://blog.nobugware.com/tags/Golang>Golang</a>
<span>
</h5>
</hgroup>
<hr class=sep>
</header>
<p>Six months ago, I wrote on this blog about <a href=https://blog.nobugware.com/post/2015/leveldb_geohash_golang/>Geohashes and LevelDB with Go</a>, to create a fast geo database.<br>
This post is very similar as it works the same way but replacing GeoHashes with <a href=http://blog.christianperone.com/2015/08/googles-s2-geometry-on-the-sphere-cells-and-hilbert-curve/>Google S2</a> library for better performances.</p>
<p>There is an <a href=https://github.com/golang/geo>S2 Golang implementation maintened by Google</a> not as complete as the C++ one but close.</p>
<p>For the storage this post will stay agnostic to avoid any troll, but it applies to any Key Value storages: LevelDB/RocksDB, LMDB, Redis&mldr;<br>
I personnaly use <a href=https://github.com/boltdb/bolt>BoltDB</a> and <a href=https://github.com/steveyen/gtreap>gtreap</a> for my experimentations.</p>
<p>This post will focus on Go usage but can be applied to any languages.</p>
<p>Or skip to the images below for visual explanations.</p>
<h2 id=why-not-geohash>Why not Geohash?</h2>
<p>Geohash is a great solution to perform geo coordinates queries but the way it works can sometimes be an issue with your data.</p>
<ul>
<li>
<p>Remember geohashes are cells of 12 different widths from 5000km to 3.7cm, when you perform a lookup around a position, if your position is close to a cell&rsquo;s edge you could miss some points from the adjacent cell, that&rsquo;s why you have to query for the 8 neightbour cells, it means 9 range queries into your DB to find all the closest points from your location.</p>
</li>
<li>
<p>If your lookup does not fit in level <code>4</code> 39km by 19.5km, the next level is 156km by 156km!</p>
</li>
<li>
<p>The query is not performed around your coordinates, you search for the cell you are in then you query for the adjacent cells at the same level/radius, based on your needs, it means it works very approximately and you can only perform &lsquo;circles&rsquo; lookup around the cell you are in.</p>
</li>
<li>
<p>The most precise geohash needs 12 bytes storage.</p>
</li>
<li>
<p>-90 +90 and +180 -180, -0 +0 are not sides by sides prefixes.</p>
</li>
</ul>
<h2 id=why-s2>Why S2?</h2>
<p>S2 cells have a level ranging from <code>30</code> ~0.7cm² to <code>0</code> ~85,000,000km².<br>
S2 cells are encoded on an uint64, easy to store.</p>
<p>The main advantage is the <strong>region coverer algorithm</strong>, give it a region and the maximum number of cells you want, S2 will return some cells at <strong>different levels that cover the region you asked for</strong>, remember one cell corresponds to a range lookup you&rsquo;ll have to perform in your database.</p>
<p>The coverage is more accurate it means less read from the DB, less objects unmarshalling&mldr;</p>
<h2 id=real-world-study>Real world study</h2>
<p>We want to query for objects inside Paris city limits using a rectangle:</p>
<p><img src=https://blog.nobugware.com/img/h5.jpg alt=h5 title="Geohash using level 5"><br>
Using level 5 we can&rsquo;t fit the left part of the city.<br>
We could add 3 cells (12 total DB queries ) on the left but most algorithms will zoom out to level 4.</p>
<p><img src=https://blog.nobugware.com/img/h4.jpg alt=h4 title="Geohash using level 4"><br>
But now we are querying for the whole region.</p>
<p><img src=https://blog.nobugware.com/img/s2.jpg alt=s2 title="S2 9 cells"><br>
Using s2 asking for 9 cells using a rectangle around the city limits.</p>
<p><img src=https://blog.nobugware.com/img/h4vss2.jpg alt="s2 vs h4" title="Geohash vs s2"><br>
The zones queried by Geohash in pink and S2 in green.</p>
<h2 id=example-s2-storage>Example S2 storage</h2>
<p>Let&rsquo;s say we want to store every cities in the world and perform a lookup to find the closest cities around, first we need to compute the <code>CellId</code> for each cities.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// Compute the CellID for lat, lng
</span><span style=color:#75715e></span><span style=color:#a6e22e>c</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s2</span>.<span style=color:#a6e22e>CellIDFromLatLng</span>(<span style=color:#a6e22e>s2</span>.<span style=color:#a6e22e>LatLngFromDegrees</span>(<span style=color:#a6e22e>lat</span>, <span style=color:#a6e22e>lng</span>))

<span style=color:#75715e>// store the uint64 value of c to its bigendian binary form
</span><span style=color:#75715e></span><span style=color:#a6e22e>key</span> <span style=color:#f92672>:=</span> make([]<span style=color:#66d9ef>byte</span>, <span style=color:#ae81ff>8</span>)
<span style=color:#a6e22e>binary</span>.<span style=color:#a6e22e>BigEndian</span>.<span style=color:#a6e22e>PutUint64</span>(<span style=color:#a6e22e>key</span>, uint64(<span style=color:#a6e22e>c</span>))
</code></pre></div><p>Big endian is needed to order bytes lexicographically, so we can seek later from one cell to the next closest cell on the Hilbert curve.</p>
<p><code>c</code> is a CellID to the level <code>30</code>.</p>
<p>Now we can store <code>key</code> as the key and a value (a string or msgpack/protobuf) for our city, in the database.</p>
<h2 id=example-s2-lookup>Example S2 lookup</h2>
<p>For the lookup we use the opposite procedure, first looking for one CellID.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// citiesInCellID looks for cities inside c
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>citiesInCellID</span>(<span style=color:#a6e22e>c</span> <span style=color:#a6e22e>s2</span>.<span style=color:#a6e22e>CellID</span>) {
  <span style=color:#75715e>// compute min &amp; max limits for c
</span><span style=color:#75715e></span>  <span style=color:#a6e22e>bmin</span> <span style=color:#f92672>:=</span> make([]<span style=color:#66d9ef>byte</span>, <span style=color:#ae81ff>8</span>)
  <span style=color:#a6e22e>bmax</span> <span style=color:#f92672>:=</span> make([]<span style=color:#66d9ef>byte</span>, <span style=color:#ae81ff>8</span>)
  <span style=color:#a6e22e>binary</span>.<span style=color:#a6e22e>BigEndian</span>.<span style=color:#a6e22e>PutUint64</span>(<span style=color:#a6e22e>bmin</span>, uint64(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>RangeMin</span>()))
  <span style=color:#a6e22e>binary</span>.<span style=color:#a6e22e>BigEndian</span>.<span style=color:#a6e22e>PutUint64</span>(<span style=color:#a6e22e>bmax</span>, uint64(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>RangeMax</span>()))

  <span style=color:#75715e>// perform a range lookup in the DB from bmin key to bmax key, cur is our DB cursor
</span><span style=color:#75715e></span>  <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>cell</span> <span style=color:#a6e22e>s2</span>.<span style=color:#a6e22e>CellID</span>
  <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>k</span>, <span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>cur</span>.<span style=color:#a6e22e>Seek</span>(<span style=color:#a6e22e>bmin</span>); <span style=color:#a6e22e>k</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>Compare</span>(<span style=color:#a6e22e>k</span>, <span style=color:#a6e22e>bmax</span>) <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>k</span>, <span style=color:#a6e22e>v</span> = <span style=color:#a6e22e>cur</span>.<span style=color:#a6e22e>Next</span>() {
    <span style=color:#a6e22e>buf</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>NewReader</span>(<span style=color:#a6e22e>k</span>)
    <span style=color:#a6e22e>binary</span>.<span style=color:#a6e22e>Read</span>(<span style=color:#a6e22e>buf</span>, <span style=color:#a6e22e>binary</span>.<span style=color:#a6e22e>BigEndian</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>cell</span>)

    <span style=color:#75715e>// Read back a city
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>ll</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>cell</span>.<span style=color:#a6e22e>LatLng</span>()
    <span style=color:#a6e22e>lat</span> <span style=color:#f92672>:=</span> float64(<span style=color:#a6e22e>ll</span>.<span style=color:#a6e22e>Lat</span>.<span style=color:#a6e22e>Degrees</span>())
    <span style=color:#a6e22e>lng</span> <span style=color:#f92672>:=</span> float64(<span style=color:#a6e22e>ll</span>.<span style=color:#a6e22e>Lng</span>.<span style=color:#a6e22e>Degrees</span>())
    <span style=color:#a6e22e>name</span> = string(<span style=color:#a6e22e>v</span>)
    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>lat</span>, <span style=color:#a6e22e>lng</span>, <span style=color:#a6e22e>name</span>)
  }
}
</code></pre></div><p>Then compute the CellIDs for the region we want to cover.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a6e22e>rect</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s2</span>.<span style=color:#a6e22e>RectFromLatLng</span>(<span style=color:#a6e22e>s2</span>.<span style=color:#a6e22e>LatLngFromDegrees</span>(<span style=color:#ae81ff>48.99</span>, <span style=color:#ae81ff>1.852</span>))
<span style=color:#a6e22e>rect</span> = <span style=color:#a6e22e>rect</span>.<span style=color:#a6e22e>AddPoint</span>(<span style=color:#a6e22e>s2</span>.<span style=color:#a6e22e>LatLngFromDegrees</span>(<span style=color:#ae81ff>48.68</span>, <span style=color:#ae81ff>2.75</span>))

<span style=color:#a6e22e>rc</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>s2</span>.<span style=color:#a6e22e>RegionCoverer</span>{<span style=color:#a6e22e>MaxLevel</span>: <span style=color:#ae81ff>20</span>, <span style=color:#a6e22e>MaxCells</span>: <span style=color:#ae81ff>8</span>}
<span style=color:#a6e22e>r</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s2</span>.<span style=color:#a6e22e>Region</span>(<span style=color:#a6e22e>rect</span>.<span style=color:#a6e22e>CapBound</span>())
<span style=color:#a6e22e>covering</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rc</span>.<span style=color:#a6e22e>Covering</span>(<span style=color:#a6e22e>r</span>)

<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>c</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>covering</span> {
    <span style=color:#a6e22e>citiesInCellID</span>(<span style=color:#a6e22e>c</span>)
}
</code></pre></div><p>RegionCoverer will return at most 8 cells (in this case 7 cells: 4 <code>8</code>, 1 <code>7</code>, 1 <code>9</code>, 1 <code>10</code>) that is guaranteed to cover the given region, it means we may have to exclude cities that were <strong>NOT</strong> in our <code>rect</code>, with <code>func (Rect) ContainsLatLng(LatLng)</code>.</p>
<p>Congrats we have a working geo db.</p>
<p>S2 can do more with complex shapes like Polygons and includes a lot of tools to compute distances, areas, intersections between shapes&mldr;</p>
<p>Here is a <a href=https://github.com/akhenakh/CompareGeoHashvsS2/blob/master/h4.json>Github repo for the data & scripts generated for the images</a></p>
</article>
<nav class="no-print post-nav">
<a class=prev-post href=https://blog.nobugware.com/post/2016/myaprs_aprs_on_iphone/>
<img class=icon-text src=https://blog.nobugware.com/img/prev.svg>MyAPRS APRS for iPhone</a>
<a class=next-post href=https://blog.nobugware.com/post/2016/geo_db_s2_region_polygon/>A geo database for polygons, foundations<img class=icon-text src=https://blog.nobugware.com/img/next.svg>
</a>
</nav>
<section id=related>
<h4>See Also</h4>
<ul>
<li><a href=https://blog.nobugware.com/post/2016/freebsd_raspberry_pi2/>Freebsd on Raspberry Pi 2 and Golang</a></li>
</ul>
</section>
<hr class=sep>
</main>
<footer class="container no-print">
<div class=u-footer>
<a href=https://github.com/akhenakh/><img class=icon-social src=https://blog.nobugware.com/img/github.svg alt=Github></a>
<a href=https://twitter.com/akhenakh><img class=icon-social src=https://blog.nobugware.com/img/twitter.svg alt=Twitter></a>
<a href=https://blog.nobugware.com/index.xml target=_blank><img class=icon-social src=https://blog.nobugware.com/img/feed.svg alt=Feed></a>
<p>
Theme used: <a href=https://github.com/yursan9/manis-hugo-theme>Manis</a><br>
</p>
<a href=#brand>
<img class=icon-text src=https://blog.nobugware.com/img/toup.svg alt="To Up">
<span>Back to Up</span>
</a>
</div>
</footer>
<script>(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)})(window,document,'script','//www.google-analytics.com/analytics.js','ga'),ga('create','UA-1245966-1','auto'),ga('send','pageview')</script>
</body>
</html>