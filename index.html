<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fabrice Aneche &middot; Fabrice Aneche</title>

    <meta name="description" content="">

    <meta name="generator" content="Hugo 0.55.3" />
    <meta name="twitter:card" content="summary">
    
    <meta name="twitter:title" content="Fabrice Aneche &middot; Fabrice Aneche">
    <meta name="twitter:description" content="">

    <meta property="og:type" content="article">
    <meta property="og:title" content="Fabrice Aneche &middot; Fabrice Aneche">
    <meta property="og:description" content="">

    <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700|Oxygen:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/pure-min.css">
    <!--[if lte IE 8]>
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-old-ie-min.css">
    <![endif]-->
    <!--[if gt IE 8]><!-->
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-min.css">
    <!--<![endif]-->

    <link rel="stylesheet" href="https://blog.nobugware.com/css/all.min.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">

    <link rel="alternate" type="application/rss+xml" title="Fabrice Aneche" href="https://blog.nobugware.com/index.xml" />
    <link href="https://blog.nobugware.com/css/prism.css" rel="stylesheet" />
</head>
<body>


<div id="layout" class="pure-g">
    <div class="sidebar pure-u-1 pure-u-md-1-4">
    <div class="header">
        <hgroup>
            <h1 class="brand-title"><a href="https://blog.nobugware.com">Fabrice Aneche</a></h1>
            <h2 class="brand-tagline"></h2>
        </hgroup>

        <nav class="nav">
            <ul class="nav-list">
                
                <li class="nav-item">
                    <a class="pure-button" href="http://www.nobugware.com"><i class="fa fa-building-o"></i> Hiring</a>
                </li>
                
                
                <li class="nav-item">
                    <a class="pure-button" href="https://twitter.com/akhenakh"><i class="fa fa-twitter"></i> Twitter</a>
                </li>
                
                
                <li class="nav-item">
                    <a class="pure-button" href="https://github.com/akhenakh "><i class="fa fa-github-alt"></i> github</a>
                </li>
                
                <li class="nav-item">
                    <a class="pure-button" href="https://blog.nobugware.com/index.xml"><i class="fa fa-rss"></i> rss</a>
                </li>
            </ul>
        </nav>
    </div>
</div>


    <div class="content pure-u-1 pure-u-md-3-4">
        <div>
            
            <div class="posts">
                
                <h1 class="content-subhead">30 May 2019, 00:00</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.nobugware.com/post/2019/k3s-on-arm64/" class="post-title">k3s on arm64</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                <a class="post-category post-category-devops" href="https://blog.nobugware.com/categories/devops">devops</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p>I&rsquo;m evaluating <a href="https://k3s.io/">k3s</a> a Lightweight Kubernetes on a <a href="http://wiki.pine64.org/index.php/ROCK64_Main_Page">rock64</a> (RK3328 Quad arm64).</p>

<p>At the time of writing the stable release is k3s <a href="https://github.com/rancher/k3s/releases/tag/v0.4.0">v0.4.0</a></p>

<p>Here are my notes:</p>

<ul>
<li>If you haven&rsquo;t installed k3s with the <code>install.sh</code>, you may need to load some modules: <code>br_netfilter</code> and <code>overlay</code></li>
<li>Docker is not needed since k3s is using containerd but it seems I had to start docker to initialized the whole cgroups, at least on Arch</li>
<li>For the Metrics API server to work you&rsquo;ll need to start k3s with those args <code>k3s server --kubelet-arg=&quot;address=0.0.0.0&quot;</code></li>

<li><p>Remember to change all the templates you nay need to arm64</p>

<pre><code>  containers:
  - name: kubernetes-dashboard
    image: k8s.gcr.io/kubernetes-dashboard-arm64:v1.10.1
</code></pre></li>

<li><p>Deploy metrics server
Clone the k3s and change the image to be arm64 <code>k8s.gcr.io/metrics-server-arm64:v0.3.1</code></p>

<p>git clone git@github.com:rancher/k3s.git
  vi k3s/recipes/metrics-server/metrics-server-deployment.yaml
  sudo  k3s kubectl -n kube-system create -f k3s/recipes/metrics-server</p></li>

<li><p>Deploy dashboard
Change the image to be arm64  <code>k8s.gcr.io/kubernetes-dashboard-arm64:v1.10.1</code>.
Add the skip option to the args <code>- --enable-skip-login</code></p>

<p>curl -sfL <a href="https://raw.githubusercontent.com/kubernetes/dashboard/v1.10.1/src/deploy/recommended/kubernetes-dashboard.yaml">https://raw.githubusercontent.com/kubernetes/dashboard/v1.10.1/src/deploy/recommended/kubernetes-dashboard.yaml</a> &gt; kubernetes-dashboard.yaml
  vi kubernetes-dashboard.yaml
  cat &lt;&lt;EOF | k3s kubectl create -f -
  apiVersion: rbac.authorization.k8s.io/v1beta1
  kind: ClusterRoleBinding
  metadata:
    name: kubernetes-dashboard
    labels:
      k8s-app: kubernetes-dashboard
  roleRef:
    apiGroup: rbac.authorization.k8s.io
    kind: ClusterRole
    name: cluster-admin
  subjects:</p>

<ul>
<li>kind: ServiceAccount
name: kubernetes-dashboard
namespace: kube-system
EOF
sudo  k3s kubectl -n kube-system create -f kubernetes-dashboard.yaml</li>
</ul></li>
</ul>

<p>Merge <code>/etc/rancher/k3s/k3s.yaml</code> to your <code>.kube/config</code> on your workstation host, then <code>kubectl proxy</code> to <a href="http://localhost:8001/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy/#!/overview?namespace=default">localhost:8001</a></p>

                    </div>
                </section>
                
                <h1 class="content-subhead">27 May 2019, 00:00</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.nobugware.com/post/2019/h96-max-android-box-as-a-linux-server/" class="post-title">H96 Max&#43; Android box as a Linux server</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<p>The H96 Max + is an Android 8.1 box with a Rockchip 3328, 4Gb RAM and 32G or 64G builtin eMMC, it&rsquo;s the same chipset as the <a href="https://blog.nobugware.com/post/2019/arch-on-rock64-with-usb-boot/">Rock64</a>, it costs around 60 USD.<br />
The only downside of this board is the 100Mb network link, can be a non issue using a USB network adapter.</p>

<p><img src="https://blog.nobugware.com/img/h96maxp.jpg" alt="" /></p>

<p>Here are some notes how to install Arch Linux on the H96 to make it a small server appliance.</p>

<h2 id="serial-console-pins">Serial Console Pins</h2>

<p>Video output won&rsquo;t work while installing you need to establish a serial connection to the board.</p>

<p><img src="https://blog.nobugware.com/img/h96pins.jpg" alt="" /></p>

<p>Baudrate 1500000 8N1 3.3V</p>

<h2 id="dtb">DTB</h2>

<p>DTS/DTB are <a href="https://community.arm.com/developer/tools-software/oss-platforms/w/docs/268/device-tree">Device Tree Blob</a> describing the hardware to the kernel.</p>

<p>You can extract the DTB from the Android H96 image but I&rsquo;m using <code>rk3328-t9.dtb</code> from <a href="https://forum.armbian.com/topic/8082-armbian-for-tv-box-rk3328/page/15/?tab=comments#comment-79541">armbian forum</a></p>

<h2 id="unbrick">Unbrick</h2>

<p>If you write to <code>mmcblk2</code> you may override the rockchip firmware located on the eMMC, which will result in a non booting device &hellip;</p>

<p>Since this box does not have any reset button you need to short two pins as described in this <a href="https://forum.freaktab.com/forum/tv-player-support/rockchip-based-tv-players/rk3328-devices/751175-h96-max-4-64gb-rk3328-android-8-1-tv-box-pin-unbrick-bricked">post</a>.</p>

<p>You also need a male male USB connector (it&rsquo;s a straight cable, black, green, white and red on both ends).</p>

<p>Shorts the two pins while inserting the USB cable, do not plug the power cable.</p>

<p>Find an image for the H96 somewhere or dump yours, it&rsquo;s only useful to recover the boot image, then write it to the eMMC with <a href="https://github.com/rockchip-linux/tools">upgrade_tool</a></p>

<pre><code>sudo ./upgrade_tool uf RK3328-H96MAX+_hs2734_8.1.0_20180823.1108.img
</code></pre>

<h2 id="installation">Installation</h2>

<p>Prepare an SD card as described in the <a href="https://archlinuxarm.org/platforms/armv8/rockchip/rock64">Rock64 Arch installation</a>.</p>

<p>Note the output of <code>blkid</code> for this partition.</p>

<p>Before unmounting root, create a new file <code>root/boot/boot.txt</code>.</p>

<pre><code>part uuid ${devtype} ${devnum}:${bootpart} uuid
setenv bootargs console=ttyS2,1500000 root=UUID=a3490212-03b6-46a6-9e6b-7733513a3efa storagemedia=emmc rw rootwait earlycon=uart8250,mmio32,0xff130000
setenv fdtfile rockchip/rk3328-t9.dtb

if load ${devtype} ${devnum}:${bootpart} ${kernel_addr_r} /boot/Image; then
if load ${devtype} ${devnum}:${bootpart} ${fdt_addr_r} /boot/dtbs/${fdtfile}; then
              fdt addr ${fdt_addr_r}
              fdt resize
              if load ${devtype} ${devnum}:${bootpart} ${ramdisk_addr_r} /boot/initramfs-linux.img; then
                booti ${kernel_addr_r} ${ramdisk_addr_r}:${filesize} ${fdt_addr_r};
              else
                booti ${kernel_addr_r} - ${fdt_addr_r};
        fi;
    fi;
fi
</code></pre>

<p>Copy the dtb file:</p>

<pre><code>cp rk3328-t9.dtb root/boot/dtbs/rockchip
</code></pre>

<p>Update the bootloader:</p>

<pre><code>cd root/boot
mkimage -A arm -O linux -T script -C none -n &quot;U-Boot boot script&quot; -d boot.txt boot.scr
</code></pre>

<p><code>mkimage</code> is provided by <code>uboot-tools</code> on Arch.</p>

<p>Mainline kernel won&rsquo;t work properly for now here is a copy <a href="https://drive.google.com/file/d/1dq-Ap_Fq4okR9tkDGN66QeN2b0zjmLCU/view?usp=sharing">ayufan kernel 1187</a> untar in root/boot</p>

<p>This is a one time thing only&hellip;</p>

<h3 id="first-boot">First boot</h3>

<p>Boot with the SD, you should be able to see <code>/dev/mmblck2</code>. It should be safe to write after the block  32768, create a partition, (it&rsquo;s here I&rsquo;ve bricked then unbricked mine).</p>

<pre><code>Device         Boot Start       End   Sectors  Size Id Type
/dev/mmcblk2p1      32768 122142719 122109952 58.2G 83 Linux
</code></pre>

<p>You can safely perform a normal Arch install on it, then remember to modify the UUID in <code>boot.txt</code> from the SD Card to boot / from the newly created <code>/dev/mmblck2p1</code> partition, (the SD card is /dev/mmblck0).</p>

<p>Reboot, the SD card is only needed to find the kernel, the rest is read off the eMMC.</p>

<h3 id="kernel-updates">Kernel Updates</h3>

<p>Until mainline is stable for the rk3328, you can use my updated <a href="https://gist.github.com/akhenakh/60a4b859d294b585975bc1d8efae9b62#file-pkgbuild">Arch rockchip ayufan pkg</a>.</p>

<pre><code>mount /dev/mmblck0 /mnt
mount --bind /mnt/boot /boot
cd linux-aarch64-rock64-bin
makepkg -si
</code></pre>

<h2 id="stability">Stability</h2>

<p>I had tons of issues but it seems it was related to USB 3.0.</p>

<p>I&rsquo;ve blacklisted video output since it&rsquo;s not used , create <code>/etc/modprobe.d/video-blacklist.conf</code></p>

<pre><code>blacklist mali 
blacklist dw_hdmi_i2s_audio
</code></pre>

<p>Do not use USB 3 port and you should be fine, (until mainline is stable).</p>

<h2 id="3d-printed-rack">3D Printed rack</h2>

<p>Since this board is not standard, I&rsquo;ve made a <a href="https://cad.onshape.com/documents/91ef013acb34326b25db60e8/w/cd6f81aa178f365197c89a2e/e/92c8a87d4865815b6fd95caf">3D printed rack</a> for the H96 and with a support for Rpis/Odroid and Rock64.</p>

<p><img src="https://blog.nobugware.com/img/h96rack.jpg" alt="" /></p>

<h2 id="conclusions">Conclusions</h2>

<p>It should be possible to boot directly from the eMMC without the SD Card.</p>

<p>This board is incredibly fast and convenient for the price, it&rsquo;s a perfect target to play with edge clusters.<br />
It&rsquo;s a bit hacky and I don&rsquo;t recommend it if you are not ready to debug from a serial console.</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">22 May 2019, 00:00</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.nobugware.com/post/2019/arch-on-rock64-with-usb-boot/" class="post-title">Arch on Rock64 with USB boot</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<p>Here are my notes to install <a href="https://www.archlinux.org/">Arch</a> on a <a href="https://wiki.pine64.org/index.php/ROCK64_Main_Page">Rock64</a> and boot on USB first.</p>

<p>Warning, you can brick your device (but can unbrick it), you are on your own.</p>

<ul>
<li>Follow Arch Instructions to <a href="https://archlinuxarm.org/platforms/armv8/rockchip/rock64">Install on an SD Card</a></li>
<li>Boot on it</li>
<li>Insert your USB device and follow the exact same installation but this time to the <code>/dev/sda</code>device<br />
At the end<br />
Mount / into <code>root</code> again
Run <code>blkid</code> to grab the UUID of your /</li>
</ul>

<pre><code>  /dev/sda1: UUID=&quot;a3490212-03b6-46a6-9e6b-7733513a3efa&quot; TYPE=&quot;ext4&quot;  
</code></pre>

<p>Add the file <code>root/boot/boot.txt</code> as follow and recopy your own UUID</p>

<pre><code>              # MAC address (use spaces instead of colons)
              setenv macaddr da 19 c8 7b 6d bd

              part uuid ${devtype} ${devnum}:${bootpart} uuid
              setenv bootargs console=ttyS2,1500000 root=UUID=a3490212-03b6-46a6-9e6b-7733513a3efa rw rootwait earlycon=uart8250,mmio32,0xff130000
              setenv fdtfile rockchip/rk3328-rock64.dtb

              if load ${devtype} ${devnum}:${bootpart} ${kernel_addr_r} /boot/Image; then
                if load ${devtype} ${devnum}:${bootpart} ${fdt_addr_r} /boot/dtbs/${fdtfile}; then
                  fdt addr ${fdt_addr_r}
                  fdt resize
                  fdt set /ethernet@ff540000 local-mac-address &quot;[${macaddr}]&quot;
                  if load ${devtype} ${devnum}:${bootpart} ${ramdisk_addr_r} /boot/initramfs-linux.img; then
                    booti ${kernel_addr_r} ${ramdisk_addr_r}:${filesize} ${fdt_addr_r};
                  else
                    booti ${kernel_addr_r} - ${fdt_addr_r};
                  fi;
                fi;
              fi
</code></pre>

<p>Then write it to the scr</p>

<pre><code>  cd root/boot
  pacman -S uboot-tools
  mkimage -A arm -O linux -T script -C none -n &quot;U-Boot boot script&quot; -d boot.txt boot.scr
</code></pre>

<p>Reboot and remove the USB device</p>

<ul>
<li>Download a dedicated image labelled <a href="https://github.com/ayufan-rock64/linux-u-boot/releases/download/2017.09-rockchip-ayufan-1045-g9922d32c04/u-boot-flash-spi-rock64.img.xz">u-boot-flash-spi-rock64.img.xz</a> from ayufan&rsquo;s github</li>
<li>Burn it to an SD Card, turn on your Rock64, wait for the white LED to flash several at 1 second frequency</li>
<li>Turn it off, remove the SC Card, insert the USB device, it should now boot on your USB device</li>
</ul>

<h2 id="btrfs">BTRFS</h2>

<p>Here is a config for a ext4 /boot and / btrfs.</p>

<pre><code>mount -o noatime,ssd,compress=lzo,subvol=@root /dev/sda2 root
mount /dev/sda1 root/boot
cd root/boot
mkimage -A arm -O linux -T script -C none -n &quot;U-Boot boot script&quot; -d boot.txt boot.scr
</code></pre>

<p>And the matching boot.txt</p>

<pre><code># After modifying, run ./mkscr
# MAC address (use spaces instead of colons)
setenv macaddr da 19 c8 7a 6d f4
part uuid ${devtype} ${devnum}:${bootpart} uuid
setenv bootargs console=ttyS2,1500000 rootfstype=btrfs root=UUID=7ba94ef7-a453-495a-a93c-a6cdb875b28e rootflags=subvol=@root rw rootwait earlycon=uart8250,mmio32,0xff130000
setenv fdtfile rockchip/rk3328-rock64.dtb
if load ${devtype} ${devnum}:${bootpart} ${kernel_addr_r} /Image; then
  if load ${devtype} ${devnum}:${bootpart} ${fdt_addr_r} /dtbs/${fdtfile}; then
    fdt addr ${fdt_addr_r}
    fdt resize
    fdt set /ethernet@ff540000 local-mac-address &quot;[${macaddr}]&quot;
    if load ${devtype} ${devnum}:${bootpart} ${ramdisk_addr_r} /initramfs-linux.img; then
      booti ${kernel_addr_r} ${ramdisk_addr_r}:${filesize} ${fdt_addr_r};
    else
      booti ${kernel_addr_r} - ${fdt_addr_r};
    fi;
  fi;
</code></pre>

<p>Do not used <code>zstd</code> compression for now since it was not available in 4.4 ayufan kernel you may find yourself stuck with a filesystem you cannot read back in older kernel (been there).</p>

<h2 id="kernel">Kernel</h2>

<p>I&rsquo;ve tried mainline 5.1 kernel for days, with a lot of instabilities, memory corruption, compilator crashed.<br />
It looked like cpu overheating problems but was not, simply downgraded to 4.4 ayufan kernel and everything went back to normal.</p>

<p>You can install <code>linux-aarch64-rock64-bin</code> from AUR or used <a href="https://gist.github.com/akhenakh/60a4b859d294b585975bc1d8efae9b62">mine more recent AUR packages</a>.</p>

<h2 id="stability">Stability</h2>

<p>USB 3 port is unstable with ayufan kernel, hopefully it may be fixed in mainline.</p>

<p>Disabling uas for your usb key seems to improve a lot.</p>

<p>Identify your USB storage with <code>lsusb -v</code></p>

<p>Add usb-storage module loading options identifying your device on your bootargs in <code>/boot/boot.txt</code></p>

<pre><code>setenv bootargs console=ttyS2,1500000 rootfstype=btrfs root=UUID=c9136915-614c-4203-ba8d-5f2f202ffbcd rootflags=subvol=@root usb-storage.quirks=0x078
1:0x5588:u rw rootwait earlycon=uart8250,mmio32,0xff130000
</code></pre>

                    </div>
                </section>
                
                <h1 class="content-subhead">27 Apr 2019, 02:01</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.nobugware.com/post/2019/deploying-a-website-with-caddy-git-and-kubernetes/" class="post-title">Deploying a website with Caddy, Git and Kubernetes</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                <a class="post-category post-category-DevOps" href="https://blog.nobugware.com/categories/devops">DevOps</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<p><a href="https://caddyserver.com">Caddy</a> is the swiss army of the web server, and with the <a href="https://caddyserver.com/blog/announcing-caddy-1_0-caddy-2-caddy-enterprise">recent commercial license changes</a>, it&rsquo;s time to give it some love back.</p>

<p>I have several static websites, some generated with <a href="https://gohugo.io">Hugo</a>, some are plain HTML.<br />
I wanted a small container, to run it inside a Kubernetes cluster, capable of pulling some git repos and serve them.</p>

<h2 id="caddy-git">Caddy-git</h2>

<p>Caddy is already capable of that with the help of <a href="https://github.com/abiosoft/caddy-git">caddy-git</a> unfortunately it is only working with ssh keys.<br />
I wanted it to use <a href="https://help.github.com/en/articles/creating-a-personal-access-token-for-the-command-line">Github access token</a>, also the current implementation is relying on the <code>git</code> command and <code>sh</code>, I wanted mine to be able to run on <a href="https://github.com/GoogleContainerTools/distroless">Distroless</a>.</p>

<h2 id="minigit">Minigit</h2>

<p>I&rsquo;ve used <a href="https://github.com/src-d/go-git">go-git</a> a pure Go implementation of git, to first make a clone of the <code>git</code> command: <a href="https://github.com/akhenakh/minigit">minigit</a>.<br />
<a href="https://github.com/akhenakh/minigit">minigit</a> can be useful in devops environnements and scriptings to facilitate git pulls.<br />
Faking the <code>git</code> command with <a href="https://github.com/akhenakh/minigit/">minigit</a> into your image and tweak caddy-git to pass an extra parameter <code>--ghtoken</code></p>

<pre><code>root /public
git https://github.com/myuser/repo {
   path /public
   clone_args --ghtoken XXXXXXXXXXXXX
   pull_args --ghtoken XXXXXXXXXXXXX
   interval 3600
}
</code></pre>

<p>It&rsquo;s nice but I wanted something cleaner and get rid of the <code>sh</code> dependency, I had to fork caddy-git.</p>

<h2 id="caddy-puregit">Caddy-puregit</h2>

<p>So here is caddy-puregit, a fork without execs but native pure Go git calls.<br />
Give it your token and it will clone then pull on regular intervals.</p>

<pre><code>root /public
puregit https://github.com/myuser/repo {
   path /public
   auth_token XXXXXXXXXXXXX 
   interval 3600
}
</code></pre>

<p>I&rsquo;ve also created a <a href="https://cloud.docker.com/repository/docker/akhenakh/caddy-hugo">Caddy + Hugo image</a>, so you can trigger a Hugo build on every commits.</p>

<pre><code>root /public
puregit https://github.com/myuser/hugo-blog {
   path /data
   then hugo --destination=/public --source=/data
   auth_token XXXXXXXXXXXXX 
   interval 3600
}
</code></pre>

<p>Here is <a href="https://github.com/akhenakh/caddy-puregit">caddy-puregit</a> and associated <a href="https://cloud.docker.com/u/akhenakh/repository/docker/akhenakh/caddy">Docker image</a> &amp; <a href="https://github.com/akhenakh/goimages/blob/master/caddy/Dockerfile">Dockerfile</a></p>

<h2 id="kubernetize">Kubernetize</h2>

<p>Since Caddy supports environment variables it&rsquo;s easy to deploy in k8s:</p>

<pre><code>root /public
puregit {$REPO} {
    auth_token {$TOKEN}
}
</code></pre>

<p>Put your token into a secret and expose it as an environment variable.</p>

<p><a href="https://gist.github.com/akhenakh/f3836dc3cf6ca06a003c562dde43ff07">Here is a template</a> which will deploy caddy and pull your repo then serving it according to the config.</p>

<h2 id="notes">Notes</h2>

<p>For development purpose, to work on a new Caddy plugin you can use the <a href="https://godoc.org/github.com/mholt/caddy/caddyhttp/httpserver#RegisterDevDirective">RegisterDevDirective</a>, or you have to fork Caddy.</p>

<p>I don&rsquo;t plan on maintaining this fork but I&rsquo;ll reach out to the author since a pure Go git concept is working maybe he will be interested.</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">11 Mar 2019, 00:32</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.nobugware.com/post/2019/kubernetes_mesh_network_load_balancing_grpc_services/" class="post-title">gRPC Load Balancing inside Kubernetes</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                <a class="post-category post-category-Devops" href="https://blog.nobugware.com/categories/devops">Devops</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<h2 id="context">Context</h2>

<p>I wanted to blog about this for years: how to connect to a Kubernete&rsquo;s loadbalanced service?<br />
How to deal with disconnections/re-connections, maintenance?  What about gRPC specifically?<br />
The answer is heavily connected to the network stack used by Kubernetes, but with the &ldquo;Mesh Network&rdquo; revolution, It&rsquo;s not always clear how it works anymore and what the options are.
<br>
<br></p>

<h2 id="how-it-works">How it works</h2>

<p>First I recommend you to watch this great yet simple video: <a href="https://www.youtube.com/watch?v=6v_BDHIgOY8&amp;feature=youtu.be">Container Networking From Scratch</a>, then the <a href="https://kubernetes.io/docs/concepts/services-networking/service/#proxy-mode-iptables">Services clusterIP documentation</a>.</p>

<p>To make it simple when you create a Service in Kubernetes, it creates a layer 4 proxy and load balance connections to your pods using iptables, the service endpoint is one IP and a port hiding your real pods.</p>

<h2 id="the-problem">The Problem</h2>

<p>A simple TCP load balancer is good enough for a lot of things especially for HTTP/1.1 since connections are mainly short lived, the clients will try to reconnect often, so it won&rsquo;t stay connected to an old running pod.</p>

<p>But with gRPC over HTTP/2, a TCP connection is maintained open which could lead to issues, like staying connected to a dying pod or unbalancing the cluster because the clients will end on the older pods.</p>

<p>One solution is to use a more advanced proxy that knows about the higher layers.</p>

<p><a href="https://www.envoyproxy.io/">Envoy</a>, <a href="http://www.haproxy.org/">HAProxy</a> and <a href="https://traefik.io/">Traefik</a> are layer 7 reverse proxy load balancers, they know about HTTP/2 (even about gRPC) and can disconnect a backend’s pod without the clients noticing.</p>

<h2 id="edge">Edge</h2>

<p>On the edge of your Kubernetes cluster, you need a public IP, provided by your cloud provider via <a href="https://kubernetes.io/docs/concepts/services-networking/ingress/">the <code>Ingress</code> directive</a> it will expose your internal service.</p>

<p>To further control your request routing you need <a href="https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/">an Ingress Controller</a>.<br />
It&rsquo;s a reverse proxy that knows about the Kubernetes clusters and can direct the requests to the right place.
<a href="https://www.envoyproxy.io/">Envoy</a>, <a href="http://www.haproxy.org/">HAProxy</a> and <a href="https://traefik.io/">Traefik</a> can act as Ingress Controllers.</p>

<h2 id="internal-services-service-mesh">Internal Services &amp; Service Mesh</h2>

<p>In a Micro-services environment, most if not all your micro-services will also be clients to others micro-services.</p>

<p><a href="https://istio.io/">Istio</a>, a &ldquo;Mesh Network&rdquo; solution, use <a href="https://www.envoyproxy.io/">Envoy</a> as a <a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/">sidecar</a>. This sidecar is configured from a central place (control plane) and makes each micro-service talking to each other through Envoy.</p>

<p>This way the client does not need to know about all the topology.</p>

<p>That&rsquo;s great but in a controlled environment (yours), where you control all the clients, sending all the traffic through a proxy is not always necessary.</p>

<h2 id="client-load-balancing">Client Load Balancing</h2>

<p>In Kubernetes you can create a <a href="https://kubernetes.io/docs/concepts/services-networking/service/#headless-services">headless service</a>; where there are no load balanced single endpoints anymore, the service pods are directly exposed, Kubernetes DNS will return all of them.</p>

<p>Here is an example service called <code>geoipd</code> scaled to 3.</p>

<pre><code>Name:      geoipd
Address 1: 172.17.0.18 172-17-0-18.geoipd.default.svc.cluster.local
Address 2: 172.17.0.21 172-17-0-21.geoipd.default.svc.cluster.local
Address 3: 172.17.0.9 172-17-0-9.geoipd.default.svc.cluster.local
</code></pre>

<p>It&rsquo;s up to your client to connect them all and load balance the connections.</p>

<p>In Go gRPC client side, a simple <code>dns:///</code> notation will fetch the entries for you, then the <a href="https://godoc.org/github.com/grpc/grpc-go/balancer/roundrobin">roundrobin package</a> will handle load balancing.</p>

<pre><code class="language-Go">conn, err := grpc.Dial(
    &quot;dns:///geoip:9200&quot;,
    grpc.WithBalancerName(roundrobin.Name),
)
</code></pre>

<p>This may sound like a good solution but it is not: the default refresh frequency is 30 minutes, meaning whenever you add new pods, it can take up to 30 minutes for them to start getting traffic!
You can lower this problem by tweaking <code>MaxConnectionAge</code> on the gRPC server:</p>

<pre><code class="language-Go">gsrv := grpc.NewServer(
    // MaxConnectionAge is just to avoid long connection, to facilitate load balancing
    // MaxConnectionAgeGrace will torn them, default to infinity
    grpc.KeepaliveParams(keepalive.ServerParameters{MaxConnectionAge: 2 * time.Minute}),
)
</code></pre>

<p>Even if you could refresh the list more often you wouldn&rsquo;t know about pod eviction fast enough and you’d miss some traffic.</p>

<p>There is a nicer solution, implementing the gRPC client resolver for Kubernetes, talking to the Kubernetes API to get the endpoints and watch them constantly, this is exactly what <a href="https://github.com/sercand/kuberesolver">Kuberesolver</a> does.</p>

<pre><code class="language-Go">// Register kuberesolver to grpc
kuberesolver.RegisterInCluster()

conn, err := grpc.Dial(
    &quot;kubernetes:///geoipd:9200&quot;,
    grpc.WithBalancerName(roundrobin.Name),
)
</code></pre>

<p>By using <code>kubernetes</code> schema you tell kuberesolver to fetch and watch the endpoints for the <code>geoipd</code> service.</p>

<p>For this to work the pod must have <code>GET</code> and <code>WATCH</code> access to <code>endpoints</code> using a role:</p>

<pre><code>kubectl create role pod-reader-role --verb=get --verb=watch --resource=endpoints,services 
kubectl create sa pod-reader-sa 
kubectl create rolebinding pod-reader-rb --role=pod-reader-role --serviceaccount=default:pod-reader-sa 
</code></pre>

<p>Redeploy your app (the client) with the service account:</p>

<pre><code class="language-yaml">spec:
  serviceAccountName: pod-reader-sa
</code></pre>

<p>Deploy, scale up, scale down, kill your pods, your client is still sending traffic to a living pod !</p>

<p>I&rsquo;m surprised it&rsquo;s not mentioned more often, client load balancing did the job for years, the same apply inside Kubernetes environment.<br />
It is fine for small to medium projects and can deal with a lot of traffic, this will do it for many of you unless if you are Netflix sized&hellip;</p>

<h2 id="conclusion">Conclusion</h2>

<p>Load-balancing proxies are great tools, especially useful on the edge of your platform. &ldquo;Mesh Network&rdquo; solutions are nice additions to our tool set, but the cost of operating and debugging a full mesh network could be really expensive and overkill in some situations, while a client load balancing solution is simple and easy to grasp.</p>

<p>Thanks to <a href="https://github.com/prune998">Prune</a> who helped me with this post, and to <a href="https://twitter.com/robteix">Robteix</a> &amp; <a href="https://twitter.com/diligiant">diligiant</a> for reviewing.</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">04 Mar 2019, 00:32</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.nobugware.com/post/2019/traefik_load_balancing_grpc_services_trace_propagation/" class="post-title">Traefik gRPC Load Balancing and Traces Propagation</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                <a class="post-category post-category-Devops" href="https://blog.nobugware.com/categories/devops">Devops</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<p>Following my recent <a href="https://blog.nobugware.com/post/2019/kubernetes_quick_development_setup_minikube_prometheus_grafana/">blog post on setting up a dev environment in Kubernetes</a>, here are some tips to use <a href="https://traefik.io">Traefik</a> as a gRPC load balancer.</p>

<p><a href="https://traefik.io">Traefik</a> can be used on the edge and route incoming HTTP traffic to your Kubernetes cluster, but it&rsquo;s also <a href="https://docs.traefik.io/user-guide/grpc/">supporting gRPC</a>.<br />
<br/>
<br/>
<br/></p>

<h2 id="grpc-load-balancing-with-traefik">gRPC Load Balancing with Traefik</h2>

<p>Here I have a gRPC service I want to expose on the edge.</p>

<pre><code class="language-yaml">apiVersion: v1
kind: Service
metadata:
  name: myapp
  labels:
    name: &quot;myapp&quot;
    type: &quot;grpc&quot;
spec:
  ports:
    - port: 9200
      name: &quot;grpc&quot;
      targetPort: grpc
      protocol: TCP
  selector:
    app: &quot;myapp&quot;
  clusterIP: None
</code></pre>

<p>Note the <code>clusterIP: None</code>, it&rsquo;s a <a href="https://kubernetes.io/docs/concepts/services-networking/service/#headless-services">headless service</a>.</p>

<p>It will create a non loadbalanced service, pod&rsquo;s services can be accessed directly.</p>

<pre><code>myapp.default.svc.cluster.local.    2       IN      A       172.17.0.19
myapp.default.svc.cluster.local.    2       IN      A       172.17.0.10
myapp.default.svc.cluster.local.    2       IN      A       172.17.0.16
</code></pre>

<p>Here is the ingress for Traefik.</p>

<pre><code class="language-yaml">apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: myapp-ingress
  namespace: default
  labels:
    name: &quot;myapp&quot;
  annotations:
    ingress.kubernetes.io/protocol: h2c
spec:
  rules:
  - host: myapp-lb.minikube
    http:
      paths:
      - path: /
        backend:
          serviceName: myapp
          servicePort: 9200
</code></pre>

<p>Note the <code>h2c</code> prefix, indicating HTTP2 protocol without TLS to your backend !</p>

<p><img src="https://blog.nobugware.com/img/grpctraefik.jpg" alt="Traefik" /></p>

<h2 id="tracing">Tracing</h2>

<p>Traefik can be <a href="https://docs.traefik.io/configuration/tracing/">configured to emit tracing</a>.</p>

<p>I&rsquo;m using <a href="https://medium.com/@rghetia/distributed-tracing-and-monitoring-using-opencensus-fe5f6e9479fb"><code>ocgrpc</code> Opencensus</a>, for gRPC metrics &amp; traces.<br />
It automatically emits several counters for gRPC and traces using the <a href="https://godoc.org/google.golang.org/grpc#StatsHandler">StatsHandler</a>.</p>

<p>Unfortunately <a href="https://github.com/census-instrumentation/opencensus-go/issues/838"><code>ocgrpc</code> does not yet propagate Jaeger traces</a>, I&rsquo;ve <a href="https://github.com/akhenakh/ocgrpc_propagation">temporary forked it to support Jaeger</a>.</p>

<p>As you can see you can follow the request from Traefik down to your services.</p>

<p><img src="https://blog.nobugware.com/img/jaegergrpc.jpg" alt="Jaeger" /></p>

<p>Happy tracing !</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">21 Feb 2019, 00:19</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.nobugware.com/post/2019/kubernetes_quick_development_setup_minikube_prometheus_grafana/" class="post-title">Kubernetes Quick Setup with Prometheus, Grafana &amp; Jaeger</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                <a class="post-category post-category-Devops" href="https://blog.nobugware.com/categories/devops">Devops</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<h2 id="introduction">Introduction</h2>

<p>When starting on a new project or prototyping on a new idea, I find myself doing the same tasks again and again.<br />
Thanks to Kubernetes it&rsquo;s possible to setup a new env from scratch really fast.</p>

<p>Here is a quick setup (mostly notes) to create a dev environment using Minikube and the workflow I&rsquo;m using with it.</p>

<p>Not knowing in advance where this future project will be hosted, I try to stay platform agnostic.<br />
<a href="https://opencensus.io">OpenCensus</a> or <a href="https://opentracing.io">OpenTracing</a> can abstract the target platform, letting you choose what tooling you want for your dev.</p>

<p>I consider some tools to be mandatory these days:</p>

<ul>
<li><a href="https://www.jaegertracing.io/">Jaeger</a> for tracing</li>
<li><a href="https://prometheus.io/">Prometheus</a> for instrumentation/metrics</li>
<li><a href="https://grafana.com">Grafana</a> to display these metrics</li>
<li>A logging solution: this is already taken care of by Kubernetes and depends on your cloud provider (StackDriver on GCP&hellip;), otherwise use another tool like ELK stack.<br />
On your dev, plain structured logs to stdout with Kubernetes dashboard or <a href="https://github.com/wercker/stern">Stern</a> should be fine.</li>
<li>A messaging system: for example <a href="https://nats.io/">NATS</a> but out of the scope of this post.</li>
</ul>

<h2 id="tools-installation">Tools Installation</h2>

<p>I find it easier to let Minikube open reserved ports, but not mandatory:</p>

<pre><code class="language-bash">minikube start --extra-config=apiserver.service-node-port-range=80-30000
</code></pre>

<p>I&rsquo;ll use <a href="https://traefik.io">Traefik</a> as Ingress to simplify access to several admin UI later.</p>

<p>I&rsquo;m not a big fan of <code>helm</code>, so here is a little trick, I&rsquo;m only using <code>helm</code> to create my deployment templates, using the charts repo as a source template, so I can commit or modify the resulting generated files. (Thanks <a href="https://twitter.com/prune998">Prune</a> for this tips).</p>

<pre><code class="language-bash">git clone git@github.com:helm/charts.git 

helm template charts/stable/traefik --name traefik --set metrics.prometheus.enabled=true --set rbac.enabled=true \
--set service.nodePorts.http=80 --set dashboard.enabled=true --set dashboard.domain=traefik-ui.minikube &gt; traefik.yaml 

helm template charts/stable/grafana --name grafana --set ingress.enabled=true \ 
--set ingress.hosts\[0\]=grafana.minikube --set persistence.enabled=true --set persistence.size=100Mi &gt; grafana.yaml 

helm template charts/stable/prometheus --name prometheus --set server.ingress.enabled=true \ 
--set server.ingress.hosts\[0\]=prometheus.minikube --set alertmanager.enabled=false \ 
--set kubeStateMetrics.enabled=false --set nodeExporter.enabled=false --set server.persistentVolume.enabled=true \
--set server.persistentVolume.size=1Gi --set pushgateway.enabled=false &gt; prometheus.yaml 
</code></pre>

<p>A lot more templates are available: NATS, Postgresql &hellip;</p>

<p>For Jaeger a <a href="https://raw.githubusercontent.com/jaegertracing/jaeger-kubernetes/master/all-in-one/jaeger-all-in-one-template.yml">development ready solution</a> exists, here is mine slightly tweaked to use an ingress:</p>

<pre><code>curl -o jaeger.yaml https://gist.githubusercontent.com/akhenakh/615686891340f5306dcbed82dd1d9d67/raw/41049afecafb05bc29de3b0d25208c784f963695/jaeger.yaml
</code></pre>

<p>Deploy to Minikube (ensure your current context is <code>minikube</code>&hellip;), if you need to work on several projects at the same time remember you can use Kubernetes namespaces, (beware some helm templates are overriding it).</p>

<pre><code class="language-bash">kubectl create -f traefik.yaml
kubectl create -f jaeger.yaml
kubectl create -f grafana.yaml
kubectl create -f prometheus.yaml
</code></pre>

<p>Again to ease my workflow I want Traefik to bind 80, edit the service and change it to <code>nodePort 80</code>.</p>

<pre><code>kubectl edit service traefik
</code></pre>

<p>Add some urls to your <code>/etc/hosts</code></p>

<pre><code class="language-bash">echo &quot;$(minikube ip) prometheus.minikube&quot; | sudo tee -a /etc/hosts 
echo &quot;$(minikube ip) grafana.minikube&quot; | sudo tee -a /etc/hosts 
echo &quot;$(minikube ip) traefik-ui.minikube&quot; | sudo tee -a /etc/hosts
echo &quot;$(minikube ip) jaeger.minikube&quot; | sudo tee -a /etc/hosts
</code></pre>

<p>Point your browser to any of these addresses and you are good to go !</p>

<h2 id="deploy-your-own-apps">Deploy your own apps</h2>

<p>First remember to always use the Kubernetes Docker:</p>

<pre><code class="language-bash">eval `minikube docker-env` 
</code></pre>

<p>My applications are reading parameters from environment, in Go, I&rsquo;m using <a href="http://github.com/namsral/flag">namsral/flag</a>, so the flag <code>-httpPort</code> is also set by the environment variable <code>HTTPPORT</code>.</p>

<p>I then use templates, where I set all my environment variables, to create my yaml deployment.</p>

<p><a href="https://gist.github.com/akhenakh/8c06186b7d524f6a60d40764b307a5d5">https://gist.github.com/akhenakh/8c06186b7d524f6a60d40764b307a5d5</a></p>

<p>So typical Makefile targets would fill the template with <code>envsubst</code>:</p>

<pre><code class="language-Makefile">.EXPORT_ALL_VARIABLES:
VERSION := $(shell git describe --always --tags)
DATE := $(shell date -u +%Y%m%d.%H%M%S)
LDFLAGS := -ldflags &quot;-X=main.version=$(VERSION)-$(DATE)&quot;
CGO_ENABLED=0
GOOS=linux
GOARCH=amd64
PROJET = mysuperproject
...

helloworld: 
	cd helloworld/cmd/helloworld &amp;&amp; go build $(LDFLAGS)

helloworld-image: helloworld
	cd helloworld/cmd/helloworld &amp;&amp; docker build -t helloworld:$(VERSION) .

helloworld-deploy: NAME=helloworld
helloworld-deploy: helloworld-image 
	cat deployment/project-apps.yaml | envsubst | kubectl apply -f - 
	cat deployment/project-services.yaml | envsubst | kubectl apply -f - 

project-undeploy:
    kubectl delete --ignore-not-found=true deployments,services,replicasets,pods --selector=appgroup=$(PROJECT)
</code></pre>

<p><code>Dockerfile</code> contains nothing but <code>FROM gcr.io/distroless/base</code> and a copy of the helloworld binary.</p>

<p>Note all this setup is <strong>only good for your dev</strong>, production deployment is another story.</p>

<p><code>make helloworld-deploy</code>, compilation, image creation and deployment is less than 2s over here!</p>

<h2 id="shell-tool">Shell tool</h2>

<p>Another useful trick when working with new tools is to have a shell available inside Kubernetes to experiment with.</p>

<p>Create an image for this purpose, and copy your tools and clients.</p>

<pre><code class="language-Dockerfile">FROM alpine:3.9
RUN apk add --no-cache curl busybox-extras tcpdump

WORKDIR /root/
COPY helloworldcli .
ENTRYPOINT [&quot;tail&quot;, &quot;-f&quot;, &quot;/dev/null&quot;]
</code></pre>

<p>And the relevant Makefile targets:</p>

<pre><code class="language-Makefile">debugtool-image: helloworldcli
	cp helloworld/cmd/helloworldcli/helloworldcli debugtool/helloworldcli
	cd debugtool &amp;&amp; docker build  -t debugtool:latest .
	rm -f debugtool/helloworldcli

debugtool-deploy: debugtool-image
	kubectl delete --ignore-not-found=true pod debugtool
	sleep 2
	kubectl run --restart=Never --image=debugtool:latest --image-pull-policy=IfNotPresent debugtool

debugtool-shell:
	kubectl exec -it debugtool -- /bin/sh 
</code></pre>

<p>By calling <code>make debugtool-shell</code>, you&rsquo;ll be connected on a shell inside Kubernetes.</p>

<h2 id="conclusion">Conclusion</h2>

<p>Hope this will help some of you, I would love to hear your own tricks and setup to develop on Minikube !</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">27 Aug 2018, 00:19</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.nobugware.com/post/2018/wasm_go_s2_javascript/" class="post-title">Wasm with Go to build an S2 cover map viewer</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                <a class="post-category post-category-Go" href="https://blog.nobugware.com/categories/go">Go</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<p>I needed a reason to use <a href="https://golang.org/doc/go1.11#wasm">the new Go 1.11 Wasm port</a> for &ldquo;real&rdquo;.</p>

<p>To make it short, it compiles Go code to <a href="https://webassembly.org/">Wasm</a> binary format for a virtual machine running in web browsers.</p>

<p>I&rsquo;ve always needed a debug tool to display <a href="https://blog.nobugware.com/post/2016/geo_db_s2_geohash_database/">S2 Cells</a> on a map for different shapes, some online tools already exist:</p>

<ul>
<li><a href="http://s2map.com">s2map.com</a> unfortunately the backend is often/currently dead.</li>
<li><a href="https://s2.sidewalklabs.com/regioncoverer/">regioncoverer</a> which doesn&rsquo;t allow polygons.</li>
</ul>

<p>I&rsquo;ve planned for a Qt Go app or a QGIS plugin with C++ bindings to Python but to ship those modules would be a nightmare.</p>

<p>I needed another solution, a simple web app would do it, not very complicated but since I hate HTML/CSS/js, I&rsquo;ve never bothered to start one&hellip;<br />
The s2map solution was great but having to start a backend and pay for it, was a no go for the long run, plus since I work with Go I needed something that was relying on the S2 Go port for matching results.</p>

<p>So here I am doing some web dev&hellip;</p>

<h2 id="wasm-go">Wasm &amp; Go</h2>

<p>First Wasm is not the best solution (GopherJS maybe is) to my problem but hey it&rsquo;s working.</p>

<p>The <code>main()</code> is a bit weird but close enough to a normal Go program:</p>

<pre><code class="language-Go">func registerCallbacks() {
	js.Global().Set(&quot;geocell&quot;, js.NewCallback(geoJSONToCells))
}

func main() {
	c := make(chan struct{}, 0)
	println(&quot;Wasm ready&quot;)
	registerCallbacks()
	&lt;-c
}
</code></pre>

<p>Since our function <code>geocell()</code> will be called by js, we wait for a channel that will never be triggered so the main loop won&rsquo;t return.</p>

<p><code>NewCallback()</code> wants a <code>fn func(event Value)</code> it means <strong>you can&rsquo;t return directly from Go to js</strong> &hellip;</p>

<pre><code class="language-Go">func geoJSONToCells(i []js.Value)  
</code></pre>

<p>Just a slice of untyped values thank you js.</p>

<p>All other functions (not exposed to js) can be normal Go functions, packages &hellip;</p>

<p>Interaction with the DOM is very limited via the package <a href="https://tip.golang.org/pkg/syscall/js/?GOOS=js&amp;GOARCH=wasm">syscall/js</a><br />
So far, to update back the UI (from Go to  js), I pass the result of the computation via a set and call the js method, very hackish &hellip;</p>

<pre><code class="language-Go">func updateUIWithData(data string) {
	js.Global().Set(&quot;data&quot;, data)
	js.Global().Call(&quot;updateui&quot;)
}
</code></pre>

<p>The <code>updateui()</code> is a regular js function that processes <code>data</code> and updates the DOM.</p>

<h2 id="app">App</h2>

<p>The app is calling a lot of Go code and libraries that were not written for the web but are now executed from a webpage without any backends:</p>

<ul>
<li>the web interface creates a shape on a js Leaflet layer</li>
<li>exports the shape in GeoJSON</li>
<li>serializes it to JSON</li>
<li>calls the <code>geoJSONToCells()</code> func passing the JSON as string argument</li>
<li>computes the S2 cells in the Go world</li>
<li>sets the result back via a js var containing GeoJSON as string</li>
<li>reads back this GeoJSON and displays it as a Leaflet layer</li>
</ul>

<p>The first loading and running of the Wasm is very slow on Chrome but not on Firefox, the execution itself is really fast.</p>

<p><a href="https://s2.inair.space"><img src="https://blog.nobugware.com/img/ws2.jpg" alt="ws2" /></a></p>

<p>Code is on <a href="https://github.com/akhenakh/ws2">Github</a> and <a href="https://s2.inair.space/">Demo is hosted on Github Pages at https://s2.inair.space</a>, sorry folks Wasm works on phones but the demo won&rsquo;t be very useful on mobile.</p>

<h2 id="size">Size</h2>

<p>You can argue 11M (1.5M gzipped) is too big for a webapp providing only one functionality, and you are probably right (then look at a modern webpage), but how big would be a Python app shipped with the C++ library or a full Qt app &hellip;</p>

<p>Also the size could be a non-issue, in a near future, a solution like <a href="https://github.com/dave/jsgo">jsgo.io</a> could provide package level CDN caching.</p>

<h2 id="conclusion">Conclusion</h2>

<p>Again you should have really good reasons to use Wasm, the back and forth between js &amp; Wasm is nonsense, but the tooling will improve and I&rsquo;m sure we will see plenty of solutions around it (one is gRPC in the browser).</p>

<p>EDIT: <code>Call()</code> can call a js method no need for eval !</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">01 Aug 2018, 00:19</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.nobugware.com/post/2018/my_own_car_system_raspberry_pi_offline_mapping_map_matching_places_part2/" class="post-title">My Own Car System, Rear Camera, Offline Maps &amp; Routing, Map Matching with Go on Raspberry Pi part II</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                <a class="post-category post-category-Geo" href="https://blog.nobugware.com/categories/geo">Geo</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<p>This is my journey building an open source car system with Go &amp; Qt, rear camera, live OpenGL map &hellip;</p>

<h2 id="cross-compilation">Cross compilation</h2>

<p><a href="https://blog.nobugware.com/post/2018/my_own_car_system_raspberry_pi_offline_mapping/">In Part I</a>, I had to patch qtmultimedia for the camera to work, but Qt compilation is resource hungry, same goes for the osrm compilation, the memory of the Raspberry Pi is too small.</p>

<p>I had to to set up a <a href="https://wiki.archlinux.org/index.php/Distcc#Arch_Linux_ARM">cross compilation system</a> in my case for armv7h.</p>

<h2 id="qml-development">QML Development</h2>

<p>Since most of the application is in <a href="https://en.wikipedia.org/wiki/QML">QML</a>, I&rsquo;ve used the c++ <code>main.cpp</code> launcher as long as possible for the development.<br />
At the moment I needed to inject data from the outside world (like the GPS location) to QML via Qt, so I switched to Go using <a href="https://github.com/therecipe/qt">therecipe Qt Go bindings</a>.</p>

<p>The Go bindings project is young but the main author is really active fixing issues.</p>

<p>It makes desktop applications easy to code without the assle of C++ (at least for me).</p>

<p>About QML, by separating the logic and forms using <code>.qml.ui</code> you still can edit your views with <a href="https://wiki.qt.io/Qt_Creator">Qt Creator</a>:<br />
That&rsquo;s just the narrative, truth is Creator is really buggy and I edited the ui files by hand most of the time.<br />
I worked with Interface Builder on iOS for years, Qt is painful, lack of decent visual editor for QML really hurts.</p>

<h2 id="serving-the-map-without-internet-access">Serving the map without internet access</h2>

<p><a href="https://blog.nobugware.com/post/2018/my_own_car_system_raspberry_pi_offline_mapping/">In Part I</a>, we talked about OpenMapTiles and OpenGL rendering, but I needed a web server capable of reading MBTiles format and serving the necessary assets for the map to be rendered.</p>

<p>I&rsquo;ve created <a href="https://github.com/akhenakh/mbmatch">mbmatch</a> in Go for that purpose so <a href="https://github.com/akhenakh/mocs">mocs</a> can render the map without Internet access, it will also map match the positions in the future.</p>

<h2 id="experimenting-with-another-touch-screen">Experimenting with another touch screen</h2>

<p>I&rsquo;m using a less performant but smaller <a href="https://www.amazon.ca/gp/product/B01I9DS2G8">LANDZO 5 Inch Touch Display</a> 800x480<br />
This touchscreen is handled as a one button mouse.</p>

<p>It can be calibrate using <a href="https://github.com/kergoth/tslib/">tslib</a> <code>ts_calibrate</code> command.</p>

<p>Then in your start env tell Qt to use tslib.</p>

<pre><code>TSLIB_TSDEVICE=/dev/input/event0
QT_QPA_GENERIC_PLUGINS=tslib:/dev/input/event0
QT_QPA_FB_TSLIB=1
</code></pre>

<h2 id="gps">GPS</h2>

<p>Like I said in <a href="https://blog.nobugware.com/post/2018/my_own_car_system_raspberry_pi_offline_mapping/">part I</a>, the Linux gps daemons are using obscure and over complicated protocols so <a href="https://xkcd.com/927/">I&rsquo;ve decided</a> to write my own gps daemon in Go using a gRPC stream interface. You can <a href="https://github.com/akhenakh/gpsd">find it here</a>.</p>

<p>I&rsquo;m also not satisfied with the map matching of OSRM for real time display, I may rewrite one using <a href="https://github.com/akhenakh/mbmatch">mbmatch</a>.</p>

<h2 id="pois">POIs</h2>

<p>I&rsquo;ve started POIs lookups with full text search and geo proximity using <a href="http://github.com/blevesearch/bleve">bleve</a> by exposing an API compatible with the OSM API so it can be used directly by QML Locations.</p>

<h2 id="night-map">Night Map</h2>

<p>I&rsquo;m a huge fan of the <a href="https://github.com/altercation/solarized">Solarized colors</a>, I&rsquo;ve made a style for the map you can find it <a href="https://github.com/akhenakh/mocs/blob/master/external/solarized-dark.style">here</a></p>

<p><img src="https://blog.nobugware.com/img/mocssolarized.jpg" alt="Solarized" /></p>

<h2 id="speeding-up-boot">Speeding up boot</h2>

<pre><code>systemctl mask systemd-udev-settle.service
systemctl mask lvm2-activation-net.service
systemctl mask lvm2-monitor.service
</code></pre>

<h2 id="status">Status</h2>

<p>The project is far from finished and not ready for everybody but it&rsquo;s fun to play with.</p>

<p>I&rsquo;ve <a href="https://github.com/akhenakh/mocs">open sourced most of the code for Mocs on github</a>, feel free to contribute.</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">10 Jun 2018, 09:19</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.nobugware.com/post/2018/my_own_car_system_raspberry_pi_offline_mapping/" class="post-title">My Own Car System, Rear Camera, Offline Maps &amp; Routing on Raspberry Pi part I</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                <a class="post-category post-category-Geo" href="https://blog.nobugware.com/categories/geo">Geo</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<p>At first I needed a car rear camera, one thing led to another&hellip;</p>

<p>My Car, from 2011, only has an LCD display and no rear camera, so I bought a <a href="https://www.amazon.ca/gp/product/B06ZY949CF">PAL rear camera</a>, we passed some cables from the rear window to the front then everything begun.<br />
Here is my journey to transform my car into a modern system running on RPi3 (a never ending project).</p>

<h2 id="hardware">Hardware</h2>

<p>I&rsquo;m using an Rpi3 (old model).</p>

<p>With <a href="https://archlinuxarm.org">Arch for ARM</a> but any system will do.</p>

<p>The screen is an <a href="https://www.amazon.ca/gp/product/B019K6CRVY/ref=oh_aui_search_detailpage?ie=UTF8&amp;psc=1">Eleduino Raspberry Pi 7 Inch 1024x600 Pixel IPS Hdmi Input Capacitive Touch Screen Display</a><br />
An <a href="https://www.ebay.ca/itm/USB-2-0-Easycap-Video-With-Audio-VHS-DC60-to-DVD-Converter-Capture-Card-Adapter-/142504839503?hash=item212df3494f&amp;_uhb=1">USB 2.0 EasyCap</a> to retrieve the composite signal.</p>

<p>No driver needed for both the screen and the video capture dongle.</p>

<pre><code>mplayer tv:// -tv driver=v4l2:device=/dev/video0:fps=25:outfmt=yuy2:norm=PAL
</code></pre>

<p><img src="https://blog.nobugware.com/img/rearcam.jpg" alt="Camera" /><br />
mplayer is working out of the box, so I thought everything was okay with the camera, so I thought.</p>

<p>I needed a GUI to display the camera and the date (at this this time this project was just a rear camera display).<br />
So I choose <a href="https://github.com/therecipe/qt">Qt &amp; Golang</a>, not the normal contenders but I can&rsquo;t handle C++ and had experiences with QtGo, and modern Qt apps are just QML code anyway&hellip; So I thought&hellip;</p>

<p>I&rsquo;ve started to code a small QML app but when displaying the video I got:</p>

<pre><code>ERROR: from element /GstPipeline:pipeline0/GstV4l2Src:v4l2src0: Device '/dev/video0' does not support progressive interlacing
Additional debug info:
gstv4l2object.c(3768): gst_v4l2_object_set_format_full (): /GstPipeline:pipeline0/GstV4l2Src:v4l2src0:
Device wants interleaved interlacing
</code></pre>

<p>Qt via Gstreamer does not allow non interlaced videos :(<br />
One solution is to force a pipeline with an interlacer.</p>

<p>Easy on the command line
<code>gst-launch-1.0 v4l2src  ! interlace ! xvimagesink</code></p>

<p>Not that easy via Qt I had to patch the Qt Gstreamer plugin <code>camerabinsession.cpp</code> to insert a filter on the preview:
at the end of <code>GstElement *CameraBinSession::buildCameraSource()</code></p>

<pre><code class="language-c++">    const QByteArray envInterlace = qgetenv(&quot;QT_GSTREAMER_CAMERABIN_VIDEO_INTERLACE&quot;);
    if (envInterlace.length() &gt; 0) {
        GstElement *interlace = gst_element_factory_make (&quot;interlace&quot;, NULL);
        if (interlace == NULL)
            g_error (&quot;Could not create 'interlace' element&quot;);


        g_object_set(G_OBJECT(m_camerabin), &quot;viewfinder-filter&quot;, interlace, NULL);

        #if CAMERABIN_DEBUG
            qDebug() &lt;&lt; &quot;set camera filter&quot; &lt;&lt; interlace;
        #endif
        gst_object_unref (interlace);
    }
</code></pre>

<h2 id="gps">GPS</h2>

<p>I had a serial GPS around, why not display a moving map?</p>

<p>Enable serial port in <code>/boot/config.txt</code> (note Bluetooth must be disabled &hellip;)</p>

<pre><code>enable_uart=1
dtoverlay=pi3-disable-bt
</code></pre>

<p>pin 8  TXD<br />
pin 10 RXD</p>

<p>remove <code>console=ttyAMA0,115200</code> and <code>kgdboc=ttyAMA0,115200</code> from <code>/boot/cmdline.txt</code></p>

<p>I thought it would be very easy to read NMEA via serial.<br />
It was, gpsd worked in seconds but &hellip; it seems we can&rsquo;t disable the auto speed, equal 4s lost at start.<br />
Plus Qt is using libgeoclue or Gypsy which <a href="https://gypsy.freedesktop.org/why-not-gpsd.html">does not want to talk with gpsd</a>.<br />
I tried both of them, they didn&rsquo;t work, it&rsquo;s a mess to debug, documentation is just the API&hellip;</p>

<p>So one thing led to another&hellip; I&rsquo;ve written a very small and simple gpsd in Go with a gRPC interface, so it can be queried from anything.<br />
It&rsquo;s also a bit more advanced since it can map match &amp; route match the positions with OSRM.</p>

<h2 id="offline-maps">Offline maps</h2>

<p><a href="https://openmaptiles.org">OpenMapTiles project is great</a> to generate vectors data in MBTILES format, you can serve them with <a href="https://github.com/akhenakh/mbmatch">mbmatch</a>.<br />
Qt Map QML can display them using the <code>mapboxgl</code> driver, some <a href="https://openmaptiles.org/styles/">free styles</a> are provided.</p>

<p>Here is an example QML Map plugin.</p>

<pre><code class="language-QML">    Plugin {
        id: mapPlugin
        name: &quot;mapboxgl&quot;
        PluginParameter{
            name: &quot;mapboxgl.mapping.additional_style_urls&quot;
            value: &quot;http://localhost:4000/osm-liberty-gl.style&quot;
        }
    }
</code></pre>

<p>Note on X11 and EGL:<br />
Using the mapboxgl renderer under X11 on the Rpi3 is taking a lot of ressources.<br />
Qt5 is <a href="https://doc.qt.io/qt-5/embedded-linux.html">capable of directly talking to the GPU without X11</a>, the performance difference is night and day.</p>

<p>So just run your Qt app without X11 with the following env vars.</p>

<pre><code>QT_QPA_PLATFORM=eglfs:/dev/fb0
QT_QPA_EGLFS_HIDECURSOR=yes
</code></pre>

<h2 id="offline-routing">Offline Routing</h2>

<p>Hopefully the provided Qt <code>osm</code> plugins knows how to route using the <a href="https://github.com/Project-OSRM/osrm-backend/blob/master/docs/http.md">OSRM API</a>.<br />
So you can run a local <a href="https://github.com/Project-OSRM/osrm-backend">OSRM backend</a> for routing and it will just work.</p>

<p>Generate the route indexes.</p>

<pre><code>osrm-extract -p /usr/share/osrm/profiles/car.lua quebec-latest.osm.pbf 
osrm-contract quebec-latest.osrm
osrm-routed quebec-latest.osrm
</code></pre>

<pre><code class="language-QML">    Plugin {
        id: routePlugin
        name: &quot;osm&quot;
        PluginParameter{
            name: &quot;osm.routing.host&quot;
            value: &quot;http://localhost:5000/route/v1/driving/&quot;
        }
    }
</code></pre>

<p><img src="https://blog.nobugware.com/img/mocs.jpg" alt="Mocs" /></p>

<p>The app can display the rear camera and a moving map !!</p>

<p><a href="https://blog.nobugware.com/post/2018/my_own_car_system_raspberry_pi_offline_mapping_map_matching_places_part2/">Part 2</a>  will be about searching places by extracting OSM data and indexing them in a small Go program that can run on the rpi, reading ODB data from the car via Bluetooth, packaging the whole thing and open sourcing some code.</p>

                    </div>
                </section>
                
            </div>
            
<div class="pagination">
  <nav role="pagination" class="post-list-pagination">
      
    <span class="post-list-pagination-item post-list-pagination-item-current">Page 1 of 9</span>
    
      <a href="https://blog.nobugware.com/page/2/" class="post-list-pagination-item pure-button post-list-pagination-item-next">
        Older&nbsp;<i class="fa fa-angle-double-right"></i>
      </a>
    
  </nav>
</div>


            <div class="footer">
    <div class="pure-menu pure-menu-horizontal pure-menu-open">
        <ul>
            <li>Powered by <a class="hugo" href="http://hugo.spf13.com/" target="_blank">hugo</a></li>
        </ul>
    </div>
</div>
<script src="https://blog.nobugware.com/js/all.min.js"></script>
        </div>
    </div>
</div>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-1245966-1', 'auto');
ga('send', 'pageview');

</script>

</body>
</html>
