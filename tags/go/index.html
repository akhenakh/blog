<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Go &middot; Fabrice Aneche</title>

    <meta name="description" content="">

    <meta name="generator" content="Hugo 0.55.3" />
    <meta name="twitter:card" content="summary">
    
    <meta name="twitter:title" content="Go &middot; Fabrice Aneche">
    <meta name="twitter:description" content="">

    <meta property="og:type" content="article">
    <meta property="og:title" content="Go &middot; Fabrice Aneche">
    <meta property="og:description" content="">

    <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700|Oxygen:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/pure-min.css">
    <!--[if lte IE 8]>
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-old-ie-min.css">
    <![endif]-->
    <!--[if gt IE 8]><!-->
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-min.css">
    <!--<![endif]-->

    <link rel="stylesheet" href="https://blog.nobugware.com/css/all.min.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">

    <link rel="alternate" type="application/rss+xml" title="Fabrice Aneche" href="https://blog.nobugware.com/index.xml" />
    <link href="https://blog.nobugware.com/css/prism.css" rel="stylesheet" />
</head>
<body>


<div id="layout" class="pure-g">
    <div class="sidebar pure-u-1 pure-u-md-1-4">
    <div class="header">
        <hgroup>
            <h1 class="brand-title"><a href="https://blog.nobugware.com">Fabrice Aneche</a></h1>
            <h2 class="brand-tagline"></h2>
        </hgroup>

        <nav class="nav">
            <ul class="nav-list">
                
                <li class="nav-item">
                    <a class="pure-button" href="http://www.nobugware.com"><i class="fa fa-building-o"></i> Hiring</a>
                </li>
                
                
                <li class="nav-item">
                    <a class="pure-button" href="https://twitter.com/akhenakh"><i class="fa fa-twitter"></i> Twitter</a>
                </li>
                
                
                <li class="nav-item">
                    <a class="pure-button" href="https://github.com/akhenakh "><i class="fa fa-github-alt"></i> github</a>
                </li>
                
                <li class="nav-item">
                    <a class="pure-button" href="https://blog.nobugware.com/index.xml"><i class="fa fa-rss"></i> rss</a>
                </li>
            </ul>
        </nav>
    </div>
</div>


    <div class="content pure-u-1 pure-u-md-3-4">
        <div>
            
            <div class="posts">
                
                <h1 class="content-subhead">27 Apr 2019, 02:00</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.nobugware.com/post/2019/deploying-a-website-with-caddy-git-and-kubernetes/" class="post-title">Deploying a website with Caddy, Git and Kubernetes</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                <a class="post-category post-category-DevOps" href="https://blog.nobugware.com/categories/devops">DevOps</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<p><a href="https://caddyserver.com">Caddy</a> is the swiss army of the web server, and with the <a href="https://caddyserver.com/blog/announcing-caddy-1_0-caddy-2-caddy-enterprise">recent commercial license changes</a>, it&rsquo;s time to give it some love back.</p>

<p>I have several static websites, some generated with <a href="https://gohugo.io">Hugo</a>, some are plain HTML.<br />
I wanted a small container, to run it inside a Kubernetes cluster, capable of pulling some git repos and serve them.</p>

<h2 id="caddy-git">Caddy-git</h2>

<p>Caddy is already capable of that with the help of caddy-git unfortunately it is only working with ssh keys.<br />
I wanted it to use <a href="https://help.github.com/en/articles/creating-a-personal-access-token-for-the-command-line">Github access token</a>. also the current implementation is relying on the <code>git</code> command and <code>sh</code>, I wanted mine to be able to run on <a href="https://github.com/GoogleContainerTools/distroless">Distroless</a>.</p>

<h2 id="minigit">Minigit</h2>

<p>I used <a href="https://github.com/src-d/go-git">go-git</a> a pure Go implementation of git, to first make a clone of the <code>git</code> command: <a href="https://github.com/akhenakh/minigit">minigit</a>.<br />
<a href="https://github.com/akhenakh/minigit">minigit</a> can be useful in devops environnements and scriptings to facilitate git pulls.<br />
Faking the <code>git</code> command with <a href="https://github.com/akhenakh/minigit/">minigit</a> in your image and tweak caddy-git to pass an extra parameter <code>--ghtoken</code></p>

<pre><code>root /public
git https://github.com/myuser/repo {
   path /public
   clone_args --ghtoken XXXXXXXXXXXXX
   pull_args --ghtoken XXXXXXXXXXXXX
   interval 3600
}
</code></pre>

<p>It&rsquo;s nice but I wanted something cleaner and get rid of the <code>sh</code> dependency, I had to fork caddy-git.</p>

<h2 id="caddy-puregit">Caddy-puregit</h2>

<p>So here is caddy-puregit, a fork without execs but native pure Go git calls.<br />
Give it your token and it will clone then pull on regular intervals.</p>

<pre><code>root /public
puregit https://github.com/myuser/repo {
   path /public
   auth_token XXXXXXXXXXXXX 
   interval 3600
}
</code></pre>

<p>I&rsquo;ve also created a <a href="https://cloud.docker.com/repository/docker/akhenakh/caddy-hugo">Caddy + Hugo image</a>, so you can trigger a Hugo build on every commits.</p>

<pre><code>root /public
puregit https://github.com/myuser/hugo-blog {
   path /data
   then hugo --destination=/public --source=/data
   auth_token XXXXXXXXXXXXX 
   interval 3600
}
</code></pre>

<p>Here is <a href="https://github.com/akhenakh/caddy-puregit">caddy-puregit</a> and associated <a href="https://cloud.docker.com/u/akhenakh/repository/docker/akhenakh/caddy">Docker image</a> &amp; <a href="https://github.com/akhenakh/goimages/blob/master/caddy/Dockerfile">Dockerfile</a></p>

<h2 id="kubernetize">Kubernetize</h2>

<p>Since Caddy supports environment variables it&rsquo;s easy to deploy in k8s:</p>

<blockquote>
<p>root /public
puregit {$REPO} {
auth_token {$TOKEN}
}</p>
</blockquote>

<p>Put your token into a secret and expose it as an environment variable.</p>

<p><a href="https://gist.github.com/akhenakh/f3836dc3cf6ca06a003c562dde43ff07">Here is template</a> to deploy which will deploy caddy and pull your repo then serving it according to the config.</p>

<h2 id="notes">Notes</h2>

<p>The way Caddy register plugins is weird I had to fork caddy <a href="https://github.com/akhenakh/caddy/commit/9f816d3bb96fa9f70c30cb432e653a6567ffb14d#diff-6d5d55d40631fee92928c3ec5ff6e130">since it requires a directive to be set</a>.<br />
I had troubles to compile the whole thing: even the go mod <code>replace</code> directive was unable to point to my forked repo, only <code>go mod=vendor</code> did the trick.</p>

<p>I don&rsquo;t plan maintaining this fork but will reach the author since a pure Go git concept is working maybe he will be interested.</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">11 Mar 2019, 00:32</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.nobugware.com/post/2019/kubernetes_mesh_network_load_balancing_grpc_services/" class="post-title">gRPC Load Balancing inside Kubernetes</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                <a class="post-category post-category-Devops" href="https://blog.nobugware.com/categories/devops">Devops</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<h2 id="context">Context</h2>

<p>I wanted to blog about this for years: how to connect to a Kubernete&rsquo;s loadbalanced service?<br />
How to deal with disconnections/re-connections, maintenance?  What about gRPC specifically?<br />
The answer is heavily connected to the network stack used by Kubernetes, but with the &ldquo;Mesh Network&rdquo; revolution, It&rsquo;s not always clear how it works anymore and what the options are.
<br>
<br></p>

<h2 id="how-it-works">How it works</h2>

<p>First I recommend you to watch this great yet simple video: <a href="https://www.youtube.com/watch?v=6v_BDHIgOY8&amp;feature=youtu.be">Container Networking From Scratch</a>, then the <a href="https://kubernetes.io/docs/concepts/services-networking/service/#proxy-mode-iptables">Services clusterIP documentation</a>.</p>

<p>To make it simple when you create a Service in Kubernetes, it creates a layer 4 proxy and load balance connections to your pods using iptables, the service endpoint is one IP and a port hiding your real pods.</p>

<h2 id="the-problem">The Problem</h2>

<p>A simple TCP load balancer is good enough for a lot of things especially for HTTP/1.1 since connections are mainly short lived, the clients will try to reconnect often, so it won&rsquo;t stay connected to an old running pod.</p>

<p>But with gRPC over HTTP/2, a TCP connection is maintained open which could lead to issues, like staying connected to a dying pod or unbalancing the cluster because the clients will end on the older pods.</p>

<p>One solution is to use a more advanced proxy that knows about the higher layers.</p>

<p><a href="https://www.envoyproxy.io/">Envoy</a>, <a href="http://www.haproxy.org/">HAProxy</a> and <a href="https://traefik.io/">Traefik</a> are layer 7 reverse proxy load balancers, they know about HTTP/2 (even about gRPC) and can disconnect a backend’s pod without the clients noticing.</p>

<h2 id="edge">Edge</h2>

<p>On the edge of your Kubernetes cluster, you need a public IP, provided by your cloud provider via <a href="https://kubernetes.io/docs/concepts/services-networking/ingress/">the <code>Ingress</code> directive</a> it will expose your internal service.</p>

<p>To further control your request routing you need <a href="https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/">an Ingress Controller</a>.<br />
It&rsquo;s a reverse proxy that knows about the Kubernetes clusters and can direct the requests to the right place.
<a href="https://www.envoyproxy.io/">Envoy</a>, <a href="http://www.haproxy.org/">HAProxy</a> and <a href="https://traefik.io/">Traefik</a> can act as Ingress Controllers.</p>

<h2 id="internal-services-service-mesh">Internal Services &amp; Service Mesh</h2>

<p>In a Micro-services environment, most if not all your micro-services will also be clients to others micro-services.</p>

<p><a href="https://istio.io/">Istio</a>, a &ldquo;Mesh Network&rdquo; solution, use <a href="https://www.envoyproxy.io/">Envoy</a> as a <a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/">sidecar</a>. This sidecar is configured from a central place (control plane) and makes each micro-service talking to each other through Envoy.</p>

<p>This way the client does not need to know about all the topology.</p>

<p>That&rsquo;s great but in a controlled environment (yours), where you control all the clients, sending all the traffic through a proxy is not always necessary.</p>

<h2 id="client-load-balancing">Client Load Balancing</h2>

<p>In Kubernetes you can create a <a href="https://kubernetes.io/docs/concepts/services-networking/service/#headless-services">headless service</a>; where there are no load balanced single endpoints anymore, the service pods are directly exposed, Kubernetes DNS will return all of them.</p>

<p>Here is an example service called <code>geoipd</code> scaled to 3.</p>

<pre><code>Name:      geoipd
Address 1: 172.17.0.18 172-17-0-18.geoipd.default.svc.cluster.local
Address 2: 172.17.0.21 172-17-0-21.geoipd.default.svc.cluster.local
Address 3: 172.17.0.9 172-17-0-9.geoipd.default.svc.cluster.local
</code></pre>

<p>It&rsquo;s up to your client to connect them all and load balance the connections.</p>

<p>In Go gRPC client side, a simple <code>dns:///</code> notation will fetch the entries for you, then the <a href="https://godoc.org/github.com/grpc/grpc-go/balancer/roundrobin">roundrobin package</a> will handle load balancing.</p>

<pre><code class="language-Go">conn, err := grpc.Dial(
    &quot;dns:///geoip:9200&quot;,
    grpc.WithBalancerName(roundrobin.Name),
)
</code></pre>

<p>This may sound like a good solution but it is not: the default refresh frequency is 30 minutes, meaning whenever you add new pods, it can take up to 30 minutes for them to start getting traffic!
You can lower this problem by tweaking <code>MaxConnectionAge</code> on the gRPC server:</p>

<pre><code class="language-Go">gsrv := grpc.NewServer(
    // MaxConnectionAge is just to avoid long connection, to facilitate load balancing
    // MaxConnectionAgeGrace will torn them, default to infinity
    grpc.KeepaliveParams(keepalive.ServerParameters{MaxConnectionAge: 2 * time.Minute}),
)
</code></pre>

<p>Even if you could refresh the list more often you wouldn&rsquo;t know about pod eviction fast enough and you’d miss some traffic.</p>

<p>There is a nicer solution, implementing the gRPC client resolver for Kubernetes, talking to the Kubernetes API to get the endpoints and watch them constantly, this is exactly what <a href="https://github.com/sercand/kuberesolver">Kuberesolver</a> does.</p>

<pre><code class="language-Go">// Register kuberesolver to grpc
kuberesolver.RegisterInCluster()

conn, err := grpc.Dial(
    &quot;kubernetes:///geoipd:9200&quot;,
    grpc.WithBalancerName(roundrobin.Name),
)
</code></pre>

<p>By using <code>kubernetes</code> schema you tell kuberesolver to fetch and watch the endpoints for the <code>geoipd</code> service.</p>

<p>For this to work the pod must have <code>GET</code> and <code>WATCH</code> access to <code>endpoints</code> using a role:</p>

<pre><code>kubectl create role pod-reader-role --verb=get --verb=watch --resource=endpoints,services 
kubectl create sa pod-reader-sa 
kubectl create rolebinding pod-reader-rb --role=pod-reader-role --serviceaccount=default:pod-reader-sa 
</code></pre>

<p>Redeploy your app (the client) with the service account:</p>

<pre><code class="language-yaml">spec:
  serviceAccountName: pod-reader-sa
</code></pre>

<p>Deploy, scale up, scale down, kill your pods, your client is still sending traffic to a living pod !</p>

<p>I&rsquo;m surprised it&rsquo;s not mentioned more often, client load balancing did the job for years, the same apply inside Kubernetes environment.<br />
It is fine for small to medium projects and can deal with a lot of traffic, this will do it for many of you unless if you are Netflix sized&hellip;</p>

<h2 id="conclusion">Conclusion</h2>

<p>Load-balancing proxies are great tools, especially useful on the edge of your platform. &ldquo;Mesh Network&rdquo; solutions are nice additions to our tool set, but the cost of operating and debugging a full mesh network could be really expensive and overkill in some situations, while a client load balancing solution is simple and easy to grasp.</p>

<p>Thanks to <a href="https://github.com/prune998">Prune</a> who helped me with this post, and to <a href="https://twitter.com/robteix">Robteix</a> &amp; <a href="https://twitter.com/diligiant">diligiant</a> for reviewing.</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">04 Mar 2019, 00:32</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.nobugware.com/post/2019/traefik_load_balancing_grpc_services_trace_propagation/" class="post-title">Traefik gRPC Load Balancing and Traces Propagation</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                <a class="post-category post-category-Devops" href="https://blog.nobugware.com/categories/devops">Devops</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<p>Following my recent <a href="https://blog.nobugware.com/post/2019/kubernetes_quick_development_setup_minikube_prometheus_grafana/">blog post on setting up a dev environment in Kubernetes</a>, here are some tips to use <a href="https://traefik.io">Traefik</a> as a gRPC load balancer.</p>

<p><a href="https://traefik.io">Traefik</a> can be used on the edge and route incoming HTTP traffic to your Kubernetes cluster, but it&rsquo;s also <a href="https://docs.traefik.io/user-guide/grpc/">supporting gRPC</a>.<br />
<br/>
<br/>
<br/></p>

<h2 id="grpc-load-balancing-with-traefik">gRPC Load Balancing with Traefik</h2>

<p>Here I have a gRPC service I want to expose on the edge.</p>

<pre><code class="language-yaml">apiVersion: v1
kind: Service
metadata:
  name: myapp
  labels:
    name: &quot;myapp&quot;
    type: &quot;grpc&quot;
spec:
  ports:
    - port: 9200
      name: &quot;grpc&quot;
      targetPort: grpc
      protocol: TCP
  selector:
    app: &quot;myapp&quot;
  clusterIP: None
</code></pre>

<p>Note the <code>clusterIP: None</code>, it&rsquo;s a <a href="https://kubernetes.io/docs/concepts/services-networking/service/#headless-services">headless service</a>.</p>

<p>It will create a non loadbalanced service, pod&rsquo;s services can be accessed directly.</p>

<pre><code>myapp.default.svc.cluster.local.    2       IN      A       172.17.0.19
myapp.default.svc.cluster.local.    2       IN      A       172.17.0.10
myapp.default.svc.cluster.local.    2       IN      A       172.17.0.16
</code></pre>

<p>Here is the ingress for Traefik.</p>

<pre><code class="language-yaml">apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: myapp-ingress
  namespace: default
  labels:
    name: &quot;myapp&quot;
  annotations:
    ingress.kubernetes.io/protocol: h2c
spec:
  rules:
  - host: myapp-lb.minikube
    http:
      paths:
      - path: /
        backend:
          serviceName: myapp
          servicePort: 9200
</code></pre>

<p>Note the <code>h2c</code> prefix, indicating HTTP2 protocol without TLS to your backend !</p>

<p><img src="https://blog.nobugware.com/img/grpctraefik.jpg" alt="Traefik" /></p>

<h2 id="tracing">Tracing</h2>

<p>Traefik can be <a href="https://docs.traefik.io/configuration/tracing/">configured to emit tracing</a>.</p>

<p>I&rsquo;m using <a href="https://medium.com/@rghetia/distributed-tracing-and-monitoring-using-opencensus-fe5f6e9479fb"><code>ocgrpc</code> Opencensus</a>, for gRPC metrics &amp; traces.<br />
It automatically emits several counters for gRPC and traces using the <a href="https://godoc.org/google.golang.org/grpc#StatsHandler">StatsHandler</a>.</p>

<p>Unfortunately <a href="https://github.com/census-instrumentation/opencensus-go/issues/838"><code>ocgrpc</code> does not yet propagate Jaeger traces</a>, I&rsquo;ve <a href="https://github.com/akhenakh/ocgrpc_propagation">temporary forked it to support Jaeger</a>.</p>

<p>As you can see you can follow the request from Traefik down to your services.</p>

<p><img src="https://blog.nobugware.com/img/jaegergrpc.jpg" alt="Jaeger" /></p>

<p>Happy tracing !</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">21 Feb 2019, 00:19</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.nobugware.com/post/2019/kubernetes_quick_development_setup_minikube_prometheus_grafana/" class="post-title">Kubernetes Quick Setup with Prometheus, Grafana &amp; Jaeger</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                <a class="post-category post-category-Devops" href="https://blog.nobugware.com/categories/devops">Devops</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<h2 id="introduction">Introduction</h2>

<p>When starting on a new project or prototyping on a new idea, I find myself doing the same tasks again and again.<br />
Thanks to Kubernetes it&rsquo;s possible to setup a new env from scratch really fast.</p>

<p>Here is a quick setup (mostly notes) to create a dev environment using Minikube and the workflow I&rsquo;m using with it.</p>

<p>Not knowing in advance where this future project will be hosted, I try to stay platform agnostic.<br />
<a href="https://opencensus.io">OpenCensus</a> or <a href="https://opentracing.io">OpenTracing</a> can abstract the target platform, letting you choose what tooling you want for your dev.</p>

<p>I consider some tools to be mandatory these days:</p>

<ul>
<li><a href="https://www.jaegertracing.io/">Jaeger</a> for tracing</li>
<li><a href="https://prometheus.io/">Prometheus</a> for instrumentation/metrics</li>
<li><a href="https://grafana.com">Grafana</a> to display these metrics</li>
<li>A logging solution: this is already taken care of by Kubernetes and depends on your cloud provider (StackDriver on GCP&hellip;), otherwise use another tool like ELK stack.<br />
On your dev, plain structured logs to stdout with Kubernetes dashboard or <a href="https://github.com/wercker/stern">Stern</a> should be fine.</li>
<li>A messaging system: for example <a href="https://nats.io/">NATS</a> but out of the scope of this post.</li>
</ul>

<h2 id="tools-installation">Tools Installation</h2>

<p>I find it easier to let Minikube open reserved ports, but not mandatory:</p>

<pre><code class="language-bash">minikube start --extra-config=apiserver.service-node-port-range=80-30000
</code></pre>

<p>I&rsquo;ll use <a href="https://traefik.io">Traefik</a> as Ingress to simplify access to several admin UI later.</p>

<p>I&rsquo;m not a big fan of <code>helm</code>, so here is a little trick, I&rsquo;m only using <code>helm</code> to create my deployment templates, using the charts repo as a source template, so I can commit or modify the resulting generated files. (Thanks <a href="https://twitter.com/prune998">Prune</a> for this tips).</p>

<pre><code class="language-bash">git clone git@github.com:helm/charts.git 

helm template charts/stable/traefik --name traefik --set metrics.prometheus.enabled=true --set rbac.enabled=true \
--set service.nodePorts.http=80 --set dashboard.enabled=true --set dashboard.domain=traefik-ui.minikube &gt; traefik.yaml 

helm template charts/stable/grafana --name grafana --set ingress.enabled=true \ 
--set ingress.hosts\[0\]=grafana.minikube --set persistence.enabled=true --set persistence.size=100Mi &gt; grafana.yaml 

helm template charts/stable/prometheus --name prometheus --set server.ingress.enabled=true \ 
--set server.ingress.hosts\[0\]=prometheus.minikube --set alertmanager.enabled=false \ 
--set kubeStateMetrics.enabled=false --set nodeExporter.enabled=false --set server.persistentVolume.enabled=true \
--set server.persistentVolume.size=1Gi --set pushgateway.enabled=false &gt; prometheus.yaml 
</code></pre>

<p>A lot more templates are available: NATS, Postgresql &hellip;</p>

<p>For Jaeger a <a href="https://raw.githubusercontent.com/jaegertracing/jaeger-kubernetes/master/all-in-one/jaeger-all-in-one-template.yml">development ready solution</a> exists, here is mine slightly tweaked to use an ingress:</p>

<pre><code>curl -o jaeger.yaml https://gist.githubusercontent.com/akhenakh/615686891340f5306dcbed82dd1d9d67/raw/41049afecafb05bc29de3b0d25208c784f963695/jaeger.yaml
</code></pre>

<p>Deploy to Minikube (ensure your current context is <code>minikube</code>&hellip;), if you need to work on several projects at the same time remember you can use Kubernetes namespaces, (beware some helm templates are overriding it).</p>

<pre><code class="language-bash">kubectl create -f traefik.yaml
kubectl create -f jaeger.yaml
kubectl create -f grafana.yaml
kubectl create -f prometheus.yaml
</code></pre>

<p>Again to ease my workflow I want Traefik to bind 80, edit the service and change it to <code>nodePort 80</code>.</p>

<pre><code>kubectl edit service traefik
</code></pre>

<p>Add some urls to your <code>/etc/hosts</code></p>

<pre><code class="language-bash">echo &quot;$(minikube ip) prometheus.minikube&quot; | sudo tee -a /etc/hosts 
echo &quot;$(minikube ip) grafana.minikube&quot; | sudo tee -a /etc/hosts 
echo &quot;$(minikube ip) traefik-ui.minikube&quot; | sudo tee -a /etc/hosts
echo &quot;$(minikube ip) jaeger.minikube&quot; | sudo tee -a /etc/hosts
</code></pre>

<p>Point your browser to any of these addresses and you are good to go !</p>

<h2 id="deploy-your-own-apps">Deploy your own apps</h2>

<p>First remember to always use the Kubernetes Docker:</p>

<pre><code class="language-bash">eval `minikube docker-env` 
</code></pre>

<p>My applications are reading parameters from environment, in Go, I&rsquo;m using <a href="http://github.com/namsral/flag">namsral/flag</a>, so the flag <code>-httpPort</code> is also set by the environment variable <code>HTTPPORT</code>.</p>

<p>I then use templates, where I set all my environment variables, to create my yaml deployment.</p>

<p><a href="https://gist.github.com/akhenakh/8c06186b7d524f6a60d40764b307a5d5">https://gist.github.com/akhenakh/8c06186b7d524f6a60d40764b307a5d5</a></p>

<p>So typical Makefile targets would fill the template with <code>envsubst</code>:</p>

<pre><code class="language-Makefile">.EXPORT_ALL_VARIABLES:
VERSION := $(shell git describe --always --tags)
DATE := $(shell date -u +%Y%m%d.%H%M%S)
LDFLAGS := -ldflags &quot;-X=main.version=$(VERSION)-$(DATE)&quot;
CGO_ENABLED=0
GOOS=linux
GOARCH=amd64
PROJET = mysuperproject
...

helloworld: 
	cd helloworld/cmd/helloworld &amp;&amp; go build $(LDFLAGS)

helloworld-image: helloworld
	cd helloworld/cmd/helloworld &amp;&amp; docker build -t helloworld:$(VERSION) .

helloworld-deploy: NAME=helloworld
helloworld-deploy: helloworld-image 
	cat deployment/project-apps.yaml | envsubst | kubectl apply -f - 
	cat deployment/project-services.yaml | envsubst | kubectl apply -f - 

project-undeploy:
    kubectl delete --ignore-not-found=true deployments,services,replicasets,pods --selector=appgroup=$(PROJECT)
</code></pre>

<p><code>Dockerfile</code> contains nothing but <code>FROM gcr.io/distroless/base</code> and a copy of the helloworld binary.</p>

<p>Note all this setup is <strong>only good for your dev</strong>, production deployment is another story.</p>

<p><code>make helloworld-deploy</code>, compilation, image creation and deployment is less than 2s over here!</p>

<h2 id="shell-tool">Shell tool</h2>

<p>Another useful trick when working with new tools is to have a shell available inside Kubernetes to experiment with.</p>

<p>Create an image for this purpose, and copy your tools and clients.</p>

<pre><code class="language-Dockerfile">FROM alpine:3.9
RUN apk add --no-cache curl busybox-extras tcpdump

WORKDIR /root/
COPY helloworldcli .
ENTRYPOINT [&quot;tail&quot;, &quot;-f&quot;, &quot;/dev/null&quot;]
</code></pre>

<p>And the relevant Makefile targets:</p>

<pre><code class="language-Makefile">debugtool-image: helloworldcli
	cp helloworld/cmd/helloworldcli/helloworldcli debugtool/helloworldcli
	cd debugtool &amp;&amp; docker build  -t debugtool:latest .
	rm -f debugtool/helloworldcli

debugtool-deploy: debugtool-image
	kubectl delete --ignore-not-found=true pod debugtool
	sleep 2
	kubectl run --restart=Never --image=debugtool:latest --image-pull-policy=IfNotPresent debugtool

debugtool-shell:
	kubectl exec -it debugtool -- /bin/sh 
</code></pre>

<p>By calling <code>make debugtool-shell</code>, you&rsquo;ll be connected on a shell inside Kubernetes.</p>

<h2 id="conclusion">Conclusion</h2>

<p>Hope this will help some of you, I would love to hear your own tricks and setup to develop on Minikube !</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">27 Aug 2018, 00:19</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.nobugware.com/post/2018/wasm_go_s2_javascript/" class="post-title">Wasm with Go to build an S2 cover map viewer</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                <a class="post-category post-category-Go" href="https://blog.nobugware.com/categories/go">Go</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<p>I needed a reason to use <a href="https://golang.org/doc/go1.11#wasm">the new Go 1.11 Wasm port</a> for &ldquo;real&rdquo;.</p>

<p>To make it short, it compiles Go code to <a href="https://webassembly.org/">Wasm</a> binary format for a virtual machine running in web browsers.</p>

<p>I&rsquo;ve always needed a debug tool to display <a href="https://blog.nobugware.com/post/2016/geo_db_s2_geohash_database/">S2 Cells</a> on a map for different shapes, some online tools already exist:</p>

<ul>
<li><a href="http://s2map.com">s2map.com</a> unfortunately the backend is often/currently dead.</li>
<li><a href="https://s2.sidewalklabs.com/regioncoverer/">regioncoverer</a> which doesn&rsquo;t allow polygons.</li>
</ul>

<p>I&rsquo;ve planned for a Qt Go app or a QGIS plugin with C++ bindings to Python but to ship those modules would be a nightmare.</p>

<p>I needed another solution, a simple web app would do it, not very complicated but since I hate HTML/CSS/js, I&rsquo;ve never bothered to start one&hellip;<br />
The s2map solution was great but having to start a backend and pay for it, was a no go for the long run, plus since I work with Go I needed something that was relying on the S2 Go port for matching results.</p>

<p>So here I am doing some web dev&hellip;</p>

<h2 id="wasm-go">Wasm &amp; Go</h2>

<p>First Wasm is not the best solution (GopherJS maybe is) to my problem but hey it&rsquo;s working.</p>

<p>The <code>main()</code> is a bit weird but close enough to a normal Go program:</p>

<pre><code class="language-Go">func registerCallbacks() {
	js.Global().Set(&quot;geocell&quot;, js.NewCallback(geoJSONToCells))
}

func main() {
	c := make(chan struct{}, 0)
	println(&quot;Wasm ready&quot;)
	registerCallbacks()
	&lt;-c
}
</code></pre>

<p>Since our function <code>geocell()</code> will be called by js, we wait for a channel that will never be triggered so the main loop won&rsquo;t return.</p>

<p><code>NewCallback()</code> wants a <code>fn func(event Value)</code> it means <strong>you can&rsquo;t return directly from Go to js</strong> &hellip;</p>

<pre><code class="language-Go">func geoJSONToCells(i []js.Value)  
</code></pre>

<p>Just a slice of untyped values thank you js.</p>

<p>All other functions (not exposed to js) can be normal Go functions, packages &hellip;</p>

<p>Interaction with the DOM is very limited via the package <a href="https://tip.golang.org/pkg/syscall/js/?GOOS=js&amp;GOARCH=wasm">syscall/js</a><br />
So far, to update back the UI (from Go to  js), I pass the result of the computation via a set and call the js method, very hackish &hellip;</p>

<pre><code class="language-Go">func updateUIWithData(data string) {
	js.Global().Set(&quot;data&quot;, data)
	js.Global().Call(&quot;updateui&quot;)
}
</code></pre>

<p>The <code>updateui()</code> is a regular js function that processes <code>data</code> and updates the DOM.</p>

<h2 id="app">App</h2>

<p>The app is calling a lot of Go code and libraries that were not written for the web but are now executed from a webpage without any backends:</p>

<ul>
<li>the web interface creates a shape on a js Leaflet layer</li>
<li>exports the shape in GeoJSON</li>
<li>serializes it to JSON</li>
<li>calls the <code>geoJSONToCells()</code> func passing the JSON as string argument</li>
<li>computes the S2 cells in the Go world</li>
<li>sets the result back via a js var containing GeoJSON as string</li>
<li>reads back this GeoJSON and displays it as a Leaflet layer</li>
</ul>

<p>The first loading and running of the Wasm is very slow on Chrome but not on Firefox, the execution itself is really fast.</p>

<p><a href="https://s2.inair.space"><img src="https://blog.nobugware.com/img/ws2.jpg" alt="ws2" /></a></p>

<p>Code is on <a href="https://github.com/akhenakh/ws2">Github</a> and <a href="https://s2.inair.space/">Demo is hosted on Github Pages at https://s2.inair.space</a>, sorry folks Wasm works on phones but the demo won&rsquo;t be very useful on mobile.</p>

<h2 id="size">Size</h2>

<p>You can argue 11M (1.5M gzipped) is too big for a webapp providing only one functionality, and you are probably right (then look at a modern webpage), but how big would be a Python app shipped with the C++ library or a full Qt app &hellip;</p>

<p>Also the size could be a non-issue, in a near future, a solution like <a href="https://github.com/dave/jsgo">jsgo.io</a> could provide package level CDN caching.</p>

<h2 id="conclusion">Conclusion</h2>

<p>Again you should have really good reasons to use Wasm, the back and forth between js &amp; Wasm is nonsense, but the tooling will improve and I&rsquo;m sure we will see plenty of solutions around it (one is gRPC in the browser).</p>

<p>EDIT: <code>Call()</code> can call a js method no need for eval !</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">01 Aug 2018, 00:19</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.nobugware.com/post/2018/my_own_car_system_raspberry_pi_offline_mapping_map_matching_places_part2/" class="post-title">My Own Car System, Rear Camera, Offline Maps &amp; Routing, Map Matching with Go on Raspberry Pi part II</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                <a class="post-category post-category-Geo" href="https://blog.nobugware.com/categories/geo">Geo</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<p>This is my journey building an open source car system with Go &amp; Qt, rear camera, live OpenGL map &hellip;</p>

<h2 id="cross-compilation">Cross compilation</h2>

<p><a href="https://blog.nobugware.com/post/2018/my_own_car_system_raspberry_pi_offline_mapping/">In Part I</a>, I had to patch qtmultimedia for the camera to work, but Qt compilation is resource hungry, same goes for the osrm compilation, the memory of the Raspberry Pi is too small.</p>

<p>I had to to set up a <a href="https://wiki.archlinux.org/index.php/Distcc#Arch_Linux_ARM">cross compilation system</a> in my case for armv7h.</p>

<h2 id="qml-development">QML Development</h2>

<p>Since most of the application is in <a href="https://en.wikipedia.org/wiki/QML">QML</a>, I&rsquo;ve used the c++ <code>main.cpp</code> launcher as long as possible for the development.<br />
At the moment I needed to inject data from the outside world (like the GPS location) to QML via Qt, so I switched to Go using <a href="https://github.com/therecipe/qt">therecipe Qt Go bindings</a>.</p>

<p>The Go bindings project is young but the main author is really active fixing issues.</p>

<p>It makes desktop applications easy to code without the assle of C++ (at least for me).</p>

<p>About QML, by separating the logic and forms using <code>.qml.ui</code> you still can edit your views with <a href="https://wiki.qt.io/Qt_Creator">Qt Creator</a>:<br />
That&rsquo;s just the narrative, truth is Creator is really buggy and I edited the ui files by hand most of the time.<br />
I worked with Interface Builder on iOS for years, Qt is painful, lack of decent visual editor for QML really hurts.</p>

<h2 id="serving-the-map-without-internet-access">Serving the map without internet access</h2>

<p><a href="https://blog.nobugware.com/post/2018/my_own_car_system_raspberry_pi_offline_mapping/">In Part I</a>, we talked about OpenMapTiles and OpenGL rendering, but I needed a web server capable of reading MBTiles format and serving the necessary assets for the map to be rendered.</p>

<p>I&rsquo;ve created <a href="https://github.com/akhenakh/mbmatch">mbmatch</a> in Go for that purpose so <a href="https://github.com/akhenakh/mocs">mocs</a> can render the map without Internet access, it will also map match the positions in the future.</p>

<h2 id="experimenting-with-another-touch-screen">Experimenting with another touch screen</h2>

<p>I&rsquo;m using a less performant but smaller <a href="https://www.amazon.ca/gp/product/B01I9DS2G8">LANDZO 5 Inch Touch Display</a> 800x480<br />
This touchscreen is handled as a one button mouse.</p>

<p>It can be calibrate using <a href="https://github.com/kergoth/tslib/">tslib</a> <code>ts_calibrate</code> command.</p>

<p>Then in your start env tell Qt to use tslib.</p>

<pre><code>TSLIB_TSDEVICE=/dev/input/event0
QT_QPA_GENERIC_PLUGINS=tslib:/dev/input/event0
QT_QPA_FB_TSLIB=1
</code></pre>

<h2 id="gps">GPS</h2>

<p>Like I said in <a href="https://blog.nobugware.com/post/2018/my_own_car_system_raspberry_pi_offline_mapping/">part I</a>, the Linux gps daemons are using obscure and over complicated protocols so <a href="https://xkcd.com/927/">I&rsquo;ve decided</a> to write my own gps daemon in Go using a gRPC stream interface. You can <a href="https://github.com/akhenakh/gpsd">find it here</a>.</p>

<p>I&rsquo;m also not satisfied with the map matching of OSRM for real time display, I may rewrite one using <a href="https://github.com/akhenakh/mbmatch">mbmatch</a>.</p>

<h2 id="pois">POIs</h2>

<p>I&rsquo;ve started POIs lookups with full text search and geo proximity using <a href="http://github.com/blevesearch/bleve">bleve</a> by exposing an API compatible with the OSM API so it can be used directly by QML Locations.</p>

<h2 id="night-map">Night Map</h2>

<p>I&rsquo;m a huge fan of the <a href="https://github.com/altercation/solarized">Solarized colors</a>, I&rsquo;ve made a style for the map you can find it <a href="https://github.com/akhenakh/mocs/blob/master/external/solarized-dark.style">here</a></p>

<p><img src="https://blog.nobugware.com/img/mocssolarized.jpg" alt="Solarized" /></p>

<h2 id="speeding-up-boot">Speeding up boot</h2>

<pre><code>systemctl mask systemd-udev-settle.service
systemctl mask lvm2-activation-net.service
systemctl mask lvm2-monitor.service
</code></pre>

<h2 id="status">Status</h2>

<p>The project is far from finished and not ready for everybody but it&rsquo;s fun to play with.</p>

<p>I&rsquo;ve <a href="https://github.com/akhenakh/mocs">open sourced most of the code for Mocs on github</a>, feel free to contribute.</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">10 Jun 2018, 09:19</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.nobugware.com/post/2018/my_own_car_system_raspberry_pi_offline_mapping/" class="post-title">My Own Car System, Rear Camera, Offline Maps &amp; Routing on Raspberry Pi part I</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                <a class="post-category post-category-Geo" href="https://blog.nobugware.com/categories/geo">Geo</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<p>At first I needed a car rear camera, one thing led to another&hellip;</p>

<p>My Car, from 2011, only has an LCD display and no rear camera, so I bought a <a href="https://www.amazon.ca/gp/product/B06ZY949CF">PAL rear camera</a>, we passed some cables from the rear window to the front then everything begun.<br />
Here is my journey to transform my car into a modern system running on RPi3 (a never ending project).</p>

<h2 id="hardware">Hardware</h2>

<p>I&rsquo;m using an Rpi3 (old model).</p>

<p>With <a href="https://archlinuxarm.org">Arch for ARM</a> but any system will do.</p>

<p>The screen is an <a href="https://www.amazon.ca/gp/product/B019K6CRVY/ref=oh_aui_search_detailpage?ie=UTF8&amp;psc=1">Eleduino Raspberry Pi 7 Inch 1024x600 Pixel IPS Hdmi Input Capacitive Touch Screen Display</a><br />
An <a href="https://www.ebay.ca/itm/USB-2-0-Easycap-Video-With-Audio-VHS-DC60-to-DVD-Converter-Capture-Card-Adapter-/142504839503?hash=item212df3494f&amp;_uhb=1">USB 2.0 EasyCap</a> to retrieve the composite signal.</p>

<p>No driver needed for both the screen and the video capture dongle.</p>

<pre><code>mplayer tv:// -tv driver=v4l2:device=/dev/video0:fps=25:outfmt=yuy2:norm=PAL
</code></pre>

<p><img src="https://blog.nobugware.com/img/rearcam.jpg" alt="Camera" /><br />
mplayer is working out of the box, so I thought everything was okay with the camera, so I thought.</p>

<p>I needed a GUI to display the camera and the date (at this this time this project was just a rear camera display).<br />
So I choose <a href="https://github.com/therecipe/qt">Qt &amp; Golang</a>, not the normal contenders but I can&rsquo;t handle C++ and had experiences with QtGo, and modern Qt apps are just QML code anyway&hellip; So I thought&hellip;</p>

<p>I&rsquo;ve started to code a small QML app but when displaying the video I got:</p>

<pre><code>ERROR: from element /GstPipeline:pipeline0/GstV4l2Src:v4l2src0: Device '/dev/video0' does not support progressive interlacing
Additional debug info:
gstv4l2object.c(3768): gst_v4l2_object_set_format_full (): /GstPipeline:pipeline0/GstV4l2Src:v4l2src0:
Device wants interleaved interlacing
</code></pre>

<p>Qt via Gstreamer does not allow non interlaced videos :(<br />
One solution is to force a pipeline with an interlacer.</p>

<p>Easy on the command line
<code>gst-launch-1.0 v4l2src  ! interlace ! xvimagesink</code></p>

<p>Not that easy via Qt I had to patch the Qt Gstreamer plugin <code>camerabinsession.cpp</code> to insert a filter on the preview:
at the end of <code>GstElement *CameraBinSession::buildCameraSource()</code></p>

<pre><code class="language-c++">    const QByteArray envInterlace = qgetenv(&quot;QT_GSTREAMER_CAMERABIN_VIDEO_INTERLACE&quot;);
    if (envInterlace.length() &gt; 0) {
        GstElement *interlace = gst_element_factory_make (&quot;interlace&quot;, NULL);
        if (interlace == NULL)
            g_error (&quot;Could not create 'interlace' element&quot;);


        g_object_set(G_OBJECT(m_camerabin), &quot;viewfinder-filter&quot;, interlace, NULL);

        #if CAMERABIN_DEBUG
            qDebug() &lt;&lt; &quot;set camera filter&quot; &lt;&lt; interlace;
        #endif
        gst_object_unref (interlace);
    }
</code></pre>

<h2 id="gps">GPS</h2>

<p>I had a serial GPS around, why not display a moving map?</p>

<p>Enable serial port in <code>/boot/config.txt</code> (note Bluetooth must be disabled &hellip;)</p>

<pre><code>enable_uart=1
dtoverlay=pi3-disable-bt
</code></pre>

<p>pin 8  TXD<br />
pin 10 RXD</p>

<p>remove <code>console=ttyAMA0,115200</code> and <code>kgdboc=ttyAMA0,115200</code> from <code>/boot/cmdline.txt</code></p>

<p>I thought it would be very easy to read NMEA via serial.<br />
It was, gpsd worked in seconds but &hellip; it seems we can&rsquo;t disable the auto speed, equal 4s lost at start.<br />
Plus Qt is using libgeoclue or Gypsy which <a href="https://gypsy.freedesktop.org/why-not-gpsd.html">does not want to talk with gpsd</a>.<br />
I tried both of them, they didn&rsquo;t work, it&rsquo;s a mess to debug, documentation is just the API&hellip;</p>

<p>So one thing led to another&hellip; I&rsquo;ve written a very small and simple gpsd in Go with a gRPC interface, so it can be queried from anything.<br />
It&rsquo;s also a bit more advanced since it can map match &amp; route match the positions with OSRM.</p>

<h2 id="offline-maps">Offline maps</h2>

<p><a href="https://openmaptiles.org">OpenMapTiles project is great</a> to generate vectors data in MBTILES format, you can serve them with <a href="https://github.com/akhenakh/mbmatch">mbmatch</a>.<br />
Qt Map QML can display them using the <code>mapboxgl</code> driver, some <a href="https://openmaptiles.org/styles/">free styles</a> are provided.</p>

<p>Here is an example QML Map plugin.</p>

<pre><code class="language-QML">    Plugin {
        id: mapPlugin
        name: &quot;mapboxgl&quot;
        PluginParameter{
            name: &quot;mapboxgl.mapping.additional_style_urls&quot;
            value: &quot;http://localhost:4000/osm-liberty-gl.style&quot;
        }
    }
</code></pre>

<p>Note on X11 and EGL:<br />
Using the mapboxgl renderer under X11 on the Rpi3 is taking a lot of ressources.<br />
Qt5 is <a href="https://doc.qt.io/qt-5/embedded-linux.html">capable of directly talking to the GPU without X11</a>, the performance difference is night and day.</p>

<p>So just run your Qt app without X11 with the following env vars.</p>

<pre><code>QT_QPA_PLATFORM=eglfs:/dev/fb0
QT_QPA_EGLFS_HIDECURSOR=yes
</code></pre>

<h2 id="offline-routing">Offline Routing</h2>

<p>Hopefully the provided Qt <code>osm</code> plugins knows how to route using the <a href="https://github.com/Project-OSRM/osrm-backend/blob/master/docs/http.md">OSRM API</a>.<br />
So you can run a local <a href="https://github.com/Project-OSRM/osrm-backend">OSRM backend</a> for routing and it will just work.</p>

<p>Generate the route indexes.</p>

<pre><code>osrm-extract -p /usr/share/osrm/profiles/car.lua quebec-latest.osm.pbf 
osrm-contract quebec-latest.osrm
osrm-routed quebec-latest.osrm
</code></pre>

<pre><code class="language-QML">    Plugin {
        id: routePlugin
        name: &quot;osm&quot;
        PluginParameter{
            name: &quot;osm.routing.host&quot;
            value: &quot;http://localhost:5000/route/v1/driving/&quot;
        }
    }
</code></pre>

<p><img src="https://blog.nobugware.com/img/mocs.jpg" alt="Mocs" /></p>

<p>The app can display the rear camera and a moving map !!</p>

<p><a href="https://blog.nobugware.com/post/2018/my_own_car_system_raspberry_pi_offline_mapping_map_matching_places_part2/">Part 2</a>  will be about searching places by extracting OSM data and indexing them in a small Go program that can run on the rpi, reading ODB data from the car via Bluetooth, packaging the whole thing and open sourcing some code.</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">08 Oct 2017, 14:28</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.nobugware.com/post/2017/hacking_temperature_radio_sensors_and_graphing_with_prometheus/" class="post-title">Hacking Temperature Radio Sensors and Graphing with Prometheus</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                
                            
                        </p>
                    </header>

                    <div class="post-description">
                        

<p>One year ago I&rsquo;ve started to collect temperature from my house using Acurite sensors.</p>

<p><img src="https://blog.nobugware.com/img/acurite0.jpg" alt="Acurite outddor" /> <img src="https://blog.nobugware.com/img/acurite1.jpg" alt="Acurite indoor" /></p>

<p>These sensors are not too expensive and good quality but the &ldquo;base&rdquo; aka the radio receiver connected to internet is costly and totally closed, it&rsquo;s sending your data to the Cloud™, it&rsquo;s not just Acurite, all those &ldquo;IOT&rdquo; devices are generally poor on the software side.</p>

<h2 id="receiving-radio-data">Receiving radio data</h2>

<p>Most of these sensors have their protocols already reverse engineered you only need the radio receiver part.</p>

<p><a href="https://www.rtl-sdr.com/rtl-sdr-quick-start-guide/">RTL-SDR</a> dongles to the rescue and a <a href="https://www.rtl-sdr.com/using-rtl-sdr-rtl_433-decode-various-devices/">great community</a> around it.</p>

<p><a href="http://github.com/prune998">Prune998</a> and I have added some <a href="https://github.com/merbanan/rtl_433/commit/66a3752fbc3949ac19cf9eed36d725741947b6b8">JSON support to the acurite driver</a> and sent it to the projet.</p>

<h2 id="collecting-and-graphing-the-data">Collecting and graphing the data</h2>

<p>The last needed piece was something to collect the data and send to prometheus:</p>

<p>So I wrote a quick Go program to do exactly that <a href="https://github.com/akhenakh/acurite_to_graph">Acurite to graph</a></p>

<p>Et voila, we can graph all sensors in our home.</p>

<p><img src="https://blog.nobugware.com/img/graphacurite.jpg" alt="graph" /></p>

<p>It has been tested on OSX &amp; Linux.</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">20 Sep 2016, 17:40</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.nobugware.com/post/2016/grpc_envoy_nghttp2_load_balancing/" class="post-title">gRPC Envoy Nghttp2 and Load Balancing</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                <a class="post-category post-category-Golang" href="https://blog.nobugware.com/categories/golang">Golang</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p>I&rsquo;ve been using <a href="http://www.grpc.io/">gRPC</a> at work and in several personal projects for months and happy with it, but when it comes to load balancing gRPC does not come with batteries included.</p>

<p>For a long time the only document was the <a href="https://github.com/grpc/grpc/commit/b31ec1e81c93d4c9bf30a4600096a6a6f5b90935">Load Balancing draft in the gRPC repo</a>, the clients should implement a Picker interface to know about the servers, so the pooling and controling the load were handled by the clients.<br />
HTTP/2 was new and most of the reverse proxies implementations were not capable of load balancing gRPC HTTP2 frames, the only solution was to use a TCP load balancer, generating errors, improper  and weird behaviours for the clients.</p>

<p>At least two projects are now supporting gRPC load balancing easily.</p>

<ul>
<li>The recently announced <a href="https://lyft.github.io/envoy/">Envoy</a> from Lyft</li>
<li>And nghttpx from <a href="https://www.nghttp2.org/">nghttp2</a></li>
</ul>

<p>Here are some notes to simply load balance two <a href="https://github.com/grpc/grpc-go/tree/master/examples/helloworld">gRPC Helloworld server!</a> running on ports 50050 &amp; 50051.</p>

<ul>
<li><p>For nghttp2, a simple configuration file will do</p>

<pre><code>frontend=*,8000;no-tls
backend=localhost,50050;;no-tls;proto=h2;fall=2;rise=2
backend=localhost,50051;;no-tls;proto=h2;fall=2;rise=2
workers=8
</code></pre></li>

<li><p>For envoy, here is the cluster part</p>

<pre><code class="language-js">&quot;clusters&quot;: [
  {
    &quot;name&quot;: &quot;local_service&quot;,
    &quot;connect_timeout_ms&quot;: 250,
    &quot;type&quot;: &quot;static&quot;,
    &quot;lb_type&quot;: &quot;least_request&quot;,
    &quot;features&quot;: &quot;http2&quot;,
    &quot;hosts&quot;: [
      {
        &quot;url&quot;: &quot;tcp://127.0.0.1:50050&quot;
      },
      {
        &quot;url&quot;: &quot;tcp://127.0.0.1:50051&quot;
      }
    ]
  }
]
</code></pre></li>
</ul>

<p>You can then tweak the greeter_client to loop for requests, so you can simulate a client doing multiple requests while killing/restarting your servers.</p>

<pre><code class="language-go">for {  
    r, err := c.SayHello(context.Background(), &amp;pb.HelloRequest{Name: name}) 
    if err != nil { 
        log.Printf(&quot;could not greet: %v&quot;, err)
    }
    log.Printf(&quot;Greeting: %s&quot;, r.Message)
}
</code></pre>

<p>And modify the greeter_server to show on which port/server you get your response:</p>

<pre><code class="language-go">// SayHello implements helloworld.GreeterServer
func (s *server) SayHello(ctx context.Context, in *pb.HelloRequest) (*pb.HelloReply, error) {
    return &amp;pb.HelloReply{Message: &quot;Hello &quot; + in.Name + port}, nil 
}
</code></pre>

<p>Those tests aren&rsquo;t enabling any TLS so use <code>grpc.WithInsecure()</code>.</p>

<p>Note that Envoy is also capable of <a href="https://lyft.github.io/envoy/docs/configuration/http_filters/grpc_http1_bridge_filter.html">bridging your HTTP/1.1 queries to gRPC</a>, which is a killer feature (I haven&rsquo;t tested it yet) , you would normally do it by code with <a href="https://github.com/grpc-ecosystem/grpc-gateway">gRPC-gateway</a>.</p>

<p>Envoy is really new and I&rsquo;m still digging into but already proves itself to be a <strong>complete load balancing proxy solution</strong>  with or without gRPC in your stack.</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">24 Apr 2013, 18:51</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="https://blog.nobugware.com/post/2013/04/24/enhance-your-go/" class="post-title">Enhance your Go</a>

                        <p class="post-meta">
                            
                            
                                under 
                                
                                <a class="post-category post-category-Golang" href="https://blog.nobugware.com/categories/golang">Golang</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p>After my <a href="http://blog.nobugware.com/post/2011/08/16
/enhance-your-python">Enhance your Python</a> post, which is my Python bible reference, I wanted the
same for <a href="http://golang.org/">Golang</a>:</p>

<ul>
<li><a href="http://golang.org/doc/effective_go.html">Effective Go</a>, write effective Go</li>
<li><a href="https://gobyexample.com/">Go by examples</a>, simple but useful examples in Go</li>
<li><a href="http://golang.org/ref/mem">The Go memory model</a>, Goroutines lock or not ?</li>
<li><a href="http://openmymind.net/Things-I-Wish-Someone-Had-Told-Me-About-Go/">Things I Wish Someone Had Told Me About Go</a></li>
<li><a href="http://nathany.com/good">Go Object Oriented Design</a></li>
<li><a href="http://golang.org/src/pkg/">The sources for the standard packages</a> are gold mine for best practices</li>
<li><a href="http://tip.golang.org/doc/articles/race_detector.html">Race detector documentation</a>, (&gt;= 1.1)</li>
<li><a href="https://plus.google.com/communities/114112804251407510571">The Go+ community on Google+</a> and <a href="https://groups.google.com/forum/?fromgroups#!forum/golang-nuts">Golang-nuts</a> on Google groups</li>
<li><a href="http://talks.golang.org/2012/concurrency.slide#1">Go concurrency patterns</a> slides by Rob Pike</li>
<li><a href="http://pragprog.com/magazines/2012-06/the-beauty-of-concurrency-in-go">The Beauty of Concurrency in Go</a></li>
<li><a href="http://blog.repustate.com/migrating-code-from-python-to-golang-what-you-need-to-know/#tips">Go differences with Python</a></li>
<li><a href="http://jan.newmarch.name/go/">Networking with Go</a> (Added June 2013)</li>
<li>If you need to read one book read: <a href="http://www.miek.nl/projects/learninggo/">Learning Go</a> (Added 2013 June)</li>
<li><a href="http://talks.golang.org/2013/bestpractices.slide#1">12 Go best practices</a> (Added 2013 August)</li>
<li><a href="http://www.cs.columbia.edu/~aho/cs6998/reports/12-12-11_DeshpandeSponslerWeiss_GO.pdf">Analysis of the Go runtime scheduler</a>, explains the internal of the Go runtime <a href="Added 2013 August">PDF</a></li>
<li><a href="http://jordanorelli.tumblr.com/post/32665860244/how-to-use-interfaces-in-go">How to use interface in Go</a> (Added 2014 February)</li>
</ul>

<p>Last edit: 2014 February</p>

                    </div>
                </section>
                
            </div>
            

            <div class="footer">
    <div class="pure-menu pure-menu-horizontal pure-menu-open">
        <ul>
            <li>Powered by <a class="hugo" href="http://hugo.spf13.com/" target="_blank">hugo</a></li>
        </ul>
    </div>
</div>
<script src="https://blog.nobugware.com/js/all.min.js"></script>
        </div>
    </div>
</div>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-1245966-1', 'auto');
ga('send', 'pageview');

</script>

</body>
</html>
