<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.123.7"><title>H96 Max+ Android box as a Linux server - Fabrice Aneche</title>
<meta name=description content="Experimenting using some cheap Android boxes as mini server, the H96 Max + is a rk3328 with 4Gb RAM and 64G eMMC."><link rel=stylesheet href=https://blog.nobugware.com/css/ui.css><script defer src=https://blog.nobugware.com/js/dark-mode.js></script><link disabled id=dark-mode-theme rel=stylesheet href=https://blog.nobugware.com/css/dark.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Fira+Mono|Lato|Raleway"><link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/ocean.min.css><script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js></script><script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/languages/go.min.js></script><script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/languages/yaml.min.js></script></head><body><header class="container no-print"><div class=u-header><nav class=bar><ul><li><a href=https://blog.nobugware.com/><img class=icon-text src=https://blog.nobugware.com/img/prev.svg></a></li><li><img class=icon-text id=dark-mode-toggle src=https://blog.nobugware.com/img/moon-regular.svg alt="Toggle Dark Mode"></a></li><li><a href=https://blog.nobugware.com/about>About</a></li><li><a href=https://blog.nobugware.com/post/>Post</a></li></ul></nav></div></header><main class=container><article><header><hgroup id=brand><h1>H96 Max+ Android box as a Linux server</h1><h5><time datetime="2019-05-27 04:00:00 +0000 UTC">May 27, 2019</time>
<span class=no-print>-
<a href=https://blog.nobugware.com/tags/rk3328>rk3328</a>
<a href=https://blog.nobugware.com/tags/linux>linux</a>
<a href=https://blog.nobugware.com/tags/rockchip>rockchip</a>
<span></h5></hgroup><hr class=sep></header><p>The H96 Max + is an Android 8.1 box with a Rockchip 3328, 4Gb RAM and 32G or 64G builtin eMMC, it&rsquo;s the same chipset as the <a href=https://blog.nobugware.com/post/2019/arch-on-rock64-with-usb-boot/>Rock64</a>, it costs around 60 USD.<br>The only downside of this board is the 100Mb network link, can be a non issue using a USB network adapter.</p><p><img src=https://blog.nobugware.com/img/h96maxp.jpg alt></p><p>July 2020 EDIT: Works with mainline, look at the bottom.</p><p>Here are some notes how to install Arch Linux on the H96 to make it a small server appliance.</p><h2 id=serial-console-pins>Serial Console Pins</h2><p>Video output won&rsquo;t work while installing you need to establish a serial connection to the board.</p><p><img src=https://blog.nobugware.com/img/h96pins.jpg alt></p><p>Baudrate 1500000 8N1 3.3V</p><h2 id=dtb>DTB</h2><p>DTS/DTB are <a href=https://community.arm.com/developer/tools-software/oss-platforms/w/docs/268/device-tree>Device Tree Blob</a> describing the hardware to the kernel.</p><p>You can extract the DTB from the Android H96 image but I&rsquo;m using <code>rk3328-t9.dtb</code> from <a href="https://forum.armbian.com/topic/8082-armbian-for-tv-box-rk3328/page/15/?tab=comments#comment-79541">armbian forum</a></p><h2 id=unbrick>Unbrick</h2><p>If you write to <code>mmcblk2</code> you may override the rockchip firmware located on the eMMC, which will result in a non booting device &mldr;</p><p>Since this box does not have any reset button you need to short two pins as described in this <a href=https://forum.freaktab.com/forum/tv-player-support/rockchip-based-tv-players/rk3328-devices/751175-h96-max-4-64gb-rk3328-android-8-1-tv-box-pin-unbrick-bricked>post</a>.</p><p>You also need a male male USB connector (it&rsquo;s a straight cable, black, green, white and red on both ends).</p><p>Shorts the two pins while inserting the USB cable, do not plug the power cable.</p><p>Find an image for the H96 somewhere or dump yours, it&rsquo;s only useful to recover the boot image, then write it to the eMMC with <a href=https://github.com/rockchip-linux/tools>upgrade_tool</a></p><pre><code>sudo ./upgrade_tool uf RK3328-H96MAX+_hs2734_8.1.0_20180823.1108.img
</code></pre><h2 id=installation>Installation</h2><p>Prepare an SD card as described in the <a href=https://archlinuxarm.org/platforms/armv8/rockchip/rock64>Rock64 Arch installation</a>.</p><p>Note the output of <code>blkid</code> for this partition.</p><p>Before unmounting root, create a new file <code>root/boot/boot.txt</code>.</p><pre><code>part uuid ${devtype} ${devnum}:${bootpart} uuid
setenv bootargs console=ttyS2,1500000 root=UUID=a3490212-03b6-46a6-9e6b-7733513a3efa storagemedia=emmc rw rootwait earlycon=uart8250,mmio32,0xff130000
setenv fdtfile rockchip/rk3328-t9.dtb

if load ${devtype} ${devnum}:${bootpart} ${kernel_addr_r} /boot/Image; then
if load ${devtype} ${devnum}:${bootpart} ${fdt_addr_r} /boot/dtbs/${fdtfile}; then
              fdt addr ${fdt_addr_r}
              fdt resize
              if load ${devtype} ${devnum}:${bootpart} ${ramdisk_addr_r} /boot/initramfs-linux.img; then
                booti ${kernel_addr_r} ${ramdisk_addr_r}:${filesize} ${fdt_addr_r};
              else
                booti ${kernel_addr_r} - ${fdt_addr_r};
    	fi;
	fi;
fi
</code></pre><p>Copy the dtb file:</p><pre><code>cp rk3328-t9.dtb root/boot/dtbs/rockchip
</code></pre><p>Update the bootloader:</p><pre><code>cd root/boot
mkimage -A arm -O linux -T script -C none -n &quot;U-Boot boot script&quot; -d boot.txt boot.scr
</code></pre><p><code>mkimage</code> is provided by <code>uboot-tools</code> on Arch.</p><p>Mainline kernel won&rsquo;t work properly for now here is a copy <a href="https://drive.google.com/file/d/1dq-Ap_Fq4okR9tkDGN66QeN2b0zjmLCU/view?usp=sharing">ayufan kernel 1187</a> untar in root/boot</p><p>This is a one time thing only&mldr;</p><h3 id=first-boot>First boot</h3><p>Boot with the SD, you should be able to see <code>/dev/mmblck2</code>. It should be safe to write after the block 32768, create a partition, (it&rsquo;s here I&rsquo;ve bricked then unbricked mine).</p><pre><code>Device         Boot Start       End   Sectors  Size Id Type
/dev/mmcblk2p1      32768 122142719 122109952 58.2G 83 Linux
</code></pre><p>You can safely perform a normal Arch install on it, then remember to modify the UUID in <code>boot.txt</code> from the SD Card to boot / from the newly created <code>/dev/mmblck2p1</code> partition, (the SD card is /dev/mmblck0).</p><p>Reboot, the SD card is only needed to find the kernel, the rest is read off the eMMC.</p><h3 id=kernel-updates>Kernel Updates</h3><p>Until mainline is stable for the rk3328, you can use my updated <a href=https://gist.github.com/akhenakh/60a4b859d294b585975bc1d8efae9b62#file-pkgbuild>Arch rockchip ayufan pkg</a>.</p><pre><code>mount /dev/mmblck0 /mnt
mount --bind /mnt/boot /boot
cd linux-aarch64-rock64-bin
makepkg -si
</code></pre><h2 id=stability>Stability</h2><p>I had tons of issues but it seems it was related to USB 3.0.</p><p>I&rsquo;ve blacklisted video output since it&rsquo;s not used , create <code>/etc/modprobe.d/video-blacklist.conf</code></p><pre><code>blacklist mali 
blacklist dw_hdmi_i2s_audio
</code></pre><p>Do not use USB 3 port and you should be fine, (until mainline is stable).</p><h2 id=3d-printed-rack>3D Printed rack</h2><p>Since this board is not standard, I&rsquo;ve made a <a href=https://cad.onshape.com/documents/91ef013acb34326b25db60e8/w/cd6f81aa178f365197c89a2e/e/92c8a87d4865815b6fd95caf>3D printed rack</a> for the H96 and with a support for Rpis/Odroid and Rock64.</p><p><img src=https://blog.nobugware.com/img/h96rack.jpg alt></p><h2 id=conclusions>Conclusions</h2><p>It should be possible to boot directly from the eMMC without the SD Card.</p><p>This board is incredibly fast and convenient for the price, it&rsquo;s a perfect target to play with edge clusters.<br>It&rsquo;s a bit hacky and I don&rsquo;t recommend it if you are not ready to debug from a serial console.</p><p>July 2020 EDIT:</p><h2 id=mainline-kernel>Mainline kernel</h2><p>As of July 2020 it&rsquo;s possible to boot using the mainline kernel:</p><p>Boot on a recent <a href=https://archlinuxarm.org/platforms/armv8/rockchip/rock64>Arch ARM for rock64</a> from SD card or USB, use <code>rk3328-box-h96mp.dtb</code> found on Armbian forum, with the mkimage described early in this post.</p><pre tabindex=0><code>6c19d9dd3fede7708272c5c070082416  /boot/dtbs/rockchip/rk3328-box-h96mp.dtb
</code></pre><p>Then partition the EMMC, using a FAT primary and extlinux, it will boot using the instruction from the extlinux.conf.</p><pre tabindex=0><code>/dev/mmcblk1p1 *      2048    264191    262144  128M  b W95 FAT32
/dev/mmcblk1p2      264192 122142719 121878528 58.1G 83 Linux

mkfs.msdos -F 32 /dev/mmcblk1p1
mkfs.ext4 /dev/mmcblk1p2
e2label  /dev/mmcblk1p2 root_emmc

mkdir root
mount /dev/mmcblk1p2 root

blkid
/dev/mmcblk1p1: UUID=&#34;71FE-481E&#34; BLOCK_SIZE=&#34;512&#34; TYPE=&#34;vfat&#34; PARTUUID=&#34;832a8558-01&#34;
/dev/mmcblk1p2: LABEL=&#34;root_emmc&#34; UUID=&#34;d73d44a4-a415-4fa4-8ffd-73612051ff8e&#34; BLOCK_SIZE=&#34;4096&#34; TYPE=&#34;ext4&#34; PARTUUID=&#34;832a8558-02&#34;

bsdtar -xpf ArchLinuxARM-aarch64-latest.tar.gz -C root

mkdir boot
mount /dev/mmcblk1p1 boot
cp root/boot/Image boot
cp root/boot/initramfs-linux.img boot/initramfs
mkdir -p boot/dtb/rockchip
cp rk3328-box-h96mp.dtb boot/dtb/rockchip/rk3328-h96.dtb

mkdir boot/extlinux
</code></pre><p>Create <code>boot/extlinux/extlinux.conf</code> as follow.</p><pre tabindex=0><code>LABEL Arch
  LINUX /Image
  INITRD /initramfs
  FDT /dtb/rockchip/rk3328-h96.dtb
  APPEND root=LABEL=root_emmc rootwait rw console=ttyS2,1500000 earlycon=uart8250,mmio32,0xff130000
</code></pre><p>Next reboot.</p><pre tabindex=0><code>reboot

# interrupt boot by hitting keyboard
setenv devnum 0; run mmc_boot


pacman-key --init
pacman-key --populate archlinuxarm
pacman -Suy

# in case of kernel update
mkdir /bootfat
mount /dev/mmcblk1p1 /bootfat 
cp /boot/Image /bootfat/Image
cp /boot/initramfs-linux.img /bootfat/initramfs
</code></pre><p>I have 3 of them running in clustered mode for several days, without any problem.</p><pre tabindex=0><code>Linux rk0 5.7.8-1-ARCH #1 SMP Sun Jul 12 03:38:28 UTC 2020 aarch64 GNU/Linux
</code></pre></article><nav class="no-print post-nav"><a class=prev-post href=https://blog.nobugware.com/post/2019/arch-on-rock64-with-usb-boot/><img class=icon-text src=https://blog.nobugware.com/img/prev.svg>Arch on Rock64 with USB boot</a>
<a class=next-post href=https://blog.nobugware.com/post/2019/k3s-on-arm64/>k3s on arm64<img class=icon-text src=https://blog.nobugware.com/img/next.svg></a></nav><section id=related><h4>See Also</h4><ul><li><a href=https://blog.nobugware.com/post/2019/arch-on-rock64-with-usb-boot/>Arch on Rock64 with USB boot</a></li><li><a href=https://blog.nobugware.com/post/2017/back_from_osx_to_linux/>From OSX to Linux</a></li><li><a href=https://blog.nobugware.com/post/2014/12/13/airspy-on-linux/>Airspy on Linux</a></li></ul></section><hr class=sep></main><footer class="container no-print"><div class=u-footer><a href=https://github.com/akhenakh/><img class=icon-social src=https://blog.nobugware.com/img/github.svg alt=Github></a>
<a href=https://c.im/@akhenakh><img class=icon-social src=https://blog.nobugware.com/img/mastodon.svg alt=Mastodon></a>
<a href=https://twitter.com/akhenakh><img class=icon-social src=https://blog.nobugware.com/img/twitter.svg alt=Twitter></a><p>Theme used: <a href=https://github.com/yursan9/manis-hugo-theme>Manis</a><br></p><a href=#brand><img class=icon-text src=https://blog.nobugware.com/img/toup.svg alt="To Up">
<span>Back to Up</span></a></div></footer><script>hljs.initHighlightingOnLoad()</script></body></html>