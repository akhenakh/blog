<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.123.7"><title>Using Go mobile on iOS for real - Fabrice Aneche</title>
<meta name=description content="Go Mobile can generate native framework for iOS and Android using Go code, I was curious what could be achieved with it.
Most tutorials are Hello world and I wanted to test it with real code.
You can use it to generate a full app only using Go code, but I&rsquo;m only interested by the bindings part (SDK applications), using a native ObjC/Swift app calling Go code.
I&rsquo;m using some existing Go code regionagogo, (a geofence database), moderately complex since it uses BoltDB and Google S2 library."><link rel=stylesheet href=https://blog.nobugware.com/css/ui.css><script defer src=https://blog.nobugware.com/js/dark-mode.js></script><link disabled id=dark-mode-theme rel=stylesheet href=https://blog.nobugware.com/css/dark.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Fira+Mono|Lato|Raleway"><link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/ocean.min.css><script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js></script><script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/languages/go.min.js></script><script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/languages/yaml.min.js></script></head><body><header class="container no-print"><div class=u-header><nav class=bar><ul><li><a href=https://blog.nobugware.com/><img class=icon-text src=https://blog.nobugware.com/img/prev.svg></a></li><li><img class=icon-text id=dark-mode-toggle src=https://blog.nobugware.com/img/moon-regular.svg alt="Toggle Dark Mode"></a></li><li><a href=https://blog.nobugware.com/about>About</a></li><li><a href=https://blog.nobugware.com/post/>Post</a></li></ul></nav></div></header><main class=container><article><header><hgroup id=brand><h1>Using Go mobile on iOS for real</h1><h5><time datetime="2016-09-22 15:39:32 -0400 -0400">Sep 22, 2016</time>
<span class=no-print>-
<a href=https://blog.nobugware.com/tags/Geo>Geo</a>
<a href=https://blog.nobugware.com/tags/Golang>Golang</a>
<a href=https://blog.nobugware.com/tags/S2>S2</a>
<span></h5></hgroup><hr class=sep></header><p><a href=https://github.com/golang/go/wiki/Mobile>Go Mobile</a> can generate native framework for iOS and Android using Go code, I was curious what could be achieved with it.<br>Most tutorials are Hello world and I wanted to test it with real code.<br>You can use it to generate a full app only using Go code, but I&rsquo;m only interested by the bindings part (SDK applications), using a native ObjC/Swift app calling Go code.</p><p>I&rsquo;m using some existing Go code <a href=https://github.com/akhenakh/regionagogo>regionagogo</a>, (a geofence database), moderately complex since it uses <a href=https://github.com/boltdb/bolt>BoltDB</a> and <a href=https://github.com/golang/geo>Google S2 library</a>.</p><p><a href=https://github.com/golang/go/wiki/Mobile>Go Mobile</a> is limited <a href=https://godoc.org/golang.org/x/mobile/cmd/gobind#hdr-Type_restrictions>to a subset of types</a> you can use, main reason is to be correctly transcribed to Java and ObjC.</p><p>So the first thing to do is to write some Go wrapper like you would do in ObjC to call some C++ code but first:</p><p>Functions must return either no results, one result, or two results where the type of the second is the built-in <code>error</code> type.<br>So far no major complication, but also note that you <strong>can&rsquo;t return slices</strong>, that could be a major pain, there are some workaround solutions like <a href=https://github.com/scisci/go-mobile-collection>go-mobile-collection</a> that can generate an API to operate on slice.<br>You also have to respect some naming for your constructor like <code>New...()</code>.</p><p>At the end your wrapper won&rsquo;t look very Goish but it&rsquo;s what it takes for it to be translated.</p><p>Knowing those constraints you can write a simple wrapper like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>mobile</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>GeoDB</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>db</span> <span style=color:#a6e22e>regionagogo</span>.<span style=color:#a6e22e>GeoFenceDB</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewGeoDB</span>() <span style=color:#f92672>*</span><span style=color:#a6e22e>GeoDB</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>g</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>GeoDB</span>{}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>g</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>g</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>GeoDB</span>) <span style=color:#a6e22e>OpenDB</span>(<span style=color:#a6e22e>path</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>db</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rbolt</span>.<span style=color:#a6e22e>NewGeoFenceBoltDB</span>(<span style=color:#a6e22e>path</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>db</span> = <span style=color:#a6e22e>db</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span></code></pre></div><p>Then use the gomobile command:</p><pre tabindex=0><code>gomobile bind -target=ios github.com/akhenakh/regionagogo/mobile
</code></pre><p>It generates a native iOS Mobile.Framework, drop it into your XCode project and start using it.</p><ul><li><code>GeoDB</code> translates to <code>GoMobileNewGeoDB()</code> and returns a <code>GoMobileGeoDB*</code> in ObjC domain.</li><li><code>OpenDB(path string) error</code> to <code>- (BOOL)openDB:(NSString*)path error:(NSError**)error</code>.</li></ul><p>A simple example would be:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span>GoMobileGeoDB <span style=color:#f92672>*</span>db <span style=color:#f92672>=</span> <span style=color:#a6e22e>GoMobileNewGeoDB</span>();
</span></span><span style=display:flex><span>NSString <span style=color:#f92672>*</span>resourcePath <span style=color:#f92672>=</span> [[NSBundle mainBundle] pathForResource:<span style=color:#960050;background-color:#1e0010>@</span><span style=color:#e6db74>&#34;region&#34;</span> ofType:<span style=color:#960050;background-color:#1e0010>@</span><span style=color:#e6db74>&#34;db&#34;</span>];
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>NSError <span style=color:#f92672>*</span>error;
</span></span><span style=display:flex><span>[db openDB:resourcePath error:<span style=color:#f92672>&amp;</span>error];
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (error <span style=color:#f92672>!=</span> nil) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>NSLog</span>(<span style=color:#960050;background-color:#1e0010>@</span><span style=color:#e6db74>&#34;error opening db %@&#34;</span>, [error localizedDescription]);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>It&rsquo;s performing very well, on my iPhone 6, around 4,000 queries per second to test a position in a small fence, to 60,000 queries in a hit miss (calling Go overhead is not that big), while using a ridiculously small amount of memory.</p><p>I&rsquo;ve made a demo iOS app where you can hit the map and it tells you in which fence you are.</p><p><img src=https://blog.nobugware.com/img/shotmap.jpg alt=app title="geofence app"><br>Remember this is running locally on your phone without any network access (but the map), the geo computation and the Polygons are returned by Go code.</p><p>Until now I had to maintain libraries in both languages, Go mobile is a nice alternative!</p><p>Sources for the wrapper are available in <a href=https://github.com/akhenakh/regionagogo/tree/gomobile/mobile>regionagogo gomobile branch</a>, and here is the <a href=https://github.com/akhenakh/testgomobileios>iOS demo app</a>.</p></article><nav class="no-print post-nav"><a class=prev-post href=https://blog.nobugware.com/post/2016/grpc_envoy_nghttp2_load_balancing/><img class=icon-text src=https://blog.nobugware.com/img/prev.svg>gRPC Envoy Nghttp2 and Load Balancing</a>
<a class=next-post href=https://blog.nobugware.com/post/2016/grpc_context_go_1.7/>gRPC wrong types context and Go 1.7<img class=icon-text src=https://blog.nobugware.com/img/next.svg></a></nav><section id=related><h4>See Also</h4><ul><li><a href=https://blog.nobugware.com/post/2016/geo_db_s2_geohash_database/>A fast geo database with Google S2 take #2</a></li><li><a href=https://blog.nobugware.com/post/2016/freebsd_raspberry_pi2/>Freebsd on Raspberry Pi 2 and Golang</a></li></ul></section><hr class=sep></main><footer class="container no-print"><div class=u-footer><a href=https://github.com/akhenakh/><img class=icon-social src=https://blog.nobugware.com/img/github.svg alt=Github></a>
<a href=https://c.im/@akhenakh><img class=icon-social src=https://blog.nobugware.com/img/mastodon.svg alt=Mastodon></a>
<a href=https://twitter.com/akhenakh><img class=icon-social src=https://blog.nobugware.com/img/twitter.svg alt=Twitter></a><p>Theme used: <a href=https://github.com/yursan9/manis-hugo-theme>Manis</a><br></p><a href=#brand><img class=icon-text src=https://blog.nobugware.com/img/toup.svg alt="To Up">
<span>Back to Up</span></a></div></footer><script>hljs.initHighlightingOnLoad()</script></body></html>